<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Coverage for teiphy/collation.py: 99.92%</title>
    <link rel="icon" sizes="32x32" href="favicon_32.png">
    <link rel="stylesheet" href="style.css" type="text/css">
    <script type="text/javascript" src="coverage_html.js" defer></script>
</head>
<body class="pyfile">
<header>
    <div class="content">
        <h1>
            <span class="text">Coverage for </span><b>teiphy/collation.py</b>:
            <span class="pc_cov">99.92%</span>
        </h1>
        <aside id="help_panel_wrapper">
            <input id="help_panel_state" type="checkbox">
            <label for="help_panel_state">
                <img id="keyboard_icon" src="keybd_closed.png" alt="Show/hide keyboard shortcuts" />
            </label>
            <div id="help_panel">
                <p class="legend">Shortcuts on this page</p>
                <div class="keyhelp">
                    <p>
                        <kbd>r</kbd>
                        <kbd>m</kbd>
                        <kbd>x</kbd>
                        &nbsp; toggle line displays
                    </p>
                    <p>
                        <kbd>j</kbd>
                        <kbd>k</kbd>
                        &nbsp; next/prev highlighted chunk
                    </p>
                    <p>
                        <kbd>0</kbd> &nbsp; (zero) top of page
                    </p>
                    <p>
                        <kbd>1</kbd> &nbsp; (one) first highlighted chunk
                    </p>
                    <p>
                        <kbd>[</kbd>
                        <kbd>]</kbd>
                        &nbsp; prev/next file
                    </p>
                    <p>
                        <kbd>u</kbd> &nbsp; up to the index
                    </p>
                    <p>
                        <kbd>?</kbd> &nbsp; show/hide this help
                    </p>
                </div>
            </div>
        </aside>
        <h2>
            <span class="text">1328 statements &nbsp;</span>
            <button type="button" class="run button_toggle_run" value="run" data-shortcut="r" title="Toggle lines run">1327<span class="text"> run</span></button>
            <button type="button" class="mis show_mis button_toggle_mis" value="mis" data-shortcut="m" title="Toggle lines missing">1<span class="text"> missing</span></button>
            <button type="button" class="exc show_exc button_toggle_exc" value="exc" data-shortcut="x" title="Toggle lines excluded">0<span class="text"> excluded</span></button>
        </h2>
        <p class="text">
            <a id="prevFileLink" class="nav" href="d_0203103e395d7d41___init___py.html">&#xab; prev</a> &nbsp; &nbsp;
            <a id="indexLink" class="nav" href="index.html">&Hat; index</a> &nbsp; &nbsp;
            <a id="nextFileLink" class="nav" href="d_0203103e395d7d41_common_py.html">&#xbb; next</a>
            &nbsp; &nbsp; &nbsp;
            <a class="nav" href="https://coverage.readthedocs.io">coverage.py v6.5.0</a>,
            created at 2025-02-04 15:23 +0000
        </p>
        <aside class="hidden">
            <button type="button" class="button_next_chunk" data-shortcut="j"/>
            <button type="button" class="button_prev_chunk" data-shortcut="k"/>
            <button type="button" class="button_top_of_page" data-shortcut="0"/>
            <button type="button" class="button_first_chunk" data-shortcut="1"/>
            <button type="button" class="button_prev_file" data-shortcut="["/>
            <button type="button" class="button_next_file" data-shortcut="]"/>
            <button type="button" class="button_to_index" data-shortcut="u"/>
            <button type="button" class="button_show_hide_help" data-shortcut="?"/>
        </aside>
    </div>
</header>
<main id="source">
    <p class="pln"><span class="n"><a id="t1" href="#t1">1</a></span><span class="t"><span class="com">#!/usr/bin/env python3</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2" href="#t2">2</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t3" href="#t3">3</a></span><span class="t"><span class="key">from</span> <span class="nam">enum</span> <span class="key">import</span> <span class="nam">Enum</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t4" href="#t4">4</a></span><span class="t"><span class="key">from</span> <span class="nam">typing</span> <span class="key">import</span> <span class="nam">List</span><span class="op">,</span> <span class="nam">Union</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t5" href="#t5">5</a></span><span class="t"><span class="key">from</span> <span class="nam">pathlib</span> <span class="key">import</span> <span class="nam">os</span><span class="op">,</span> <span class="nam">Path</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t6" href="#t6">6</a></span><span class="t"><span class="key">from</span> <span class="nam">datetime</span> <span class="key">import</span> <span class="nam">datetime</span>  <span class="com"># for calculating the current year (for dating and tree height purposes)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t7" href="#t7">7</a></span><span class="t"><span class="key">import</span> <span class="nam">time</span>  <span class="com"># to time calculations for users</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t8" href="#t8">8</a></span><span class="t"><span class="key">import</span> <span class="nam">string</span>  <span class="com"># for easy retrieval of character ranges</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t9" href="#t9">9</a></span><span class="t"><span class="key">from</span> <span class="nam">lxml</span> <span class="key">import</span> <span class="nam">etree</span> <span class="key">as</span> <span class="nam">et</span>  <span class="com"># for reading TEI XML inputs</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t10" href="#t10">10</a></span><span class="t"><span class="key">import</span> <span class="nam">numpy</span> <span class="key">as</span> <span class="nam">np</span>  <span class="com"># for random number sampling and collation matrix outputs</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t11" href="#t11">11</a></span><span class="t"><span class="key">import</span> <span class="nam">pandas</span> <span class="key">as</span> <span class="nam">pd</span>  <span class="com"># for writing to DataFrames, CSV, Excel, etc.</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t12" href="#t12">12</a></span><span class="t"><span class="key">from</span> <span class="nam">slugify</span> <span class="key">import</span> <span class="nam">slugify</span>  <span class="com"># for converting Unicode text from readings to ASCII for NEXUS</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t13" href="#t13">13</a></span><span class="t"><span class="key">from</span> <span class="nam">jinja2</span> <span class="key">import</span> <span class="nam">Environment</span><span class="op">,</span> <span class="nam">PackageLoader</span><span class="op">,</span> <span class="nam">select_autoescape</span>  <span class="com"># for filling output XML templates</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t14" href="#t14">14</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t15" href="#t15">15</a></span><span class="t"><span class="key">from</span> <span class="op">.</span><span class="nam">common</span> <span class="key">import</span> <span class="nam">xml_ns</span><span class="op">,</span> <span class="nam">tei_ns</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t16" href="#t16">16</a></span><span class="t"><span class="key">from</span> <span class="op">.</span><span class="nam">format</span> <span class="key">import</span> <span class="nam">Format</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t17" href="#t17">17</a></span><span class="t"><span class="key">from</span> <span class="op">.</span><span class="nam">witness</span> <span class="key">import</span> <span class="nam">Witness</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t18" href="#t18">18</a></span><span class="t"><span class="key">from</span> <span class="op">.</span><span class="nam">variation_unit</span> <span class="key">import</span> <span class="nam">VariationUnit</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t19" href="#t19">19</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t20" href="#t20">20</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t21" href="#t21">21</a></span><span class="t"><span class="key">class</span> <span class="nam">ParsingException</span><span class="op">(</span><span class="nam">Exception</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t22" href="#t22">22</a></span><span class="t">    <span class="key">pass</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t23" href="#t23">23</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t24" href="#t24">24</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t25" href="#t25">25</a></span><span class="t"><span class="key">class</span> <span class="nam">WitnessDateException</span><span class="op">(</span><span class="nam">Exception</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t26" href="#t26">26</a></span><span class="t">    <span class="key">pass</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t27" href="#t27">27</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t28" href="#t28">28</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t29" href="#t29">29</a></span><span class="t"><span class="key">class</span> <span class="nam">IntrinsicRelationsException</span><span class="op">(</span><span class="nam">Exception</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t30" href="#t30">30</a></span><span class="t">    <span class="key">pass</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t31" href="#t31">31</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t32" href="#t32">32</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t33" href="#t33">33</a></span><span class="t"><span class="key">class</span> <span class="nam">ClockModel</span><span class="op">(</span><span class="nam">str</span><span class="op">,</span> <span class="nam">Enum</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t34" href="#t34">34</a></span><span class="t">    <span class="nam">strict</span> <span class="op">=</span> <span class="str">"strict"</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t35" href="#t35">35</a></span><span class="t">    <span class="nam">uncorrelated</span> <span class="op">=</span> <span class="str">"uncorrelated"</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t36" href="#t36">36</a></span><span class="t">    <span class="nam">local</span> <span class="op">=</span> <span class="str">"local"</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t37" href="#t37">37</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t38" href="#t38">38</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t39" href="#t39">39</a></span><span class="t"><span class="key">class</span> <span class="nam">AncestralLogger</span><span class="op">(</span><span class="nam">str</span><span class="op">,</span> <span class="nam">Enum</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t40" href="#t40">40</a></span><span class="t">    <span class="nam">state</span> <span class="op">=</span> <span class="str">"state"</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t41" href="#t41">41</a></span><span class="t">    <span class="nam">sequence</span> <span class="op">=</span> <span class="str">"sequence"</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t42" href="#t42">42</a></span><span class="t">    <span class="nam">none</span> <span class="op">=</span> <span class="str">"none"</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t43" href="#t43">43</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t44" href="#t44">44</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t45" href="#t45">45</a></span><span class="t"><span class="key">class</span> <span class="nam">TableType</span><span class="op">(</span><span class="nam">str</span><span class="op">,</span> <span class="nam">Enum</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t46" href="#t46">46</a></span><span class="t">    <span class="nam">matrix</span> <span class="op">=</span> <span class="str">"matrix"</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t47" href="#t47">47</a></span><span class="t">    <span class="nam">distance</span> <span class="op">=</span> <span class="str">"distance"</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t48" href="#t48">48</a></span><span class="t">    <span class="nam">similarity</span> <span class="op">=</span> <span class="str">"similarity"</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t49" href="#t49">49</a></span><span class="t">    <span class="nam">nexus</span> <span class="op">=</span> <span class="str">"nexus"</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t50" href="#t50">50</a></span><span class="t">    <span class="nam">long</span> <span class="op">=</span> <span class="str">"long"</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t51" href="#t51">51</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t52" href="#t52">52</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t53" href="#t53">53</a></span><span class="t"><span class="key">class</span> <span class="nam">Collation</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t54" href="#t54">54</a></span><span class="t">    <span class="str">"""Base class for storing TEI XML collation data internally.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t55" href="#t55">55</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t56" href="#t56">56</a></span><span class="t"><span class="str">    This corresponds to the entire XML tree, rooted at the TEI element of the collation.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t57" href="#t57">57</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t58" href="#t58">58</a></span><span class="t"><span class="str">    Attributes:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t59" href="#t59">59</a></span><span class="t"><span class="str">        manuscript_suffixes: A list of suffixes used to distinguish manuscript subwitnesses like first hands, correctors, main texts, alternate texts, and multiple attestations from their base witnesses.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t60" href="#t60">60</a></span><span class="t"><span class="str">        trivial_reading_types: A set of reading types (e.g., "reconstructed", "defective", "orthographic", "subreading") whose readings should be collapsed under the previous substantive reading.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t61" href="#t61">61</a></span><span class="t"><span class="str">        missing_reading_types: A set of reading types (e.g., "lac", "overlap") whose readings should be treated as missing data.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t62" href="#t62">62</a></span><span class="t"><span class="str">        fill_corrector_lacunae: A boolean flag indicating whether or not to fill "lacunae" in witnesses with type "corrector".</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t63" href="#t63">63</a></span><span class="t"><span class="str">        fragmentary_threshold: A float representing the proportion such that all witnesses extant at fewer than this proportion of variation units are filtered out of the collation.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t64" href="#t64">64</a></span><span class="t"><span class="str">        witnesses: A list of Witness instances contained in this Collation.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t65" href="#t65">65</a></span><span class="t"><span class="str">        witness_index_by_id: A dictionary mapping base witness ID strings to their int indices in the witnesses list.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t66" href="#t66">66</a></span><span class="t"><span class="str">        variation_units: A list of VariationUnit instances contained in this Collation.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t67" href="#t67">67</a></span><span class="t"><span class="str">        readings_by_witness: A dictionary mapping base witness ID strings to lists of reading support coefficients for all units (with at least two substantive readings).</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t68" href="#t68">68</a></span><span class="t"><span class="str">        substantive_variation_unit_ids: A list of ID strings for variation units with two or more substantive readings.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t69" href="#t69">69</a></span><span class="t"><span class="str">        substantive_variation_unit_reading_tuples: A list of (variation unit ID, reading ID) tuples for substantive readings.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t70" href="#t70">70</a></span><span class="t"><span class="str">        verbose: A boolean flag indicating whether or not to print timing and debugging details for the user.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t71" href="#t71">71</a></span><span class="t"><span class="str">    """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t72" href="#t72">72</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t73" href="#t73">73</a></span><span class="t">    <span class="key">def</span> <span class="nam">__init__</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t74" href="#t74">74</a></span><span class="t">        <span class="nam">self</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t75" href="#t75">75</a></span><span class="t">        <span class="nam">xml</span><span class="op">:</span> <span class="nam">et</span><span class="op">.</span><span class="nam">ElementTree</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t76" href="#t76">76</a></span><span class="t">        <span class="nam">manuscript_suffixes</span><span class="op">:</span> <span class="nam">List</span><span class="op">[</span><span class="nam">str</span><span class="op">]</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t77" href="#t77">77</a></span><span class="t">        <span class="nam">trivial_reading_types</span><span class="op">:</span> <span class="nam">List</span><span class="op">[</span><span class="nam">str</span><span class="op">]</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t78" href="#t78">78</a></span><span class="t">        <span class="nam">missing_reading_types</span><span class="op">:</span> <span class="nam">List</span><span class="op">[</span><span class="nam">str</span><span class="op">]</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t79" href="#t79">79</a></span><span class="t">        <span class="nam">fill_corrector_lacunae</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t80" href="#t80">80</a></span><span class="t">        <span class="nam">fragmentary_threshold</span><span class="op">:</span> <span class="nam">float</span> <span class="op">=</span> <span class="key">None</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t81" href="#t81">81</a></span><span class="t">        <span class="nam">dates_file</span><span class="op">:</span> <span class="nam">Union</span><span class="op">[</span><span class="nam">Path</span><span class="op">,</span> <span class="nam">str</span><span class="op">]</span> <span class="op">=</span> <span class="key">None</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t82" href="#t82">82</a></span><span class="t">        <span class="nam">verbose</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t83" href="#t83">83</a></span><span class="t">    <span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t84" href="#t84">84</a></span><span class="t">        <span class="str">"""Constructs a new Collation instance with the given settings.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t85" href="#t85">85</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t86" href="#t86">86</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t87" href="#t87">87</a></span><span class="t"><span class="str">            xml: An lxml.etree.ElementTree representing an XML tree rooted at a TEI element.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t88" href="#t88">88</a></span><span class="t"><span class="str">            manuscript_suffixes: An optional list of suffixes used to distinguish manuscript subwitnesses like first hands, correctors, main texts, alternate texts, and multiple attestations from their base witnesses.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t89" href="#t89">89</a></span><span class="t"><span class="str">            trivial_reading_types: An optional set of reading types (e.g., "reconstructed", "defective", "orthographic", "subreading") whose readings should be collapsed under the previous substantive reading.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t90" href="#t90">90</a></span><span class="t"><span class="str">            missing_reading_types: An optional set of reading types (e.g., "lac", "overlap") whose readings should be treated as missing data.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t91" href="#t91">91</a></span><span class="t"><span class="str">            fill_corrector_lacunae: An optional flag indicating whether or not to fill "lacunae" in witnesses with type "corrector".</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t92" href="#t92">92</a></span><span class="t"><span class="str">            fragmentary_threshold: An optional float representing the proportion such that all witnesses extant at fewer than this proportion of variation units are filtered out of the collation.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t93" href="#t93">93</a></span><span class="t"><span class="str">            dates_file: An optional path to a CSV file containing witness IDs, minimum dates, and maximum dates. If specified, then for all witnesses in the first column, any existing date ranges for them in the TEI XML collation will be ignored.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t94" href="#t94">94</a></span><span class="t"><span class="str">            verbose: An optional flag indicating whether or not to print timing and debugging details for the user.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t95" href="#t95">95</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t96" href="#t96">96</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">manuscript_suffixes</span> <span class="op">=</span> <span class="nam">manuscript_suffixes</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t97" href="#t97">97</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">trivial_reading_types</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">trivial_reading_types</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t98" href="#t98">98</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">missing_reading_types</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">missing_reading_types</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t99" href="#t99">99</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">fill_corrector_lacunae</span> <span class="op">=</span> <span class="nam">fill_corrector_lacunae</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t100" href="#t100">100</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">fragmentary_threshold</span> <span class="op">=</span> <span class="nam">fragmentary_threshold</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t101" href="#t101">101</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span> <span class="op">=</span> <span class="nam">verbose</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t102" href="#t102">102</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t103" href="#t103">103</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">witness_index_by_id</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t104" href="#t104">104</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">variation_units</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t105" href="#t105">105</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t106" href="#t106">106</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t107" href="#t107">107</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">substantive_variation_unit_reading_tuples</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t108" href="#t108">108</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t109" href="#t109">109</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">intrinsic_categories</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t110" href="#t110">110</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">intrinsic_odds_by_id</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t111" href="#t111">111</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">transcriptional_categories</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t112" href="#t112">112</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">transcriptional_rates_by_id</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t113" href="#t113">113</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t114" href="#t114">114</a></span><span class="t">        <span class="com"># Now parse the XML tree to populate these data structures:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t115" href="#t115">115</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t116" href="#t116">116</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"Initializing collation..."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t117" href="#t117">117</a></span><span class="t">        <span class="nam">t0</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t118" href="#t118">118</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">parse_origin_date_range</span><span class="op">(</span><span class="nam">xml</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t119" href="#t119">119</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">parse_list_wit</span><span class="op">(</span><span class="nam">xml</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t120" href="#t120">120</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">validate_wits</span><span class="op">(</span><span class="nam">xml</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t121" href="#t121">121</a></span><span class="t">        <span class="com"># If a dates file was specified, then update the witness date ranges manually:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t122" href="#t122">122</a></span><span class="t">        <span class="key">if</span> <span class="nam">dates_file</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t123" href="#t123">123</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">update_witness_date_ranges_from_dates_file</span><span class="op">(</span><span class="nam">dates_file</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t124" href="#t124">124</a></span><span class="t">        <span class="com"># If the upper bound on a work's date of origin is not defined, then attempt to assign it an upper bound based on the witness dates;</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t125" href="#t125">125</a></span><span class="t">        <span class="com"># otherwise, attempt to assign lower bounds to witness dates based on it:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t126" href="#t126">126</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="key">is</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t127" href="#t127">127</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">update_origin_date_range_from_witness_date_ranges</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t128" href="#t128">128</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t129" href="#t129">129</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">update_witness_date_ranges_from_origin_date_range</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t130" href="#t130">130</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">parse_intrinsic_odds</span><span class="op">(</span><span class="nam">xml</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t131" href="#t131">131</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">parse_transcriptional_rates</span><span class="op">(</span><span class="nam">xml</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t132" href="#t132">132</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">parse_apps</span><span class="op">(</span><span class="nam">xml</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t133" href="#t133">133</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">validate_intrinsic_relations</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t134" href="#t134">134</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">parse_readings_by_witness</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t135" href="#t135">135</a></span><span class="t">        <span class="com"># If a threshold of readings for fragmentary witnesses is specified, then filter the witness list using the dictionary mapping witness IDs to readings:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t136" href="#t136">136</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">fragmentary_threshold</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t137" href="#t137">137</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">filter_fragmentary_witnesses</span><span class="op">(</span><span class="nam">xml</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t138" href="#t138">138</a></span><span class="t">        <span class="nam">t1</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t139" href="#t139">139</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t140" href="#t140">140</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"Total time to initialize collation: %0.4fs."</span> <span class="op">%</span> <span class="op">(</span><span class="nam">t1</span> <span class="op">-</span> <span class="nam">t0</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t141" href="#t141">141</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t142" href="#t142">142</a></span><span class="t">    <span class="key">def</span> <span class="nam">parse_origin_date_range</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">xml</span><span class="op">:</span> <span class="nam">et</span><span class="op">.</span><span class="nam">ElementTree</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t143" href="#t143">143</a></span><span class="t">        <span class="str">"""Given an XML tree for a collation, populates this Collation's list of origin date bounds.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t144" href="#t144">144</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t145" href="#t145">145</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t146" href="#t146">146</a></span><span class="t"><span class="str">            xml: An lxml.etree.ElementTree representing an XML tree rooted at a TEI element.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t147" href="#t147">147</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t148" href="#t148">148</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t149" href="#t149">149</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"Parsing origin date range..."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t150" href="#t150">150</a></span><span class="t">        <span class="nam">t0</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t151" href="#t151">151</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span> <span class="op">=</span> <span class="op">[</span><span class="key">None</span><span class="op">,</span> <span class="key">None</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t152" href="#t152">152</a></span><span class="t">        <span class="key">for</span> <span class="nam">date</span> <span class="key">in</span> <span class="nam">xml</span><span class="op">.</span><span class="nam">xpath</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t153" href="#t153">153</a></span><span class="t">            <span class="str">"//tei:sourceDesc//tei:bibl//tei:date|//tei:sourceDesc//tei:biblStruct//tei:date|//tei:sourceDesc//tei:biblFull//tei:date"</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t154" href="#t154">154</a></span><span class="t">            <span class="nam">namespaces</span><span class="op">=</span><span class="op">{</span><span class="str">"tei"</span><span class="op">:</span> <span class="nam">tei_ns</span><span class="op">}</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t155" href="#t155">155</a></span><span class="t">        <span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t156" href="#t156">156</a></span><span class="t">            <span class="com"># Try the @when attribute first; if it is set, then it accounts for both ends of the date range:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t157" href="#t157">157</a></span><span class="t">            <span class="key">if</span> <span class="nam">date</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"when"</span><span class="op">)</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t158" href="#t158">158</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="op">=</span> <span class="nam">int</span><span class="op">(</span><span class="nam">date</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"when"</span><span class="op">)</span><span class="op">.</span><span class="nam">split</span><span class="op">(</span><span class="str">"-"</span><span class="op">)</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t159" href="#t159">159</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t160" href="#t160">160</a></span><span class="t">            <span class="com"># Failing that, if it has @from and @to attributes (indicating the period over which the work was completed),</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t161" href="#t161">161</a></span><span class="t">            <span class="com"># then the completion date of the work accounts for both ends of the date range:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t162" href="#t162">162</a></span><span class="t">            <span class="key">elif</span> <span class="nam">date</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"to"</span><span class="op">)</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t163" href="#t163">163</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="op">=</span> <span class="nam">int</span><span class="op">(</span><span class="nam">date</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"to"</span><span class="op">)</span><span class="op">.</span><span class="nam">split</span><span class="op">(</span><span class="str">"-"</span><span class="op">)</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t164" href="#t164">164</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t165" href="#t165">165</a></span><span class="t">            <span class="com"># Failing that, set lower and upper bounds on the origin date using the the @notBefore and @notAfter attributes:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t166" href="#t166">166</a></span><span class="t">            <span class="key">elif</span> <span class="nam">date</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"notBefore"</span><span class="op">)</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span> <span class="key">or</span> <span class="nam">date</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"notAfter"</span><span class="op">)</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t167" href="#t167">167</a></span><span class="t">                <span class="key">if</span> <span class="nam">date</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"notBefore"</span><span class="op">)</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t168" href="#t168">168</a></span><span class="t">                    <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="op">=</span> <span class="nam">int</span><span class="op">(</span><span class="nam">date</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"notBefore"</span><span class="op">)</span><span class="op">.</span><span class="nam">split</span><span class="op">(</span><span class="str">"-"</span><span class="op">)</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t169" href="#t169">169</a></span><span class="t">                <span class="key">if</span> <span class="nam">date</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"notAfter"</span><span class="op">)</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t170" href="#t170">170</a></span><span class="t">                    <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="op">=</span> <span class="nam">int</span><span class="op">(</span><span class="nam">date</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"notAfter"</span><span class="op">)</span><span class="op">.</span><span class="nam">split</span><span class="op">(</span><span class="str">"-"</span><span class="op">)</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t171" href="#t171">171</a></span><span class="t">        <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t172" href="#t172">172</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t173" href="#t173">173</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_base_wit</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">wit</span><span class="op">:</span> <span class="nam">str</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t174" href="#t174">174</a></span><span class="t">        <span class="str">"""Given a witness siglum, strips of the specified manuscript suffixes until the siglum matches one in the witness list or until no more suffixes can be stripped.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t175" href="#t175">175</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t176" href="#t176">176</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t177" href="#t177">177</a></span><span class="t"><span class="str">            wit: A string representing a witness siglum, potentially including suffixes to be stripped.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t178" href="#t178">178</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t179" href="#t179">179</a></span><span class="t">        <span class="nam">base_wit</span> <span class="op">=</span> <span class="nam">wit</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t180" href="#t180">180</a></span><span class="t">        <span class="com"># If our starting siglum corresponds to a siglum in the witness list, then just return it:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t181" href="#t181">181</a></span><span class="t">        <span class="key">if</span> <span class="nam">base_wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witness_index_by_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t182" href="#t182">182</a></span><span class="t">            <span class="key">return</span> <span class="nam">base_wit</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t183" href="#t183">183</a></span><span class="t">        <span class="com"># Otherwise, strip any suffixes we find until the siglum corresponds to a base witness in the list</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t184" href="#t184">184</a></span><span class="t">        <span class="com"># or no more suffixes can be stripped:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t185" href="#t185">185</a></span><span class="t">        <span class="nam">suffix_found</span> <span class="op">=</span> <span class="key">True</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t186" href="#t186">186</a></span><span class="t">        <span class="key">while</span> <span class="nam">suffix_found</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t187" href="#t187">187</a></span><span class="t">            <span class="nam">suffix_found</span> <span class="op">=</span> <span class="key">False</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t188" href="#t188">188</a></span><span class="t">            <span class="key">for</span> <span class="nam">suffix</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">manuscript_suffixes</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t189" href="#t189">189</a></span><span class="t">                <span class="key">if</span> <span class="nam">base_wit</span><span class="op">.</span><span class="nam">endswith</span><span class="op">(</span><span class="nam">suffix</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t190" href="#t190">190</a></span><span class="t">                    <span class="nam">suffix_found</span> <span class="op">=</span> <span class="key">True</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t191" href="#t191">191</a></span><span class="t">                    <span class="nam">base_wit</span> <span class="op">=</span> <span class="nam">base_wit</span><span class="op">[</span><span class="op">:</span> <span class="op">-</span><span class="nam">len</span><span class="op">(</span><span class="nam">suffix</span><span class="op">)</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t192" href="#t192">192</a></span><span class="t">                    <span class="key">break</span>  <span class="com"># stop looking for other suffixes</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t193" href="#t193">193</a></span><span class="t">            <span class="com"># If the siglum stripped of this suffix now corresponds to a siglum in the witness list, then return it:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t194" href="#t194">194</a></span><span class="t">            <span class="key">if</span> <span class="nam">base_wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witness_index_by_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t195" href="#t195">195</a></span><span class="t">                <span class="key">return</span> <span class="nam">base_wit</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t196" href="#t196">196</a></span><span class="t">        <span class="com"># If we get here, then all possible manuscript suffixes have been stripped, and the resulting siglum does not correspond to a siglum in the witness list:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t197" href="#t197">197</a></span><span class="t">        <span class="key">return</span> <span class="nam">base_wit</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t198" href="#t198">198</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t199" href="#t199">199</a></span><span class="t">    <span class="key">def</span> <span class="nam">parse_list_wit</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">xml</span><span class="op">:</span> <span class="nam">et</span><span class="op">.</span><span class="nam">ElementTree</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t200" href="#t200">200</a></span><span class="t">        <span class="str">"""Given an XML tree for a collation, populates its list of witnesses from its listWit element.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t201" href="#t201">201</a></span><span class="t"><span class="str">        If the XML tree does not contain a listWit element, then a ParsingException is thrown listing all distinct witness sigla encountered in the collation.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t202" href="#t202">202</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t203" href="#t203">203</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t204" href="#t204">204</a></span><span class="t"><span class="str">            xml: An lxml.etree.ElementTree representing an XML tree rooted at a TEI element.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t205" href="#t205">205</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t206" href="#t206">206</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t207" href="#t207">207</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"Parsing witness list..."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t208" href="#t208">208</a></span><span class="t">        <span class="nam">t0</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t209" href="#t209">209</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t210" href="#t210">210</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">witness_index_by_id</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t211" href="#t211">211</a></span><span class="t">        <span class="nam">list_wits</span> <span class="op">=</span> <span class="nam">xml</span><span class="op">.</span><span class="nam">xpath</span><span class="op">(</span><span class="str">"/tei:TEI//tei:listWit"</span><span class="op">,</span> <span class="nam">namespaces</span><span class="op">=</span><span class="op">{</span><span class="str">"tei"</span><span class="op">:</span> <span class="nam">tei_ns</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t212" href="#t212">212</a></span><span class="t">        <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">list_wits</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t213" href="#t213">213</a></span><span class="t">            <span class="com"># There is no listWit element: collect all distinct witness sigla in the collation and raise a ParsingException listing them:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t214" href="#t214">214</a></span><span class="t">            <span class="nam">distinct_sigla</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t215" href="#t215">215</a></span><span class="t">            <span class="nam">sigla</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t216" href="#t216">216</a></span><span class="t">            <span class="com"># Proceed for each rdg, rdgGrp, or witDetail element:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t217" href="#t217">217</a></span><span class="t">            <span class="key">for</span> <span class="nam">rdg</span> <span class="key">in</span> <span class="nam">xml</span><span class="op">.</span><span class="nam">xpath</span><span class="op">(</span><span class="str">"//tei:rdg|//tei:rdgGrp|//tei:witDetail"</span><span class="op">,</span> <span class="nam">namespaces</span><span class="op">=</span><span class="op">{</span><span class="str">"tei"</span><span class="op">:</span> <span class="nam">tei_ns</span><span class="op">}</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t218" href="#t218">218</a></span><span class="t">                <span class="nam">wit_str</span> <span class="op">=</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"wit"</span><span class="op">)</span> <span class="key">if</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"wit"</span><span class="op">)</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span> <span class="key">else</span> <span class="str">""</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t219" href="#t219">219</a></span><span class="t">                <span class="nam">wits</span> <span class="op">=</span> <span class="nam">wit_str</span><span class="op">.</span><span class="nam">split</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t220" href="#t220">220</a></span><span class="t">                <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">wits</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t221" href="#t221">221</a></span><span class="t">                    <span class="nam">siglum</span> <span class="op">=</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">strip</span><span class="op">(</span><span class="str">"#"</span><span class="op">)</span>  <span class="com"># remove the URI prefix, if there is one</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t222" href="#t222">222</a></span><span class="t">                    <span class="key">if</span> <span class="nam">siglum</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">distinct_sigla</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t223" href="#t223">223</a></span><span class="t">                        <span class="nam">distinct_sigla</span><span class="op">.</span><span class="nam">add</span><span class="op">(</span><span class="nam">siglum</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t224" href="#t224">224</a></span><span class="t">                        <span class="nam">sigla</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">siglum</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t225" href="#t225">225</a></span><span class="t">            <span class="nam">sigla</span><span class="op">.</span><span class="nam">sort</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t226" href="#t226">226</a></span><span class="t">            <span class="nam">msg</span> <span class="op">=</span> <span class="str">""</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t227" href="#t227">227</a></span><span class="t">            <span class="nam">msg</span> <span class="op">+=</span> <span class="str">"An explicit listWit element must be included in the TEI XML collation.\n"</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t228" href="#t228">228</a></span><span class="t">            <span class="nam">msg</span> <span class="op">+=</span> <span class="str">"The following sigla occur in the collation and should be included as the @xml:id or @n attributes of witness elements under the listWit element:\n"</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t229" href="#t229">229</a></span><span class="t">            <span class="nam">msg</span> <span class="op">+=</span> <span class="str">", "</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="nam">sigla</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t230" href="#t230">230</a></span><span class="t">            <span class="key">raise</span> <span class="nam">ParsingException</span><span class="op">(</span><span class="nam">msg</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t231" href="#t231">231</a></span><span class="t">        <span class="com"># Otherwise, take the first listWit element as the list of all witnesses and process it:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t232" href="#t232">232</a></span><span class="t">        <span class="nam">list_wit</span> <span class="op">=</span> <span class="nam">list_wits</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t233" href="#t233">233</a></span><span class="t">        <span class="key">for</span> <span class="nam">witness</span> <span class="key">in</span> <span class="nam">list_wit</span><span class="op">.</span><span class="nam">xpath</span><span class="op">(</span><span class="str">"./tei:witness"</span><span class="op">,</span> <span class="nam">namespaces</span><span class="op">=</span><span class="op">{</span><span class="str">"tei"</span><span class="op">:</span> <span class="nam">tei_ns</span><span class="op">}</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t234" href="#t234">234</a></span><span class="t">            <span class="nam">wit</span> <span class="op">=</span> <span class="nam">Witness</span><span class="op">(</span><span class="nam">witness</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t235" href="#t235">235</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">witness_index_by_id</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span> <span class="op">=</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t236" href="#t236">236</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">wit</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t237" href="#t237">237</a></span><span class="t">        <span class="nam">t1</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t238" href="#t238">238</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t239" href="#t239">239</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"Finished processing %d witnesses in %0.4fs."</span> <span class="op">%</span> <span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span><span class="op">,</span> <span class="nam">t1</span> <span class="op">-</span> <span class="nam">t0</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t240" href="#t240">240</a></span><span class="t">        <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t241" href="#t241">241</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t242" href="#t242">242</a></span><span class="t">    <span class="key">def</span> <span class="nam">validate_wits</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">xml</span><span class="op">:</span> <span class="nam">et</span><span class="op">.</span><span class="nam">ElementTree</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t243" href="#t243">243</a></span><span class="t">        <span class="str">"""Given an XML tree for a collation, checks if any witness sigla listed in a rdg, rdgGrp, or witDetail element,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t244" href="#t244">244</a></span><span class="t"><span class="str">        once stripped of ignored suffixes, is not found in the witness list.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t245" href="#t245">245</a></span><span class="t"><span class="str">        A warning will be issued for each distinct siglum like this.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t246" href="#t246">246</a></span><span class="t"><span class="str">        This method also checks if the upper bound of any witness's date is earlier than the lower bound on the collated work's date of origin</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t247" href="#t247">247</a></span><span class="t"><span class="str">        and throws an exception if so.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t248" href="#t248">248</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t249" href="#t249">249</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t250" href="#t250">250</a></span><span class="t"><span class="str">            xml: An lxml.etree.ElementTree representing an XML tree rooted at a TEI element.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t251" href="#t251">251</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t252" href="#t252">252</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t253" href="#t253">253</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"Validating witness list against collation..."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t254" href="#t254">254</a></span><span class="t">        <span class="nam">t0</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t255" href="#t255">255</a></span><span class="t">        <span class="com"># There is no listWit element: collect all distinct witness sigla in the collation and raise an exception listing them:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t256" href="#t256">256</a></span><span class="t">        <span class="nam">distinct_extra_sigla</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t257" href="#t257">257</a></span><span class="t">        <span class="nam">extra_sigla</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t258" href="#t258">258</a></span><span class="t">        <span class="com"># Proceed for each rdg, rdgGrp, or witDetail element:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t259" href="#t259">259</a></span><span class="t">        <span class="key">for</span> <span class="nam">rdg</span> <span class="key">in</span> <span class="nam">xml</span><span class="op">.</span><span class="nam">xpath</span><span class="op">(</span><span class="str">"//tei:rdg|//tei:rdgGrp|//tei:witDetail"</span><span class="op">,</span> <span class="nam">namespaces</span><span class="op">=</span><span class="op">{</span><span class="str">"tei"</span><span class="op">:</span> <span class="nam">tei_ns</span><span class="op">}</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t260" href="#t260">260</a></span><span class="t">            <span class="nam">wit_str</span> <span class="op">=</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"wit"</span><span class="op">)</span> <span class="key">if</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"wit"</span><span class="op">)</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span> <span class="key">else</span> <span class="str">""</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t261" href="#t261">261</a></span><span class="t">            <span class="nam">wits</span> <span class="op">=</span> <span class="nam">wit_str</span><span class="op">.</span><span class="nam">split</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t262" href="#t262">262</a></span><span class="t">            <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">wits</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t263" href="#t263">263</a></span><span class="t">                <span class="nam">siglum</span> <span class="op">=</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">strip</span><span class="op">(</span><span class="str">"#"</span><span class="op">)</span>  <span class="com"># remove the URI prefix, if there is one</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t264" href="#t264">264</a></span><span class="t">                <span class="nam">base_siglum</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_base_wit</span><span class="op">(</span><span class="nam">siglum</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t265" href="#t265">265</a></span><span class="t">                <span class="key">if</span> <span class="nam">base_siglum</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witness_index_by_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t266" href="#t266">266</a></span><span class="t">                    <span class="key">if</span> <span class="nam">base_siglum</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">distinct_extra_sigla</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t267" href="#t267">267</a></span><span class="t">                        <span class="nam">distinct_extra_sigla</span><span class="op">.</span><span class="nam">add</span><span class="op">(</span><span class="nam">base_siglum</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t268" href="#t268">268</a></span><span class="t">                        <span class="nam">extra_sigla</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">base_siglum</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t269" href="#t269">269</a></span><span class="t">        <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">extra_sigla</span><span class="op">)</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t270" href="#t270">270</a></span><span class="t">            <span class="nam">extra_sigla</span><span class="op">.</span><span class="nam">sort</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t271" href="#t271">271</a></span><span class="t">            <span class="nam">msg</span> <span class="op">=</span> <span class="str">""</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t272" href="#t272">272</a></span><span class="t">            <span class="nam">msg</span> <span class="op">+=</span> <span class="str">"WARNING: The following sigla occur in the collation that do not have corresponding witness entries in the listWit:\n"</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t273" href="#t273">273</a></span><span class="t">            <span class="nam">msg</span> <span class="op">+=</span> <span class="str">", "</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="nam">extra_sigla</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t274" href="#t274">274</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="nam">msg</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t275" href="#t275">275</a></span><span class="t">        <span class="com"># If the lower bound on the date of origin is defined, then check each witness against it:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t276" href="#t276">276</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t277" href="#t277">277</a></span><span class="t">            <span class="nam">bad_date_witness_sigla</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t278" href="#t278">278</a></span><span class="t">            <span class="nam">bad_date_upper_bounds_by_witness</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t279" href="#t279">279</a></span><span class="t">            <span class="key">for</span> <span class="nam">i</span><span class="op">,</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t280" href="#t280">280</a></span><span class="t">                <span class="key">if</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span> <span class="key">and</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t281" href="#t281">281</a></span><span class="t">                    <span class="nam">bad_date_witness_sigla</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t282" href="#t282">282</a></span><span class="t">                    <span class="nam">bad_date_upper_bounds_by_witness</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span> <span class="op">=</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t283" href="#t283">283</a></span><span class="t">            <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">bad_date_witness_sigla</span><span class="op">)</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t284" href="#t284">284</a></span><span class="t">                <span class="nam">msg</span> <span class="op">=</span> <span class="str">""</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t285" href="#t285">285</a></span><span class="t">                <span class="nam">msg</span> <span class="op">+=</span> <span class="str">"The following witnesses have their latest possible dates before the earliest date of origin %d specified for the collated work:\n"</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t286" href="#t286">286</a></span><span class="t">                <span class="nam">msg</span> <span class="op">+=</span> <span class="str">", "</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t287" href="#t287">287</a></span><span class="t">                    <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t288" href="#t288">288</a></span><span class="t">                        <span class="op">(</span><span class="nam">siglum</span> <span class="op">+</span> <span class="str">"("</span> <span class="op">+</span> <span class="nam">str</span><span class="op">(</span><span class="nam">bad_date_upper_bounds_by_witness</span><span class="op">[</span><span class="nam">siglum</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="str">")"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t289" href="#t289">289</a></span><span class="t">                        <span class="key">for</span> <span class="nam">siglum</span> <span class="key">in</span> <span class="nam">bad_date_witness_sigla</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t290" href="#t290">290</a></span><span class="t">                    <span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t291" href="#t291">291</a></span><span class="t">                <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t292" href="#t292">292</a></span><span class="t">                <span class="key">raise</span> <span class="nam">WitnessDateException</span><span class="op">(</span><span class="nam">msg</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t293" href="#t293">293</a></span><span class="t">        <span class="nam">t1</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t294" href="#t294">294</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t295" href="#t295">295</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"Finished witness validation in %0.4fs."</span> <span class="op">%</span> <span class="op">(</span><span class="nam">t1</span> <span class="op">-</span> <span class="nam">t0</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t296" href="#t296">296</a></span><span class="t">        <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t297" href="#t297">297</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t298" href="#t298">298</a></span><span class="t">    <span class="key">def</span> <span class="nam">update_witness_date_ranges_from_dates_file</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">dates_file</span><span class="op">:</span> <span class="nam">Union</span><span class="op">[</span><span class="nam">Path</span><span class="op">,</span> <span class="nam">str</span><span class="op">]</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t299" href="#t299">299</a></span><span class="t">        <span class="str">"""Given a CSV-formatted dates file, update the date ranges of all witnesses whose IDs are in the first column of the dates file</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t300" href="#t300">300</a></span><span class="t"><span class="str">        (overwriting existing date ranges if necessary).</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t301" href="#t301">301</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t302" href="#t302">302</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t303" href="#t303">303</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"Updating witness dates from file %s..."</span> <span class="op">%</span> <span class="op">(</span><span class="nam">str</span><span class="op">(</span><span class="nam">dates_file</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t304" href="#t304">304</a></span><span class="t">        <span class="nam">t0</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t305" href="#t305">305</a></span><span class="t">        <span class="nam">dates_df</span> <span class="op">=</span> <span class="nam">pd</span><span class="op">.</span><span class="nam">read_csv</span><span class="op">(</span><span class="nam">dates_file</span><span class="op">,</span> <span class="nam">index_col</span><span class="op">=</span><span class="num">0</span><span class="op">,</span> <span class="nam">names</span><span class="op">=</span><span class="op">[</span><span class="str">"id"</span><span class="op">,</span> <span class="str">"min"</span><span class="op">,</span> <span class="str">"max"</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t306" href="#t306">306</a></span><span class="t">        <span class="key">for</span> <span class="nam">witness</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t307" href="#t307">307</a></span><span class="t">            <span class="nam">wit_id</span> <span class="op">=</span> <span class="nam">witness</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t308" href="#t308">308</a></span><span class="t">            <span class="key">if</span> <span class="nam">wit_id</span> <span class="key">in</span> <span class="nam">dates_df</span><span class="op">.</span><span class="nam">index</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t309" href="#t309">309</a></span><span class="t">                <span class="com"># For every witness in the list whose ID is specified in the dates file,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t310" href="#t310">310</a></span><span class="t">                <span class="com"># update their date ranges (as long as the date ranges in the file are are well-formed):</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t311" href="#t311">311</a></span><span class="t">                <span class="nam">min_date</span> <span class="op">=</span> <span class="nam">int</span><span class="op">(</span><span class="nam">dates_df</span><span class="op">.</span><span class="nam">loc</span><span class="op">[</span><span class="nam">wit_id</span><span class="op">]</span><span class="op">[</span><span class="str">"min"</span><span class="op">]</span><span class="op">)</span> <span class="key">if</span> <span class="key">not</span> <span class="nam">np</span><span class="op">.</span><span class="nam">isnan</span><span class="op">(</span><span class="nam">dates_df</span><span class="op">.</span><span class="nam">loc</span><span class="op">[</span><span class="nam">wit_id</span><span class="op">]</span><span class="op">[</span><span class="str">"min"</span><span class="op">]</span><span class="op">)</span> <span class="key">else</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t312" href="#t312">312</a></span><span class="t">                <span class="nam">max_date</span> <span class="op">=</span> <span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t313" href="#t313">313</a></span><span class="t">                    <span class="nam">int</span><span class="op">(</span><span class="nam">dates_df</span><span class="op">.</span><span class="nam">loc</span><span class="op">[</span><span class="nam">wit_id</span><span class="op">]</span><span class="op">[</span><span class="str">"max"</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t314" href="#t314">314</a></span><span class="t">                    <span class="key">if</span> <span class="key">not</span> <span class="nam">np</span><span class="op">.</span><span class="nam">isnan</span><span class="op">(</span><span class="nam">dates_df</span><span class="op">.</span><span class="nam">loc</span><span class="op">[</span><span class="nam">wit_id</span><span class="op">]</span><span class="op">[</span><span class="str">"max"</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t315" href="#t315">315</a></span><span class="t">                    <span class="key">else</span> <span class="nam">datetime</span><span class="op">.</span><span class="nam">now</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">year</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t316" href="#t316">316</a></span><span class="t">                <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t317" href="#t317">317</a></span><span class="t">                <span class="nam">print</span><span class="op">(</span><span class="nam">min_date</span><span class="op">,</span> <span class="nam">max_date</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t318" href="#t318">318</a></span><span class="t">                <span class="key">if</span> <span class="nam">min_date</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span> <span class="key">and</span> <span class="nam">max_date</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span> <span class="key">and</span> <span class="nam">min_date</span> <span class="op">></span> <span class="nam">max_date</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t319" href="#t319">319</a></span><span class="t">                    <span class="key">raise</span> <span class="nam">ParsingException</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t320" href="#t320">320</a></span><span class="t">                        <span class="str">"In dates file %s, for witness ID %s, the minimum date %d is greater than the maximum date %d."</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t321" href="#t321">321</a></span><span class="t">                        <span class="op">%</span> <span class="op">(</span><span class="nam">str</span><span class="op">(</span><span class="nam">dates_file</span><span class="op">)</span><span class="op">,</span> <span class="nam">wit_id</span><span class="op">,</span> <span class="nam">min_date</span><span class="op">,</span> <span class="nam">max_date</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t322" href="#t322">322</a></span><span class="t">                    <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t323" href="#t323">323</a></span><span class="t">                <span class="nam">witness</span><span class="op">.</span><span class="nam">date_range</span> <span class="op">=</span> <span class="op">[</span><span class="nam">min_date</span><span class="op">,</span> <span class="nam">max_date</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t324" href="#t324">324</a></span><span class="t">        <span class="nam">t1</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t325" href="#t325">325</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t326" href="#t326">326</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"Finished witness date range updates in %0.4fs."</span> <span class="op">%</span> <span class="op">(</span><span class="nam">t1</span> <span class="op">-</span> <span class="nam">t0</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t327" href="#t327">327</a></span><span class="t">        <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t328" href="#t328">328</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t329" href="#t329">329</a></span><span class="t">    <span class="key">def</span> <span class="nam">update_origin_date_range_from_witness_date_ranges</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t330" href="#t330">330</a></span><span class="t">        <span class="str">"""Conditionally updates the upper bound on the date of origin of the work represented by this Collation</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t331" href="#t331">331</a></span><span class="t"><span class="str">        based on the bounds on the witnesses' dates.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t332" href="#t332">332</a></span><span class="t"><span class="str">        If none of the witnesses have bounds on their dates, then nothing is done.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t333" href="#t333">333</a></span><span class="t"><span class="str">        This method is only invoked if the work's date of origin does not already have its upper bound defined.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t334" href="#t334">334</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t335" href="#t335">335</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t336" href="#t336">336</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"Updating upper bound on origin date using witness dates..."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t337" href="#t337">337</a></span><span class="t">        <span class="nam">t0</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t338" href="#t338">338</a></span><span class="t">        <span class="com"># Set the origin date to the earliest witness date:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t339" href="#t339">339</a></span><span class="t">        <span class="nam">witness_date_lower_bounds</span> <span class="op">=</span> <span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span> <span class="key">if</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t340" href="#t340">340</a></span><span class="t">        <span class="nam">witness_date_upper_bounds</span> <span class="op">=</span> <span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span> <span class="key">if</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t341" href="#t341">341</a></span><span class="t">        <span class="nam">min_witness_date</span> <span class="op">=</span> <span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t342" href="#t342">342</a></span><span class="t">            <span class="nam">min</span><span class="op">(</span><span class="nam">witness_date_lower_bounds</span> <span class="op">+</span> <span class="nam">witness_date_upper_bounds</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t343" href="#t343">343</a></span><span class="t">            <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">witness_date_lower_bounds</span> <span class="op">+</span> <span class="nam">witness_date_upper_bounds</span><span class="op">)</span> <span class="op">></span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t344" href="#t344">344</a></span><span class="t">            <span class="key">else</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t345" href="#t345">345</a></span><span class="t">        <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t346" href="#t346">346</a></span><span class="t">        <span class="key">if</span> <span class="nam">min_witness_date</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t347" href="#t347">347</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t348" href="#t348">348</a></span><span class="t">                <span class="nam">min</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">,</span> <span class="nam">min_witness_date</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t349" href="#t349">349</a></span><span class="t">                <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t350" href="#t350">350</a></span><span class="t">                <span class="key">else</span> <span class="nam">min_witness_date</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t351" href="#t351">351</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t352" href="#t352">352</a></span><span class="t">        <span class="nam">t1</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t353" href="#t353">353</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t354" href="#t354">354</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"Finished updating upper bound on origin date in %0.4fs."</span> <span class="op">%</span> <span class="op">(</span><span class="nam">t1</span> <span class="op">-</span> <span class="nam">t0</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t355" href="#t355">355</a></span><span class="t">        <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t356" href="#t356">356</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t357" href="#t357">357</a></span><span class="t">    <span class="key">def</span> <span class="nam">update_witness_date_ranges_from_origin_date_range</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t358" href="#t358">358</a></span><span class="t">        <span class="str">"""Attempts to update the lower bounds on the witnesses' dates of origin of the work represented by this Collation</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t359" href="#t359">359</a></span><span class="t"><span class="str">        using the upper bound on the date of origin of the work represented by this Collation.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t360" href="#t360">360</a></span><span class="t"><span class="str">        This method is only invoked if the upper bound on the work's date of origin was not already defined</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t361" href="#t361">361</a></span><span class="t"><span class="str">        (i.e., if update_origin_date_range_from_witness_date_ranges was not invoked).</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t362" href="#t362">362</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t363" href="#t363">363</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t364" href="#t364">364</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"Updating lower bounds on witness dates using origin date..."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t365" href="#t365">365</a></span><span class="t">        <span class="nam">t0</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t366" href="#t366">366</a></span><span class="t">        <span class="com"># Proceed for every witness:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t367" href="#t367">367</a></span><span class="t">        <span class="key">for</span> <span class="nam">i</span><span class="op">,</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t368" href="#t368">368</a></span><span class="t">            <span class="com"># Ensure that the lower bound on this witness's date is no earlier than the upper bound on the date of the work's origin:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t369" href="#t369">369</a></span><span class="t">            <span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t370" href="#t370">370</a></span><span class="t">                <span class="nam">max</span><span class="op">(</span><span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t371" href="#t371">371</a></span><span class="t">                <span class="key">if</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t372" href="#t372">372</a></span><span class="t">                <span class="key">else</span> <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t373" href="#t373">373</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t374" href="#t374">374</a></span><span class="t">            <span class="com"># Then ensure that the upper bound on this witness's date is no earlier than its lower bound, in case we updated it:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t375" href="#t375">375</a></span><span class="t">            <span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span><span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t376" href="#t376">376</a></span><span class="t">        <span class="nam">t1</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t377" href="#t377">377</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t378" href="#t378">378</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"Finished updating lower bounds on witness dates in %0.4fs."</span> <span class="op">%</span> <span class="op">(</span><span class="nam">t1</span> <span class="op">-</span> <span class="nam">t0</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t379" href="#t379">379</a></span><span class="t">        <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t380" href="#t380">380</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t381" href="#t381">381</a></span><span class="t">    <span class="key">def</span> <span class="nam">parse_intrinsic_odds</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">xml</span><span class="op">:</span> <span class="nam">et</span><span class="op">.</span><span class="nam">ElementTree</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t382" href="#t382">382</a></span><span class="t">        <span class="str">"""Given an XML tree for a collation, populates this Collation's list of intrinsic probability categories</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t383" href="#t383">383</a></span><span class="t"><span class="str">        (e.g., "absolutely more likely," "highly more likely," "more likely," "slightly more likely," "equally likely")</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t384" href="#t384">384</a></span><span class="t"><span class="str">        and its dictionary mapping these categories to numerical odds.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t385" href="#t385">385</a></span><span class="t"><span class="str">        If a category does not contain a certainty element specifying its number, then it will be assumed to be a parameter to be estimated.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t386" href="#t386">386</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t387" href="#t387">387</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t388" href="#t388">388</a></span><span class="t"><span class="str">            xml: An lxml.etree.ElementTree representing an XML tree rooted at a TEI element.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t389" href="#t389">389</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t390" href="#t390">390</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t391" href="#t391">391</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"Parsing intrinsic odds categories..."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t392" href="#t392">392</a></span><span class="t">        <span class="nam">t0</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t393" href="#t393">393</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">intrinsic_categories</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t394" href="#t394">394</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">intrinsic_odds_by_id</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t395" href="#t395">395</a></span><span class="t">        <span class="key">for</span> <span class="nam">interp</span> <span class="key">in</span> <span class="nam">xml</span><span class="op">.</span><span class="nam">xpath</span><span class="op">(</span><span class="str">"//tei:interpGrp[@type=\"intrinsic\"]/tei:interp"</span><span class="op">,</span> <span class="nam">namespaces</span><span class="op">=</span><span class="op">{</span><span class="str">"tei"</span><span class="op">:</span> <span class="nam">tei_ns</span><span class="op">}</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t396" href="#t396">396</a></span><span class="t">            <span class="com"># These must be indexed by the xml:id attribute, so skip any that do not have one:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t397" href="#t397">397</a></span><span class="t">            <span class="key">if</span> <span class="nam">interp</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"{%s}id"</span> <span class="op">%</span> <span class="nam">xml_ns</span><span class="op">)</span> <span class="key">is</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t398" href="#t398">398</a></span><span class="t">                <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t399" href="#t399">399</a></span><span class="t">            <span class="nam">odds_category</span> <span class="op">=</span> <span class="nam">interp</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"{%s}id"</span> <span class="op">%</span> <span class="nam">xml_ns</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t400" href="#t400">400</a></span><span class="t">            <span class="com"># If this element contains a certainty subelement with a fixed odds value for this category, then set it:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t401" href="#t401">401</a></span><span class="t">            <span class="nam">odds</span> <span class="op">=</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t402" href="#t402">402</a></span><span class="t">            <span class="key">for</span> <span class="nam">certainty</span> <span class="key">in</span> <span class="nam">interp</span><span class="op">.</span><span class="nam">xpath</span><span class="op">(</span><span class="str">"./tei:certainty"</span><span class="op">,</span> <span class="nam">namespaces</span><span class="op">=</span><span class="op">{</span><span class="str">"tei"</span><span class="op">:</span> <span class="nam">tei_ns</span><span class="op">}</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t403" href="#t403">403</a></span><span class="t">                <span class="key">if</span> <span class="nam">certainty</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"degree"</span><span class="op">)</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t404" href="#t404">404</a></span><span class="t">                    <span class="nam">odds</span> <span class="op">=</span> <span class="nam">float</span><span class="op">(</span><span class="nam">certainty</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"degree"</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t405" href="#t405">405</a></span><span class="t">                    <span class="key">break</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t406" href="#t406">406</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">intrinsic_categories</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">odds_category</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t407" href="#t407">407</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">intrinsic_odds_by_id</span><span class="op">[</span><span class="nam">odds_category</span><span class="op">]</span> <span class="op">=</span> <span class="nam">odds</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t408" href="#t408">408</a></span><span class="t">        <span class="nam">t1</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t409" href="#t409">409</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t410" href="#t410">410</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t411" href="#t411">411</a></span><span class="t">                <span class="str">"Finished processing %d intrinsic odds categories in %0.4fs."</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t412" href="#t412">412</a></span><span class="t">                <span class="op">%</span> <span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">intrinsic_categories</span><span class="op">)</span><span class="op">,</span> <span class="nam">t1</span> <span class="op">-</span> <span class="nam">t0</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t413" href="#t413">413</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t414" href="#t414">414</a></span><span class="t">        <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t415" href="#t415">415</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t416" href="#t416">416</a></span><span class="t">    <span class="key">def</span> <span class="nam">parse_transcriptional_rates</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">xml</span><span class="op">:</span> <span class="nam">et</span><span class="op">.</span><span class="nam">ElementTree</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t417" href="#t417">417</a></span><span class="t">        <span class="str">"""Given an XML tree for a collation, populates this Collation's dictionary mapping transcriptional change categories</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t418" href="#t418">418</a></span><span class="t"><span class="str">        (e.g., "aural confusion," "visual error," "clarification") to numerical rates.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t419" href="#t419">419</a></span><span class="t"><span class="str">        If a category does not contain a certainty element specifying its number, then it will be assumed to be a parameter to be estimated.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t420" href="#t420">420</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t421" href="#t421">421</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t422" href="#t422">422</a></span><span class="t"><span class="str">            xml: An lxml.etree.ElementTree representing an XML tree rooted at a TEI element.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t423" href="#t423">423</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t424" href="#t424">424</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t425" href="#t425">425</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"Parsing transcriptional change categories..."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t426" href="#t426">426</a></span><span class="t">        <span class="nam">t0</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t427" href="#t427">427</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">transcriptional_categories</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t428" href="#t428">428</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">transcriptional_rates_by_id</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t429" href="#t429">429</a></span><span class="t">        <span class="key">for</span> <span class="nam">interp</span> <span class="key">in</span> <span class="nam">xml</span><span class="op">.</span><span class="nam">xpath</span><span class="op">(</span><span class="str">"//tei:interpGrp[@type=\"transcriptional\"]/tei:interp"</span><span class="op">,</span> <span class="nam">namespaces</span><span class="op">=</span><span class="op">{</span><span class="str">"tei"</span><span class="op">:</span> <span class="nam">tei_ns</span><span class="op">}</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t430" href="#t430">430</a></span><span class="t">            <span class="com"># These must be indexed by the xml:id attribute, so skip any that do not have one:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t431" href="#t431">431</a></span><span class="t">            <span class="key">if</span> <span class="nam">interp</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"{%s}id"</span> <span class="op">%</span> <span class="nam">xml_ns</span><span class="op">)</span> <span class="key">is</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t432" href="#t432">432</a></span><span class="t">                <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t433" href="#t433">433</a></span><span class="t">            <span class="nam">transcriptional_category</span> <span class="op">=</span> <span class="nam">interp</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"{%s}id"</span> <span class="op">%</span> <span class="nam">xml_ns</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t434" href="#t434">434</a></span><span class="t">            <span class="com"># If this element contains a certainty subelement with a fixed rate for this category, then set it:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t435" href="#t435">435</a></span><span class="t">            <span class="nam">rate</span> <span class="op">=</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t436" href="#t436">436</a></span><span class="t">            <span class="key">for</span> <span class="nam">certainty</span> <span class="key">in</span> <span class="nam">interp</span><span class="op">.</span><span class="nam">xpath</span><span class="op">(</span><span class="str">"./tei:certainty"</span><span class="op">,</span> <span class="nam">namespaces</span><span class="op">=</span><span class="op">{</span><span class="str">"tei"</span><span class="op">:</span> <span class="nam">tei_ns</span><span class="op">}</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t437" href="#t437">437</a></span><span class="t">                <span class="key">if</span> <span class="nam">certainty</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"degree"</span><span class="op">)</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t438" href="#t438">438</a></span><span class="t">                    <span class="nam">rate</span> <span class="op">=</span> <span class="nam">float</span><span class="op">(</span><span class="nam">certainty</span><span class="op">.</span><span class="nam">get</span><span class="op">(</span><span class="str">"degree"</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t439" href="#t439">439</a></span><span class="t">                    <span class="key">break</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t440" href="#t440">440</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">transcriptional_categories</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">transcriptional_category</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t441" href="#t441">441</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">transcriptional_rates_by_id</span><span class="op">[</span><span class="nam">transcriptional_category</span><span class="op">]</span> <span class="op">=</span> <span class="nam">rate</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t442" href="#t442">442</a></span><span class="t">        <span class="nam">t1</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t443" href="#t443">443</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t444" href="#t444">444</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t445" href="#t445">445</a></span><span class="t">                <span class="str">"Finished processing %d transcriptional change categories in %0.4fs."</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t446" href="#t446">446</a></span><span class="t">                <span class="op">%</span> <span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">transcriptional_rates_by_id</span><span class="op">)</span><span class="op">,</span> <span class="nam">t1</span> <span class="op">-</span> <span class="nam">t0</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t447" href="#t447">447</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t448" href="#t448">448</a></span><span class="t">        <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t449" href="#t449">449</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t450" href="#t450">450</a></span><span class="t">    <span class="key">def</span> <span class="nam">validate_intrinsic_relations</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t451" href="#t451">451</a></span><span class="t">        <span class="str">"""Checks if any VariationUnit's intrinsic_relations map is not a forest.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t452" href="#t452">452</a></span><span class="t"><span class="str">        If any is not, then an IntrinsicRelationsException is thrown describing the VariationUnit at fault.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t453" href="#t453">453</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t454" href="#t454">454</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t455" href="#t455">455</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"Validating intrinsic relation graphs for variation units..."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t456" href="#t456">456</a></span><span class="t">        <span class="nam">t0</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t457" href="#t457">457</a></span><span class="t">        <span class="key">for</span> <span class="nam">vu</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_units</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t458" href="#t458">458</a></span><span class="t">            <span class="com"># Skip any variation units with an empty intrinsic_relations map:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t459" href="#t459">459</a></span><span class="t">            <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">vu</span><span class="op">.</span><span class="nam">intrinsic_relations</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t460" href="#t460">460</a></span><span class="t">                <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t461" href="#t461">461</a></span><span class="t">            <span class="com"># For all others, start by identifying all reading IDs that are not related to by some other reading ID:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t462" href="#t462">462</a></span><span class="t">            <span class="nam">in_degree_by_reading</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t463" href="#t463">463</a></span><span class="t">            <span class="key">for</span> <span class="nam">edge</span> <span class="key">in</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">intrinsic_relations</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t464" href="#t464">464</a></span><span class="t">                <span class="nam">s</span> <span class="op">=</span> <span class="nam">edge</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t465" href="#t465">465</a></span><span class="t">                <span class="nam">t</span> <span class="op">=</span> <span class="nam">edge</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t466" href="#t466">466</a></span><span class="t">                <span class="key">if</span> <span class="nam">s</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">in_degree_by_reading</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t467" href="#t467">467</a></span><span class="t">                    <span class="nam">in_degree_by_reading</span><span class="op">[</span><span class="nam">s</span><span class="op">]</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t468" href="#t468">468</a></span><span class="t">                <span class="key">if</span> <span class="nam">t</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">in_degree_by_reading</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t469" href="#t469">469</a></span><span class="t">                    <span class="nam">in_degree_by_reading</span><span class="op">[</span><span class="nam">t</span><span class="op">]</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t470" href="#t470">470</a></span><span class="t">                <span class="nam">in_degree_by_reading</span><span class="op">[</span><span class="nam">t</span><span class="op">]</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t471" href="#t471">471</a></span><span class="t">            <span class="com"># If any reading has more than one relation pointing to it, then the intrinsic relations graph is not a forest:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t472" href="#t472">472</a></span><span class="t">            <span class="nam">excessive_in_degree_readings</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t473" href="#t473">473</a></span><span class="t">                <span class="nam">rdg_id</span> <span class="key">for</span> <span class="nam">rdg_id</span> <span class="key">in</span> <span class="nam">in_degree_by_reading</span> <span class="key">if</span> <span class="nam">in_degree_by_reading</span><span class="op">[</span><span class="nam">rdg_id</span><span class="op">]</span> <span class="op">></span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t474" href="#t474">474</a></span><span class="t">            <span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t475" href="#t475">475</a></span><span class="t">            <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">excessive_in_degree_readings</span><span class="op">)</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t476" href="#t476">476</a></span><span class="t">                <span class="nam">msg</span> <span class="op">=</span> <span class="str">""</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t477" href="#t477">477</a></span><span class="t">                <span class="nam">msg</span> <span class="op">+=</span> <span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t478" href="#t478">478</a></span><span class="t">                    <span class="str">"In variation unit %s, the following readings have more than one intrinsic relation pointing to them: %s.\n"</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t479" href="#t479">479</a></span><span class="t">                    <span class="op">%</span> <span class="op">(</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="str">", "</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="nam">excessive_in_degree_readings</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t480" href="#t480">480</a></span><span class="t">                <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t481" href="#t481">481</a></span><span class="t">                <span class="nam">msg</span> <span class="op">+=</span> <span class="str">"Please ensure that at least one reading has no relations pointing to it and that every reading has no more than one relation pointing to it."</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t482" href="#t482">482</a></span><span class="t">                <span class="key">raise</span> <span class="nam">IntrinsicRelationsException</span><span class="op">(</span><span class="nam">msg</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t483" href="#t483">483</a></span><span class="t">            <span class="com"># If every reading has another reading pointing to it, then the intrinsic relations graph contains a cycle and is not a forest:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t484" href="#t484">484</a></span><span class="t">            <span class="nam">starting_nodes</span> <span class="op">=</span> <span class="op">[</span><span class="nam">rdg_id</span> <span class="key">for</span> <span class="nam">rdg_id</span> <span class="key">in</span> <span class="nam">in_degree_by_reading</span> <span class="key">if</span> <span class="nam">in_degree_by_reading</span><span class="op">[</span><span class="nam">rdg_id</span><span class="op">]</span> <span class="op">==</span> <span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t485" href="#t485">485</a></span><span class="t">            <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">starting_nodes</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t486" href="#t486">486</a></span><span class="t">                <span class="nam">msg</span> <span class="op">=</span> <span class="str">""</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t487" href="#t487">487</a></span><span class="t">                <span class="nam">msg</span> <span class="op">+=</span> <span class="str">"In variation unit %s, the intrinsic relations contain a cycle.\n"</span> <span class="op">%</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t488" href="#t488">488</a></span><span class="t">                <span class="nam">msg</span> <span class="op">+=</span> <span class="str">"Please ensure that at least one reading has no relations pointing to it and that every reading has no more than one relation pointing to it."</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t489" href="#t489">489</a></span><span class="t">                <span class="key">raise</span> <span class="nam">IntrinsicRelationsException</span><span class="op">(</span><span class="nam">msg</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t490" href="#t490">490</a></span><span class="t">        <span class="nam">t1</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t491" href="#t491">491</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t492" href="#t492">492</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"Finished intrinsic relations validation in %0.4fs."</span> <span class="op">%</span> <span class="op">(</span><span class="nam">t1</span> <span class="op">-</span> <span class="nam">t0</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t493" href="#t493">493</a></span><span class="t">        <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t494" href="#t494">494</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t495" href="#t495">495</a></span><span class="t">    <span class="key">def</span> <span class="nam">parse_apps</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">xml</span><span class="op">:</span> <span class="nam">et</span><span class="op">.</span><span class="nam">ElementTree</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t496" href="#t496">496</a></span><span class="t">        <span class="str">"""Given an XML tree for a collation, populates its list of variation units from its app elements.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t497" href="#t497">497</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t498" href="#t498">498</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t499" href="#t499">499</a></span><span class="t"><span class="str">            xml: An lxml.etree.ElementTree representing an XML tree rooted at a TEI element.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t500" href="#t500">500</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t501" href="#t501">501</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t502" href="#t502">502</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"Parsing variation units..."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t503" href="#t503">503</a></span><span class="t">        <span class="nam">t0</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t504" href="#t504">504</a></span><span class="t">        <span class="key">for</span> <span class="nam">a</span> <span class="key">in</span> <span class="nam">xml</span><span class="op">.</span><span class="nam">xpath</span><span class="op">(</span><span class="str">'//tei:app'</span><span class="op">,</span> <span class="nam">namespaces</span><span class="op">=</span><span class="op">{</span><span class="str">'tei'</span><span class="op">:</span> <span class="nam">tei_ns</span><span class="op">}</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t505" href="#t505">505</a></span><span class="t">            <span class="nam">vu</span> <span class="op">=</span> <span class="nam">VariationUnit</span><span class="op">(</span><span class="nam">a</span><span class="op">,</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t506" href="#t506">506</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">variation_units</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">vu</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t507" href="#t507">507</a></span><span class="t">        <span class="nam">t1</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t508" href="#t508">508</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t509" href="#t509">509</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"Finished processing %d variation units in %0.4fs."</span> <span class="op">%</span> <span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">variation_units</span><span class="op">)</span><span class="op">,</span> <span class="nam">t1</span> <span class="op">-</span> <span class="nam">t0</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t510" href="#t510">510</a></span><span class="t">        <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t511" href="#t511">511</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t512" href="#t512">512</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_readings_by_witness_for_unit</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">vu</span><span class="op">:</span> <span class="nam">VariationUnit</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t513" href="#t513">513</a></span><span class="t">        <span class="str">"""Returns a dictionary mapping witness IDs to a list of their reading coefficients for a given variation unit.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t514" href="#t514">514</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t515" href="#t515">515</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t516" href="#t516">516</a></span><span class="t"><span class="str">            vu: A VariationUnit to be processed.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t517" href="#t517">517</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t518" href="#t518">518</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t519" href="#t519">519</a></span><span class="t"><span class="str">            A dictionary mapping witness ID strings to a list of their coefficients for all substantive readings in this VariationUnit.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t520" href="#t520">520</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t521" href="#t521">521</a></span><span class="t">        <span class="com"># In a first pass, populate lists of substantive (variation unit ID, reading ID) tuples and reading labels</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t522" href="#t522">522</a></span><span class="t">        <span class="com"># and a map from reading IDs to the indices of their parent substantive reading in this unit:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t523" href="#t523">523</a></span><span class="t">        <span class="nam">reading_id_to_index</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t524" href="#t524">524</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t525" href="#t525">525</a></span><span class="t">        <span class="key">for</span> <span class="nam">rdg</span> <span class="key">in</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">readings</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t526" href="#t526">526</a></span><span class="t">            <span class="com"># If this reading is missing (e.g., lacunose or inapplicable due to an overlapping variant) or targets another reading, then skip it:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t527" href="#t527">527</a></span><span class="t">            <span class="key">if</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">type</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">missing_reading_types</span> <span class="key">or</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg</span><span class="op">.</span><span class="nam">certainties</span><span class="op">)</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t528" href="#t528">528</a></span><span class="t">                <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t529" href="#t529">529</a></span><span class="t">            <span class="com"># If this reading is trivial, then map it to the last substantive index:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t530" href="#t530">530</a></span><span class="t">            <span class="key">if</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">type</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">trivial_reading_types</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t531" href="#t531">531</a></span><span class="t">                <span class="nam">reading_id_to_index</span><span class="op">[</span><span class="nam">rdg</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span> <span class="op">=</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t532" href="#t532">532</a></span><span class="t">                <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t533" href="#t533">533</a></span><span class="t">            <span class="com"># Otherwise, the reading is substantive: add it to the map and update the last substantive index:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t534" href="#t534">534</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">rdg</span><span class="op">.</span><span class="nam">id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t535" href="#t535">535</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">substantive_variation_unit_reading_tuples</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">tuple</span><span class="op">(</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t536" href="#t536">536</a></span><span class="t">            <span class="nam">reading_id_to_index</span><span class="op">[</span><span class="nam">rdg</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span> <span class="op">=</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t537" href="#t537">537</a></span><span class="t">        <span class="com"># If the list of substantive readings only contains one entry, then this variation unit is not informative;</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t538" href="#t538">538</a></span><span class="t">        <span class="com"># return an empty dictionary and add nothing to the list of substantive reading labels:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t539" href="#t539">539</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t540" href="#t540">540</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t541" href="#t541">541</a></span><span class="t">                <span class="str">"Variation unit %s has %d substantive readings."</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t542" href="#t542">542</a></span><span class="t">                <span class="op">%</span> <span class="op">(</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t543" href="#t543">543</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t544" href="#t544">544</a></span><span class="t">        <span class="nam">readings_by_witness_for_unit</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t545" href="#t545">545</a></span><span class="t">        <span class="com"># Initialize the output dictionary with empty sets for all base witnesses:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t546" href="#t546">546</a></span><span class="t">        <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t547" href="#t547">547</a></span><span class="t">            <span class="nam">readings_by_witness_for_unit</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span> <span class="op">=</span> <span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="op">*</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t548" href="#t548">548</a></span><span class="t">        <span class="com"># In a second pass, assign each base witness a set containing the readings it supports in this unit:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t549" href="#t549">549</a></span><span class="t">        <span class="key">for</span> <span class="nam">rdg</span> <span class="key">in</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">readings</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t550" href="#t550">550</a></span><span class="t">            <span class="com"># Initialize the dictionary indicating support for this reading (or its disambiguations):</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t551" href="#t551">551</a></span><span class="t">            <span class="nam">rdg_support</span> <span class="op">=</span> <span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="op">*</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t552" href="#t552">552</a></span><span class="t">            <span class="com"># If this is a missing reading (e.g., a lacuna or an overlap), then we can skip it, as its corresponding set will be empty:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t553" href="#t553">553</a></span><span class="t">            <span class="key">if</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">type</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">missing_reading_types</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t554" href="#t554">554</a></span><span class="t">                <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t555" href="#t555">555</a></span><span class="t">            <span class="com"># Otherwise, if this reading is trivial, then it will contain an entry for the index of its parent substantive reading:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t556" href="#t556">556</a></span><span class="t">            <span class="key">elif</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">type</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">trivial_reading_types</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t557" href="#t557">557</a></span><span class="t">                <span class="nam">rdg_support</span><span class="op">[</span><span class="nam">reading_id_to_index</span><span class="op">[</span><span class="nam">rdg</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t558" href="#t558">558</a></span><span class="t">            <span class="com"># Otherwise, if this reading has one or more nonzero certainty degrees,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t559" href="#t559">559</a></span><span class="t">            <span class="com"># then set the entries for these readings to their degrees:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t560" href="#t560">560</a></span><span class="t">            <span class="key">elif</span> <span class="nam">sum</span><span class="op">(</span><span class="nam">rdg</span><span class="op">.</span><span class="nam">certainties</span><span class="op">.</span><span class="nam">values</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t561" href="#t561">561</a></span><span class="t">                <span class="key">for</span> <span class="nam">t</span> <span class="key">in</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">certainties</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t562" href="#t562">562</a></span><span class="t">                    <span class="com"># Skip any reading whose ID is unrecognized in this unit:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t563" href="#t563">563</a></span><span class="t">                    <span class="key">if</span> <span class="nam">t</span> <span class="key">in</span> <span class="nam">reading_id_to_index</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t564" href="#t564">564</a></span><span class="t">                        <span class="nam">rdg_support</span><span class="op">[</span><span class="nam">reading_id_to_index</span><span class="op">[</span><span class="nam">t</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">certainties</span><span class="op">[</span><span class="nam">t</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t565" href="#t565">565</a></span><span class="t">            <span class="com"># Otherwise, if this reading has one or more targets (i.e., if it is an ambiguous reading),</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t566" href="#t566">566</a></span><span class="t">            <span class="com"># then set the entries for each of its targets to 1:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t567" href="#t567">567</a></span><span class="t">            <span class="key">elif</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg</span><span class="op">.</span><span class="nam">targets</span><span class="op">)</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t568" href="#t568">568</a></span><span class="t">                <span class="key">for</span> <span class="nam">t</span> <span class="key">in</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">targets</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t569" href="#t569">569</a></span><span class="t">                    <span class="com"># Skip any reading whose ID is unrecognized in this unit:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t570" href="#t570">570</a></span><span class="t">                    <span class="key">if</span> <span class="nam">t</span> <span class="key">in</span> <span class="nam">reading_id_to_index</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t571" href="#t571">571</a></span><span class="t">                        <span class="nam">rdg_support</span><span class="op">[</span><span class="nam">reading_id_to_index</span><span class="op">[</span><span class="nam">t</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t572" href="#t572">572</a></span><span class="t">            <span class="com"># Otherwise, this reading is itself substantive; set the entry for the index of this reading to 1:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t573" href="#t573">573</a></span><span class="t">            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t574" href="#t574">574</a></span><span class="t">                <span class="nam">rdg_support</span><span class="op">[</span><span class="nam">reading_id_to_index</span><span class="op">[</span><span class="nam">rdg</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t575" href="#t575">575</a></span><span class="t">            <span class="com"># Proceed for each witness siglum in the support for this reading:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t576" href="#t576">576</a></span><span class="t">            <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">wits</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t577" href="#t577">577</a></span><span class="t">                <span class="com"># Is this siglum a base siglum?</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t578" href="#t578">578</a></span><span class="t">                <span class="nam">base_wit</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_base_wit</span><span class="op">(</span><span class="nam">wit</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t579" href="#t579">579</a></span><span class="t">                <span class="key">if</span> <span class="nam">base_wit</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witness_index_by_id</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t580" href="#t580">580</a></span><span class="t">                    <span class="com"># If it is not, then it is probably just because we've encountered a corrector or some other secondary witness not included in the witness list;</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t581" href="#t581">581</a></span><span class="t">                    <span class="com"># report this if we're in verbose mode and move on:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t582" href="#t582">582</a></span><span class="t">                    <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t583" href="#t583">583</a></span><span class="t">                        <span class="nam">print</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t584" href="#t584">584</a></span><span class="t">                            <span class="str">"Skipping unknown witness siglum %s (base siglum %s) in variation unit %s, reading %s..."</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t585" href="#t585">585</a></span><span class="t">                            <span class="op">%</span> <span class="op">(</span><span class="nam">wit</span><span class="op">,</span> <span class="nam">base_wit</span><span class="op">,</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t586" href="#t586">586</a></span><span class="t">                        <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t587" href="#t587">587</a></span><span class="t">                    <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t588" href="#t588">588</a></span><span class="t">                <span class="com"># If we've found a base siglum, then add this reading's contribution to the base witness's reading set for this unit;</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t589" href="#t589">589</a></span><span class="t">                <span class="com"># normally the existing set will be empty, but if we reduce two suffixed sigla to the same base witness,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t590" href="#t590">590</a></span><span class="t">                <span class="com"># then that witness may attest to multiple readings in the same unit:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t591" href="#t591">591</a></span><span class="t">                <span class="nam">readings_by_witness_for_unit</span><span class="op">[</span><span class="nam">base_wit</span><span class="op">]</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t592" href="#t592">592</a></span><span class="t">                    <span class="op">(</span><span class="nam">min</span><span class="op">(</span><span class="nam">readings_by_witness_for_unit</span><span class="op">[</span><span class="nam">base_wit</span><span class="op">]</span><span class="op">[</span><span class="nam">i</span><span class="op">]</span> <span class="op">+</span> <span class="nam">rdg_support</span><span class="op">[</span><span class="nam">i</span><span class="op">]</span><span class="op">,</span> <span class="num">1</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t593" href="#t593">593</a></span><span class="t">                    <span class="key">for</span> <span class="nam">i</span> <span class="key">in</span> <span class="nam">range</span><span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t594" href="#t594">594</a></span><span class="t">                <span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t595" href="#t595">595</a></span><span class="t">        <span class="key">return</span> <span class="nam">readings_by_witness_for_unit</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t596" href="#t596">596</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t597" href="#t597">597</a></span><span class="t">    <span class="key">def</span> <span class="nam">parse_readings_by_witness</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t598" href="#t598">598</a></span><span class="t">        <span class="str">"""Populates the internal dictionary mapping witness IDs to a list of their reading support sets for all variation units, and then fills the empty reading support sets for witnesses of type "corrector" with the entries of the previous witness."""</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t599" href="#t599">599</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t600" href="#t600">600</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"Populating internal dictionary of witness readings..."</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t601" href="#t601">601</a></span><span class="t">        <span class="nam">t0</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t602" href="#t602">602</a></span><span class="t">        <span class="com"># Initialize the data structures to be populated here:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t603" href="#t603">603</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t604" href="#t604">604</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t605" href="#t605">605</a></span><span class="t">        <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t606" href="#t606">606</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t607" href="#t607">607</a></span><span class="t">        <span class="com"># Populate them for each variation unit:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t608" href="#t608">608</a></span><span class="t">        <span class="key">for</span> <span class="nam">vu</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_units</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t609" href="#t609">609</a></span><span class="t">            <span class="nam">readings_by_witness_for_unit</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_readings_by_witness_for_unit</span><span class="op">(</span><span class="nam">vu</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t610" href="#t610">610</a></span><span class="t">            <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">readings_by_witness_for_unit</span><span class="op">)</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t611" href="#t611">611</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t612" href="#t612">612</a></span><span class="t">            <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">readings_by_witness_for_unit</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t613" href="#t613">613</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit</span><span class="op">]</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">readings_by_witness_for_unit</span><span class="op">[</span><span class="nam">wit</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t614" href="#t614">614</a></span><span class="t">        <span class="com"># Optionally, fill the lacunae of the correctors:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t615" href="#t615">615</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">fill_corrector_lacunae</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t616" href="#t616">616</a></span><span class="t">            <span class="key">for</span> <span class="nam">i</span><span class="op">,</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t617" href="#t617">617</a></span><span class="t">                <span class="com"># If this is the first witness, then it shouldn't be a corrector (since there is no previous witness against which to compare it):</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t618" href="#t618">618</a></span><span class="t">                <span class="key">if</span> <span class="nam">i</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t619" href="#t619">619</a></span><span class="t">                    <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t620" href="#t620">620</a></span><span class="t">                <span class="com"># Otherwise, if this witness is not a corrector, then skip it:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t621" href="#t621">621</a></span><span class="t">                <span class="key">if</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">type</span> <span class="op">!=</span> <span class="str">"corrector"</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t622" href="#t622">622</a></span><span class="t">                    <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t623" href="#t623">623</a></span><span class="t">                <span class="com"># Otherwise, retrieve the previous witness:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t624" href="#t624">624</a></span><span class="t">                <span class="nam">prev_wit</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">[</span><span class="nam">i</span> <span class="op">-</span> <span class="num">1</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t625" href="#t625">625</a></span><span class="t">                <span class="key">for</span> <span class="nam">j</span> <span class="key">in</span> <span class="nam">range</span><span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t626" href="#t626">626</a></span><span class="t">                    <span class="com"># If the corrector has no reading, then set it to the previous witness's reading:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t627" href="#t627">627</a></span><span class="t">                    <span class="key">if</span> <span class="nam">sum</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">[</span><span class="nam">j</span><span class="op">]</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t628" href="#t628">628</a></span><span class="t">                        <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">[</span><span class="nam">j</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">prev_wit</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">[</span><span class="nam">j</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t629" href="#t629">629</a></span><span class="t">        <span class="nam">t1</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t630" href="#t630">630</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t631" href="#t631">631</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t632" href="#t632">632</a></span><span class="t">                <span class="str">"Populated dictionary for %d witnesses over %d substantive variation units in %0.4fs."</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t633" href="#t633">633</a></span><span class="t">                <span class="op">%</span> <span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span><span class="op">,</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span><span class="op">)</span><span class="op">,</span> <span class="nam">t1</span> <span class="op">-</span> <span class="nam">t0</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t634" href="#t634">634</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t635" href="#t635">635</a></span><span class="t">        <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t636" href="#t636">636</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t637" href="#t637">637</a></span><span class="t">    <span class="key">def</span> <span class="nam">filter_fragmentary_witnesses</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">xml</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t638" href="#t638">638</a></span><span class="t">        <span class="str">"""Filters the original witness list and readings by witness dictionary to exclude witnesses whose proportions of extant passages fall below the fragmentary readings threshold."""</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t639" href="#t639">639</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t640" href="#t640">640</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t641" href="#t641">641</a></span><span class="t">                <span class="str">"Filtering fragmentary witnesses (extant in &lt; %f of all variation units) out of internal witness list and dictionary of witness readings..."</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t642" href="#t642">642</a></span><span class="t">                <span class="op">%</span> <span class="nam">self</span><span class="op">.</span><span class="nam">fragmentary_threshold</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t643" href="#t643">643</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t644" href="#t644">644</a></span><span class="t">        <span class="nam">t0</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t645" href="#t645">645</a></span><span class="t">        <span class="nam">fragmentary_witness_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t646" href="#t646">646</a></span><span class="t">        <span class="com"># Proceed for each witness in order:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t647" href="#t647">647</a></span><span class="t">        <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t648" href="#t648">648</a></span><span class="t">            <span class="nam">wit_id</span> <span class="op">=</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t649" href="#t649">649</a></span><span class="t">            <span class="com"># We count the number of variation units at which this witness has an extant (i.e., non-missing) reading:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t650" href="#t650">650</a></span><span class="t">            <span class="nam">extant_reading_count</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t651" href="#t651">651</a></span><span class="t">            <span class="nam">total_reading_count</span> <span class="op">=</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t652" href="#t652">652</a></span><span class="t">            <span class="com"># Proceed through all reading support lists:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t653" href="#t653">653</a></span><span class="t">            <span class="key">for</span> <span class="nam">rdg_support</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit_id</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t654" href="#t654">654</a></span><span class="t">                <span class="com"># If the current reading support list is not all zeroes, then increment this witness's count of extant readings:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t655" href="#t655">655</a></span><span class="t">                <span class="key">if</span> <span class="nam">sum</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="op">!=</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t656" href="#t656">656</a></span><span class="t">                    <span class="nam">extant_reading_count</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t657" href="#t657">657</a></span><span class="t">            <span class="com"># If the proportion of extant readings falls below the threshold, then add this witness to the list of fragmentary witnesses:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t658" href="#t658">658</a></span><span class="t">            <span class="key">if</span> <span class="nam">extant_reading_count</span> <span class="op">/</span> <span class="nam">total_reading_count</span> <span class="op">&lt;</span> <span class="nam">self</span><span class="op">.</span><span class="nam">fragmentary_threshold</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t659" href="#t659">659</a></span><span class="t">                <span class="nam">fragmentary_witness_set</span><span class="op">.</span><span class="nam">add</span><span class="op">(</span><span class="nam">wit_id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t660" href="#t660">660</a></span><span class="t">        <span class="com"># Then filter the witness list to exclude the fragmentary witnesses:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t661" href="#t661">661</a></span><span class="t">        <span class="nam">filtered_witnesses</span> <span class="op">=</span> <span class="op">[</span><span class="nam">wit</span> <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span> <span class="key">if</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">id</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">fragmentary_witness_set</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t662" href="#t662">662</a></span><span class="t">        <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span> <span class="op">=</span> <span class="nam">filtered_witnesses</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t663" href="#t663">663</a></span><span class="t">        <span class="com"># Then remove the entries for the fragmentary witnesses from the witnesses-to-readings dictionary:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t664" href="#t664">664</a></span><span class="t">        <span class="key">for</span> <span class="nam">wit_id</span> <span class="key">in</span> <span class="nam">fragmentary_witness_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t665" href="#t665">665</a></span><span class="t">            <span class="key">del</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit_id</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t666" href="#t666">666</a></span><span class="t">        <span class="nam">t1</span> <span class="op">=</span> <span class="nam">time</span><span class="op">.</span><span class="nam">time</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t667" href="#t667">667</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">verbose</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t668" href="#t668">668</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t669" href="#t669">669</a></span><span class="t">                <span class="str">"Filtered out %d fragmentary witness(es) (%s) in %0.4fs."</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t670" href="#t670">670</a></span><span class="t">                <span class="op">%</span> <span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">fragmentary_witness_set</span><span class="op">)</span><span class="op">,</span> <span class="nam">str</span><span class="op">(</span><span class="nam">list</span><span class="op">(</span><span class="nam">fragmentary_witness_set</span><span class="op">)</span><span class="op">)</span><span class="op">,</span> <span class="nam">t1</span> <span class="op">-</span> <span class="nam">t0</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t671" href="#t671">671</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t672" href="#t672">672</a></span><span class="t">        <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t673" href="#t673">673</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t674" href="#t674">674</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_nexus_symbols</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t675" href="#t675">675</a></span><span class="t">        <span class="str">"""Returns a list of one-character symbols needed to represent the states of all substantive readings in NEXUS.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t676" href="#t676">676</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t677" href="#t677">677</a></span><span class="t"><span class="str">        The number of symbols equals the maximum number of substantive readings at any variation unit.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t678" href="#t678">678</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t679" href="#t679">679</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t680" href="#t680">680</a></span><span class="t"><span class="str">            A list of individual characters representing states in readings.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t681" href="#t681">681</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t682" href="#t682">682</a></span><span class="t">        <span class="com"># NOTE: IQTREE does not appear to support symbols outside of 0-9 and a-z, and its base symbols must be case-insensitive.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t683" href="#t683">683</a></span><span class="t">        <span class="com"># The official version of MrBayes is likewise limited to 32 symbols.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t684" href="#t684">684</a></span><span class="t">        <span class="com"># But PAUP* allows up to 64 symbols, and Andrew Edmondson's fork of MrBayes does, as well.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t685" href="#t685">685</a></span><span class="t">        <span class="com"># So this method will support symbols from 0-9, a-z, and A-Z (for a total of 62 states)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t686" href="#t686">686</a></span><span class="t">        <span class="nam">possible_symbols</span> <span class="op">=</span> <span class="nam">list</span><span class="op">(</span><span class="nam">string</span><span class="op">.</span><span class="nam">digits</span><span class="op">)</span> <span class="op">+</span> <span class="nam">list</span><span class="op">(</span><span class="nam">string</span><span class="op">.</span><span class="nam">ascii_lowercase</span><span class="op">)</span> <span class="op">+</span> <span class="nam">list</span><span class="op">(</span><span class="nam">string</span><span class="op">.</span><span class="nam">ascii_uppercase</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t687" href="#t687">687</a></span><span class="t">        <span class="com"># The number of symbols needed is equal to the length of the longest substantive reading vector:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t688" href="#t688">688</a></span><span class="t">        <span class="nam">nsymbols</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t689" href="#t689">689</a></span><span class="t">        <span class="com"># If there are no witnesses, then no symbols are needed at all:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t690" href="#t690">690</a></span><span class="t">        <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t691" href="#t691">691</a></span><span class="t">            <span class="key">return</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t692" href="#t692">692</a></span><span class="t">        <span class="nam">wit_id</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t693" href="#t693">693</a></span><span class="t">        <span class="key">for</span> <span class="nam">rdg_support</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit_id</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t694" href="#t694">694</a></span><span class="t">            <span class="nam">nsymbols</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span><span class="nam">nsymbols</span><span class="op">,</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t695" href="#t695">695</a></span><span class="t">        <span class="nam">nexus_symbols</span> <span class="op">=</span> <span class="nam">possible_symbols</span><span class="op">[</span><span class="op">:</span><span class="nam">nsymbols</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t696" href="#t696">696</a></span><span class="t">        <span class="key">return</span> <span class="nam">nexus_symbols</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t697" href="#t697">697</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t698" href="#t698">698</a></span><span class="t">    <span class="key">def</span> <span class="nam">to_nexus</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t699" href="#t699">699</a></span><span class="t">        <span class="nam">self</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t700" href="#t700">700</a></span><span class="t">        <span class="nam">file_addr</span><span class="op">:</span> <span class="nam">Union</span><span class="op">[</span><span class="nam">Path</span><span class="op">,</span> <span class="nam">str</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t701" href="#t701">701</a></span><span class="t">        <span class="nam">drop_constant</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t702" href="#t702">702</a></span><span class="t">        <span class="nam">char_state_labels</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">True</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t703" href="#t703">703</a></span><span class="t">        <span class="nam">frequency</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t704" href="#t704">704</a></span><span class="t">        <span class="nam">ambiguous_as_missing</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t705" href="#t705">705</a></span><span class="t">        <span class="nam">calibrate_dates</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t706" href="#t706">706</a></span><span class="t">        <span class="nam">mrbayes</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t707" href="#t707">707</a></span><span class="t">        <span class="nam">clock_model</span><span class="op">:</span> <span class="nam">ClockModel</span> <span class="op">=</span> <span class="nam">ClockModel</span><span class="op">.</span><span class="nam">strict</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t708" href="#t708">708</a></span><span class="t">    <span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t709" href="#t709">709</a></span><span class="t">        <span class="str">"""Writes this Collation to a NEXUS file with the given address.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t710" href="#t710">710</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t711" href="#t711">711</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t712" href="#t712">712</a></span><span class="t"><span class="str">            file_addr: A string representing the path to an output NEXUS file; the file type should be .nex, .nexus, or .nxs.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t713" href="#t713">713</a></span><span class="t"><span class="str">            drop_constant: An optional flag indicating whether to ignore variation units with one substantive reading.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t714" href="#t714">714</a></span><span class="t"><span class="str">            char_state_labels: An optional flag indicating whether or not to include the CharStateLabels block.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t715" href="#t715">715</a></span><span class="t"><span class="str">            frequency: An optional flag indicating whether to use the StatesFormat=Frequency setting</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t716" href="#t716">716</a></span><span class="t"><span class="str">                instead of the StatesFormat=StatesPresent setting</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t717" href="#t717">717</a></span><span class="t"><span class="str">                (and thus represent all states with frequency vectors rather than symbols).</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t718" href="#t718">718</a></span><span class="t"><span class="str">                Note that this setting is necessary to make use of certainty degrees assigned to multiple ambiguous states in the collation.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t719" href="#t719">719</a></span><span class="t"><span class="str">            ambiguous_as_missing: An optional flag indicating whether to treat all ambiguous states as missing data.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t720" href="#t720">720</a></span><span class="t"><span class="str">                If this flag is set, then only base symbols will be generated for the NEXUS file.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t721" href="#t721">721</a></span><span class="t"><span class="str">                It is only applied if the frequency option is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t722" href="#t722">722</a></span><span class="t"><span class="str">            calibrate_dates: An optional flag indicating whether to add an Assumptions block that specifies date distributions for witnesses.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t723" href="#t723">723</a></span><span class="t"><span class="str">                This option is intended for inputs to BEAST 2.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t724" href="#t724">724</a></span><span class="t"><span class="str">            mrbayes: An optional flag indicating whether to add a MrBayes block that specifies model settings and age calibrations for witnesses.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t725" href="#t725">725</a></span><span class="t"><span class="str">                This option is intended for inputs to MrBayes.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t726" href="#t726">726</a></span><span class="t"><span class="str">            clock_model: A ClockModel option indicating which type of clock model to use.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t727" href="#t727">727</a></span><span class="t"><span class="str">                This option is intended for inputs to MrBayes and BEAST 2.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t728" href="#t728">728</a></span><span class="t"><span class="str">                MrBayes does not presently support a local clock model, so it will default to a strict clock model if a local clock model is specified.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t729" href="#t729">729</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t730" href="#t730">730</a></span><span class="t">        <span class="com"># Populate a list of sites that will correspond to columns of the sequence alignment:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t731" href="#t731">731</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t732" href="#t732">732</a></span><span class="t">        <span class="key">if</span> <span class="nam">drop_constant</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t733" href="#t733">733</a></span><span class="t">            <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t734" href="#t734">734</a></span><span class="t">                <span class="nam">vu_id</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t735" href="#t735">735</a></span><span class="t">                <span class="key">for</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t736" href="#t736">736</a></span><span class="t">                <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu_id</span><span class="op">]</span><span class="op">)</span> <span class="op">></span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t737" href="#t737">737</a></span><span class="t">            <span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t738" href="#t738">738</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">substantive_variation_unit_ids</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t739" href="#t739">739</a></span><span class="t">        <span class="nam">substantive_variation_unit_reading_tuples_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_variation_unit_reading_tuples</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t740" href="#t740">740</a></span><span class="t">        <span class="com"># Start by calculating the values we will be using here:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t741" href="#t741">741</a></span><span class="t">        <span class="nam">ntax</span> <span class="op">=</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t742" href="#t742">742</a></span><span class="t">        <span class="nam">nchar</span> <span class="op">=</span> <span class="nam">len</span><span class="op">(</span><span class="nam">substantive_variation_unit_ids</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t743" href="#t743">743</a></span><span class="t">        <span class="nam">taxlabels</span> <span class="op">=</span> <span class="op">[</span><span class="nam">slugify</span><span class="op">(</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">lowercase</span><span class="op">=</span><span class="key">False</span><span class="op">,</span> <span class="nam">separator</span><span class="op">=</span><span class="str">'_'</span><span class="op">)</span> <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t744" href="#t744">744</a></span><span class="t">        <span class="nam">max_taxlabel_length</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t745" href="#t745">745</a></span><span class="t">            <span class="op">[</span><span class="nam">len</span><span class="op">(</span><span class="nam">taxlabel</span><span class="op">)</span> <span class="key">for</span> <span class="nam">taxlabel</span> <span class="key">in</span> <span class="nam">taxlabels</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t746" href="#t746">746</a></span><span class="t">        <span class="op">)</span>  <span class="com"># keep track of the longest taxon label for tabular alignment purposes</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t747" href="#t747">747</a></span><span class="t">        <span class="nam">charlabels</span> <span class="op">=</span> <span class="op">[</span><span class="nam">slugify</span><span class="op">(</span><span class="nam">vu_id</span><span class="op">,</span> <span class="nam">lowercase</span><span class="op">=</span><span class="key">False</span><span class="op">,</span> <span class="nam">separator</span><span class="op">=</span><span class="str">'_'</span><span class="op">)</span> <span class="key">for</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_ids</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t748" href="#t748">748</a></span><span class="t">        <span class="nam">missing_symbol</span> <span class="op">=</span> <span class="str">'?'</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t749" href="#t749">749</a></span><span class="t">        <span class="nam">symbols</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_nexus_symbols</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t750" href="#t750">750</a></span><span class="t">        <span class="com"># Generate all parent folders for this file that don't already exist:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t751" href="#t751">751</a></span><span class="t">        <span class="nam">Path</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">)</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">mkdir</span><span class="op">(</span><span class="nam">parents</span><span class="op">=</span><span class="key">True</span><span class="op">,</span> <span class="nam">exist_ok</span><span class="op">=</span><span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t752" href="#t752">752</a></span><span class="t">        <span class="key">with</span> <span class="nam">open</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">,</span> <span class="str">"w"</span><span class="op">,</span> <span class="nam">encoding</span><span class="op">=</span><span class="str">"utf-8"</span><span class="op">)</span> <span class="key">as</span> <span class="nam">f</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t753" href="#t753">753</a></span><span class="t">            <span class="com"># Start with the NEXUS header:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t754" href="#t754">754</a></span><span class="t">            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"#NEXUS\n\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t755" href="#t755">755</a></span><span class="t">            <span class="com"># Then begin the data block:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t756" href="#t756">756</a></span><span class="t">            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"Begin DATA;\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t757" href="#t757">757</a></span><span class="t">            <span class="com"># Write the collation matrix dimensions:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t758" href="#t758">758</a></span><span class="t">            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tDimensions ntax=%d nchar=%d;\n"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">ntax</span><span class="op">,</span> <span class="nam">nchar</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t759" href="#t759">759</a></span><span class="t">            <span class="com"># Write the format subblock:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t760" href="#t760">760</a></span><span class="t">            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tFormat\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t761" href="#t761">761</a></span><span class="t">            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\t\tDataType=Standard\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t762" href="#t762">762</a></span><span class="t">            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\t\tMissing=%s\n"</span> <span class="op">%</span> <span class="nam">missing_symbol</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t763" href="#t763">763</a></span><span class="t">            <span class="key">if</span> <span class="nam">frequency</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t764" href="#t764">764</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\t\tStatesFormat=Frequency\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t765" href="#t765">765</a></span><span class="t">            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\t\tSymbols=\"%s\";\n"</span> <span class="op">%</span> <span class="op">(</span><span class="str">" "</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="nam">symbols</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t766" href="#t766">766</a></span><span class="t">            <span class="com"># If the char_state_labels is set, then write the labels for character-state labels, with each on its own line:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t767" href="#t767">767</a></span><span class="t">            <span class="key">if</span> <span class="nam">char_state_labels</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t768" href="#t768">768</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tCharStateLabels"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t769" href="#t769">769</a></span><span class="t">                <span class="nam">vu_ind</span> <span class="op">=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t770" href="#t770">770</a></span><span class="t">                <span class="key">for</span> <span class="nam">vu</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_units</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t771" href="#t771">771</a></span><span class="t">                    <span class="key">if</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">id</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_ids_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t772" href="#t772">772</a></span><span class="t">                        <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t773" href="#t773">773</a></span><span class="t">                    <span class="key">if</span> <span class="nam">vu_ind</span> <span class="op">==</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t774" href="#t774">774</a></span><span class="t">                        <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\n\t\t%d %s /"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">vu_ind</span><span class="op">,</span> <span class="nam">slugify</span><span class="op">(</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">lowercase</span><span class="op">=</span><span class="key">False</span><span class="op">,</span> <span class="nam">separator</span><span class="op">=</span><span class="str">'_'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t775" href="#t775">775</a></span><span class="t">                    <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t776" href="#t776">776</a></span><span class="t">                        <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">",\n\t\t%d %s /"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">vu_ind</span><span class="op">,</span> <span class="nam">slugify</span><span class="op">(</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">lowercase</span><span class="op">=</span><span class="key">False</span><span class="op">,</span> <span class="nam">separator</span><span class="op">=</span><span class="str">'_'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t777" href="#t777">777</a></span><span class="t">                    <span class="nam">rdg_ind</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t778" href="#t778">778</a></span><span class="t">                    <span class="key">for</span> <span class="nam">rdg</span> <span class="key">in</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">readings</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t779" href="#t779">779</a></span><span class="t">                        <span class="nam">key</span> <span class="op">=</span> <span class="nam">tuple</span><span class="op">(</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t780" href="#t780">780</a></span><span class="t">                        <span class="key">if</span> <span class="nam">key</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_reading_tuples_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t781" href="#t781">781</a></span><span class="t">                            <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t782" href="#t782">782</a></span><span class="t">                        <span class="nam">ascii_rdg_text</span> <span class="op">=</span> <span class="nam">slugify</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t783" href="#t783">783</a></span><span class="t">                            <span class="nam">rdg</span><span class="op">.</span><span class="nam">text</span><span class="op">,</span> <span class="nam">lowercase</span><span class="op">=</span><span class="key">False</span><span class="op">,</span> <span class="nam">separator</span><span class="op">=</span><span class="str">'_'</span><span class="op">,</span> <span class="nam">replacements</span><span class="op">=</span><span class="op">[</span><span class="op">[</span><span class="str">'&#951;'</span><span class="op">,</span> <span class="str">'h'</span><span class="op">]</span><span class="op">,</span> <span class="op">[</span><span class="str">'&#969;'</span><span class="op">,</span> <span class="str">'w'</span><span class="op">]</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t784" href="#t784">784</a></span><span class="t">                        <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t785" href="#t785">785</a></span><span class="t">                        <span class="key">if</span> <span class="nam">ascii_rdg_text</span> <span class="op">==</span> <span class="str">""</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t786" href="#t786">786</a></span><span class="t">                            <span class="nam">ascii_rdg_text</span> <span class="op">=</span> <span class="str">"om."</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t787" href="#t787">787</a></span><span class="t">                        <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">" %s"</span> <span class="op">%</span> <span class="nam">ascii_rdg_text</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t788" href="#t788">788</a></span><span class="t">                        <span class="nam">rdg_ind</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t789" href="#t789">789</a></span><span class="t">                    <span class="key">if</span> <span class="nam">rdg_ind</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t790" href="#t790">790</a></span><span class="t">                        <span class="nam">vu_ind</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t791" href="#t791">791</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">";\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t792" href="#t792">792</a></span><span class="t">            <span class="com"># Write the matrix subblock:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t793" href="#t793">793</a></span><span class="t">            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tMatrix"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t794" href="#t794">794</a></span><span class="t">            <span class="key">for</span> <span class="nam">i</span><span class="op">,</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t795" href="#t795">795</a></span><span class="t">                <span class="nam">taxlabel</span> <span class="op">=</span> <span class="nam">taxlabels</span><span class="op">[</span><span class="nam">i</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t796" href="#t796">796</a></span><span class="t">                <span class="key">if</span> <span class="nam">frequency</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t797" href="#t797">797</a></span><span class="t">                    <span class="nam">sequence</span> <span class="op">=</span> <span class="str">"\n\t\t"</span> <span class="op">+</span> <span class="nam">taxlabel</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t798" href="#t798">798</a></span><span class="t">                    <span class="key">for</span> <span class="nam">j</span><span class="op">,</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t799" href="#t799">799</a></span><span class="t">                        <span class="key">if</span> <span class="nam">vu_id</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_ids_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t800" href="#t800">800</a></span><span class="t">                            <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t801" href="#t801">801</a></span><span class="t">                        <span class="nam">rdg_support</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">[</span><span class="nam">j</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t802" href="#t802">802</a></span><span class="t">                        <span class="nam">sequence</span> <span class="op">+=</span> <span class="str">"\n\t\t\t"</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t803" href="#t803">803</a></span><span class="t">                        <span class="com"># If this reading is lacunose in this witness, then use the missing character:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t804" href="#t804">804</a></span><span class="t">                        <span class="key">if</span> <span class="nam">sum</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t805" href="#t805">805</a></span><span class="t">                            <span class="nam">sequence</span> <span class="op">+=</span> <span class="nam">missing_symbol</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t806" href="#t806">806</a></span><span class="t">                            <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t807" href="#t807">807</a></span><span class="t">                        <span class="com"># Otherwise, print out its frequencies for different readings in parentheses:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t808" href="#t808">808</a></span><span class="t">                        <span class="nam">sequence</span> <span class="op">+=</span> <span class="str">"("</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t809" href="#t809">809</a></span><span class="t">                        <span class="key">for</span> <span class="nam">j</span><span class="op">,</span> <span class="nam">w</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t810" href="#t810">810</a></span><span class="t">                            <span class="nam">sequence</span> <span class="op">+=</span> <span class="str">"%s:%0.4f"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">symbols</span><span class="op">[</span><span class="nam">j</span><span class="op">]</span><span class="op">,</span> <span class="nam">w</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t811" href="#t811">811</a></span><span class="t">                            <span class="key">if</span> <span class="nam">j</span> <span class="op">&lt;</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="op">-</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t812" href="#t812">812</a></span><span class="t">                                <span class="nam">sequence</span> <span class="op">+=</span> <span class="str">" "</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t813" href="#t813">813</a></span><span class="t">                        <span class="nam">sequence</span> <span class="op">+=</span> <span class="str">")"</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t814" href="#t814">814</a></span><span class="t">                <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t815" href="#t815">815</a></span><span class="t">                    <span class="nam">sequence</span> <span class="op">=</span> <span class="str">"\n\t\t"</span> <span class="op">+</span> <span class="nam">taxlabel</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t816" href="#t816">816</a></span><span class="t">                    <span class="com"># Add enough space after this label ensure that all sequences are nicely aligned:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t817" href="#t817">817</a></span><span class="t">                    <span class="nam">sequence</span> <span class="op">+=</span> <span class="str">" "</span> <span class="op">*</span> <span class="op">(</span><span class="nam">max_taxlabel_length</span> <span class="op">-</span> <span class="nam">len</span><span class="op">(</span><span class="nam">taxlabel</span><span class="op">)</span> <span class="op">+</span> <span class="num">1</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t818" href="#t818">818</a></span><span class="t">                    <span class="key">for</span> <span class="nam">j</span><span class="op">,</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t819" href="#t819">819</a></span><span class="t">                        <span class="key">if</span> <span class="nam">vu_id</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_ids_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t820" href="#t820">820</a></span><span class="t">                            <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t821" href="#t821">821</a></span><span class="t">                        <span class="nam">rdg_support</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">[</span><span class="nam">j</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t822" href="#t822">822</a></span><span class="t">                        <span class="com"># If this reading is lacunose in this witness, then use the missing character:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t823" href="#t823">823</a></span><span class="t">                        <span class="key">if</span> <span class="nam">sum</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t824" href="#t824">824</a></span><span class="t">                            <span class="nam">sequence</span> <span class="op">+=</span> <span class="nam">missing_symbol</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t825" href="#t825">825</a></span><span class="t">                            <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t826" href="#t826">826</a></span><span class="t">                        <span class="nam">rdg_inds</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t827" href="#t827">827</a></span><span class="t">                            <span class="nam">k</span> <span class="key">for</span> <span class="nam">k</span><span class="op">,</span> <span class="nam">w</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="key">if</span> <span class="nam">w</span> <span class="op">></span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t828" href="#t828">828</a></span><span class="t">                        <span class="op">]</span>  <span class="com"># the index list consists of the indices of all readings with any degree of certainty assigned to them</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t829" href="#t829">829</a></span><span class="t">                        <span class="com"># For singleton readings, just print the symbol:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t830" href="#t830">830</a></span><span class="t">                        <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg_inds</span><span class="op">)</span> <span class="op">==</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t831" href="#t831">831</a></span><span class="t">                            <span class="nam">sequence</span> <span class="op">+=</span> <span class="nam">symbols</span><span class="op">[</span><span class="nam">rdg_inds</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t832" href="#t832">832</a></span><span class="t">                            <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t833" href="#t833">833</a></span><span class="t">                        <span class="com"># For multiple readings, print the corresponding readings in braces or the missing symbol depending on input settings:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t834" href="#t834">834</a></span><span class="t">                        <span class="key">if</span> <span class="nam">ambiguous_as_missing</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t835" href="#t835">835</a></span><span class="t">                            <span class="nam">sequence</span> <span class="op">+=</span> <span class="nam">missing_symbol</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t836" href="#t836">836</a></span><span class="t">                        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t837" href="#t837">837</a></span><span class="t">                            <span class="nam">sequence</span> <span class="op">+=</span> <span class="str">"{%s}"</span> <span class="op">%</span> <span class="str">""</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="op">[</span><span class="nam">str</span><span class="op">(</span><span class="nam">rdg_ind</span><span class="op">)</span> <span class="key">for</span> <span class="nam">rdg_ind</span> <span class="key">in</span> <span class="nam">rdg_inds</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t838" href="#t838">838</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"%s"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">sequence</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t839" href="#t839">839</a></span><span class="t">            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">";\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t840" href="#t840">840</a></span><span class="t">            <span class="com"># End the data block:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t841" href="#t841">841</a></span><span class="t">            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"End;"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t842" href="#t842">842</a></span><span class="t">            <span class="com"># If calibrate_dates is set, then add the assumptions block:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t843" href="#t843">843</a></span><span class="t">            <span class="key">if</span> <span class="nam">calibrate_dates</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t844" href="#t844">844</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\n\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t845" href="#t845">845</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"Begin ASSUMPTIONS;\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t846" href="#t846">846</a></span><span class="t">                <span class="com"># Set the scale to years:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t847" href="#t847">847</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tOPTIONS SCALE = years;\n\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t848" href="#t848">848</a></span><span class="t">                <span class="com"># Then calibrate the witness ages:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t849" href="#t849">849</a></span><span class="t">                <span class="nam">calibrate_strings</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t850" href="#t850">850</a></span><span class="t">                <span class="key">for</span> <span class="nam">i</span><span class="op">,</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t851" href="#t851">851</a></span><span class="t">                    <span class="nam">taxlabel</span> <span class="op">=</span> <span class="nam">taxlabels</span><span class="op">[</span><span class="nam">i</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t852" href="#t852">852</a></span><span class="t">                    <span class="nam">date_range</span> <span class="op">=</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t853" href="#t853">853</a></span><span class="t">                    <span class="key">if</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t854" href="#t854">854</a></span><span class="t">                        <span class="com"># If there is a lower bound on the witness's date, then use either a fixed or uniform distribution,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t855" href="#t855">855</a></span><span class="t">                        <span class="com"># depending on whether the upper and lower bounds match:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t856" href="#t856">856</a></span><span class="t">                        <span class="nam">min_age</span> <span class="op">=</span> <span class="nam">datetime</span><span class="op">.</span><span class="nam">now</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">year</span> <span class="op">-</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t857" href="#t857">857</a></span><span class="t">                        <span class="nam">max_age</span> <span class="op">=</span> <span class="nam">datetime</span><span class="op">.</span><span class="nam">now</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">year</span> <span class="op">-</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t858" href="#t858">858</a></span><span class="t">                        <span class="key">if</span> <span class="nam">min_age</span> <span class="op">==</span> <span class="nam">max_age</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t859" href="#t859">859</a></span><span class="t">                            <span class="nam">calibrate_string</span> <span class="op">=</span> <span class="str">"\tCALIBRATE %s = fixed(%d)"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">taxlabel</span><span class="op">,</span> <span class="nam">min_age</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t860" href="#t860">860</a></span><span class="t">                            <span class="nam">calibrate_strings</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">calibrate_string</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t861" href="#t861">861</a></span><span class="t">                        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t862" href="#t862">862</a></span><span class="t">                            <span class="nam">calibrate_string</span> <span class="op">=</span> <span class="str">"\tCALIBRATE %s = uniform(%d,%d)"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">taxlabel</span><span class="op">,</span> <span class="nam">min_age</span><span class="op">,</span> <span class="nam">max_age</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t863" href="#t863">863</a></span><span class="t">                            <span class="nam">calibrate_strings</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">calibrate_string</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t864" href="#t864">864</a></span><span class="t">                    <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t865" href="#t865">865</a></span><span class="t">                        <span class="com"># If there is no lower bound on the witness's date, then use an offset log-normal distribution:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t866" href="#t866">866</a></span><span class="t">                        <span class="nam">min_age</span> <span class="op">=</span> <span class="nam">datetime</span><span class="op">.</span><span class="nam">now</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">year</span> <span class="op">-</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t867" href="#t867">867</a></span><span class="t">                        <span class="nam">calibrate_string</span> <span class="op">=</span> <span class="str">"\tCALIBRATE %s = offsetlognormal(%d,0.0,1.0)"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">taxlabel</span><span class="op">,</span> <span class="nam">min_age</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t868" href="#t868">868</a></span><span class="t">                        <span class="nam">calibrate_strings</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">calibrate_string</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t869" href="#t869">869</a></span><span class="t">                <span class="com"># Then print the calibrate strings, separated by commas and line breaks and terminated by a semicolon:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t870" href="#t870">870</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"%s;\n\n"</span> <span class="op">%</span> <span class="str">",\n"</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="nam">calibrate_strings</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t871" href="#t871">871</a></span><span class="t">                <span class="com"># End the assumptions block:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t872" href="#t872">872</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"End;"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t873" href="#t873">873</a></span><span class="t">            <span class="com"># If mrbayes is set, then add the mrbayes block:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t874" href="#t874">874</a></span><span class="t">            <span class="key">if</span> <span class="nam">mrbayes</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t875" href="#t875">875</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\n\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t876" href="#t876">876</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"Begin MRBAYES;\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t877" href="#t877">877</a></span><span class="t">                <span class="com"># Turn on the autoclose feature by default:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t878" href="#t878">878</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tset autoclose=yes;\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t879" href="#t879">879</a></span><span class="t">                <span class="com"># Set the branch lengths to be governed by a birth-death clock model, and set up the parameters for this model:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t880" href="#t880">880</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t881" href="#t881">881</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tprset brlenspr = clock:birthdeath;\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t882" href="#t882">882</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tprset speciationpr = uniform(0.0,10.0);\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t883" href="#t883">883</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tprset extinctionpr = beta(2.0,4.0);\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t884" href="#t884">884</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tprset sampleprob = 0.01;\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t885" href="#t885">885</a></span><span class="t">                <span class="com"># Use the specified clock model:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t886" href="#t886">886</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t887" href="#t887">887</a></span><span class="t">                <span class="key">if</span> <span class="nam">clock_model</span> <span class="op">==</span> <span class="nam">clock_model</span><span class="op">.</span><span class="nam">uncorrelated</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t888" href="#t888">888</a></span><span class="t">                    <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tprset clockvarpr=igr;\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t889" href="#t889">889</a></span><span class="t">                    <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tprset clockratepr=lognormal(0.0,1.0);\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t890" href="#t890">890</a></span><span class="t">                    <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tprset igrvarpr=exponential(1.0);\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t891" href="#t891">891</a></span><span class="t">                <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t892" href="#t892">892</a></span><span class="t">                    <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tprset clockvarpr=strict;\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t893" href="#t893">893</a></span><span class="t">                    <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tprset clockratepr=lognormal(0.0,1.0);\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t894" href="#t894">894</a></span><span class="t">                <span class="com"># Set the priors on the tree age depending on the date range for the origin of the collated work:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t895" href="#t895">895</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t896" href="#t896">896</a></span><span class="t">                <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t897" href="#t897">897</a></span><span class="t">                    <span class="nam">min_tree_age</span> <span class="op">=</span> <span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t898" href="#t898">898</a></span><span class="t">                        <span class="nam">datetime</span><span class="op">.</span><span class="nam">now</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">year</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t899" href="#t899">899</a></span><span class="t">                        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t900" href="#t900">900</a></span><span class="t">                        <span class="key">else</span> <span class="num">0.0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t901" href="#t901">901</a></span><span class="t">                    <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t902" href="#t902">902</a></span><span class="t">                    <span class="nam">max_tree_age</span> <span class="op">=</span> <span class="nam">datetime</span><span class="op">.</span><span class="nam">now</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">year</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t903" href="#t903">903</a></span><span class="t">                    <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tprset treeagepr = uniform(%d,%d);\n"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">min_tree_age</span><span class="op">,</span> <span class="nam">max_tree_age</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t904" href="#t904">904</a></span><span class="t">                <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t905" href="#t905">905</a></span><span class="t">                    <span class="nam">min_tree_age</span> <span class="op">=</span> <span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t906" href="#t906">906</a></span><span class="t">                        <span class="nam">datetime</span><span class="op">.</span><span class="nam">now</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">year</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t907" href="#t907">907</a></span><span class="t">                        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t908" href="#t908">908</a></span><span class="t">                        <span class="key">else</span> <span class="num">0.0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t909" href="#t909">909</a></span><span class="t">                    <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t910" href="#t910">910</a></span><span class="t">                    <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tprset treeagepr = offsetgamma(%d,1.0,1.0);\n"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">min_tree_age</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t911" href="#t911">911</a></span><span class="t">                <span class="com"># Then calibrate the witness ages:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t912" href="#t912">912</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t913" href="#t913">913</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tprset nodeagepr = calibrated;\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t914" href="#t914">914</a></span><span class="t">                <span class="key">for</span> <span class="nam">i</span><span class="op">,</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t915" href="#t915">915</a></span><span class="t">                    <span class="nam">taxlabel</span> <span class="op">=</span> <span class="nam">taxlabels</span><span class="op">[</span><span class="nam">i</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t916" href="#t916">916</a></span><span class="t">                    <span class="nam">date_range</span> <span class="op">=</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t917" href="#t917">917</a></span><span class="t">                    <span class="key">if</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t918" href="#t918">918</a></span><span class="t">                        <span class="com"># If there is a lower bound on the witness's date, then use either a fixed or uniform distribution,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t919" href="#t919">919</a></span><span class="t">                        <span class="com"># depending on whether the upper and lower bounds match:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t920" href="#t920">920</a></span><span class="t">                        <span class="nam">min_age</span> <span class="op">=</span> <span class="nam">datetime</span><span class="op">.</span><span class="nam">now</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">year</span> <span class="op">-</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t921" href="#t921">921</a></span><span class="t">                        <span class="nam">max_age</span> <span class="op">=</span> <span class="nam">datetime</span><span class="op">.</span><span class="nam">now</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">year</span> <span class="op">-</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t922" href="#t922">922</a></span><span class="t">                        <span class="key">if</span> <span class="nam">min_age</span> <span class="op">==</span> <span class="nam">max_age</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t923" href="#t923">923</a></span><span class="t">                            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tcalibrate %s = fixed(%d);\n"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">taxlabel</span><span class="op">,</span> <span class="nam">min_age</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t924" href="#t924">924</a></span><span class="t">                        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t925" href="#t925">925</a></span><span class="t">                            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tcalibrate %s = uniform(%d,%d);\n"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">taxlabel</span><span class="op">,</span> <span class="nam">min_age</span><span class="op">,</span> <span class="nam">max_age</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t926" href="#t926">926</a></span><span class="t">                    <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t927" href="#t927">927</a></span><span class="t">                        <span class="com"># If there is no lower bound on the witness's date, then use an offset gamma distribution:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t928" href="#t928">928</a></span><span class="t">                        <span class="nam">min_age</span> <span class="op">=</span> <span class="nam">datetime</span><span class="op">.</span><span class="nam">now</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="nam">year</span> <span class="op">-</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t929" href="#t929">929</a></span><span class="t">                        <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tcalibrate %s = offsetgamma(%d,1.0,1.0);\n"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">taxlabel</span><span class="op">,</span> <span class="nam">min_age</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t930" href="#t930">930</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t931" href="#t931">931</a></span><span class="t">                <span class="com"># Add default settings for MCMC estimation of posterior distribution:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t932" href="#t932">932</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tmcmcp ngen=100000;\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t933" href="#t933">933</a></span><span class="t">                <span class="com"># Write the command to run MrBayes:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t934" href="#t934">934</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\tmcmc;\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t935" href="#t935">935</a></span><span class="t">                <span class="com"># End the assumptions block:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t936" href="#t936">936</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"End;"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t937" href="#t937">937</a></span><span class="t">        <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t938" href="#t938">938</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t939" href="#t939">939</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_hennig86_symbols</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t940" href="#t940">940</a></span><span class="t">        <span class="str">"""Returns a list of one-character symbols needed to represent the states of all substantive readings in Hennig86 format.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t941" href="#t941">941</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t942" href="#t942">942</a></span><span class="t"><span class="str">        The number of symbols equals the maximum number of substantive readings at any variation unit.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t943" href="#t943">943</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t944" href="#t944">944</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t945" href="#t945">945</a></span><span class="t"><span class="str">            A list of individual characters representing states in readings.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t946" href="#t946">946</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t947" href="#t947">947</a></span><span class="t">        <span class="nam">possible_symbols</span> <span class="op">=</span> <span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t948" href="#t948">948</a></span><span class="t">            <span class="nam">list</span><span class="op">(</span><span class="nam">string</span><span class="op">.</span><span class="nam">digits</span><span class="op">)</span> <span class="op">+</span> <span class="nam">list</span><span class="op">(</span><span class="nam">string</span><span class="op">.</span><span class="nam">ascii_uppercase</span><span class="op">)</span><span class="op">[</span><span class="op">:</span><span class="num">22</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t949" href="#t949">949</a></span><span class="t">        <span class="op">)</span>  <span class="com"># NOTE: the maximum number of symbols allowed in Hennig86 format is 32</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t950" href="#t950">950</a></span><span class="t">        <span class="com"># The number of symbols needed is equal to the length of the longest substantive reading vector:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t951" href="#t951">951</a></span><span class="t">        <span class="nam">nsymbols</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t952" href="#t952">952</a></span><span class="t">        <span class="com"># If there are no witnesses, then no symbols are needed at all:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t953" href="#t953">953</a></span><span class="t">        <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t954" href="#t954">954</a></span><span class="t">            <span class="key">return</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t955" href="#t955">955</a></span><span class="t">        <span class="nam">wit_id</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t956" href="#t956">956</a></span><span class="t">        <span class="key">for</span> <span class="nam">rdg_support</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit_id</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t957" href="#t957">957</a></span><span class="t">            <span class="nam">nsymbols</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span><span class="nam">nsymbols</span><span class="op">,</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t958" href="#t958">958</a></span><span class="t">        <span class="nam">hennig86_symbols</span> <span class="op">=</span> <span class="nam">possible_symbols</span><span class="op">[</span><span class="op">:</span><span class="nam">nsymbols</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t959" href="#t959">959</a></span><span class="t">        <span class="key">return</span> <span class="nam">hennig86_symbols</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t960" href="#t960">960</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t961" href="#t961">961</a></span><span class="t">    <span class="key">def</span> <span class="nam">to_hennig86</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">file_addr</span><span class="op">:</span> <span class="nam">Union</span><span class="op">[</span><span class="nam">Path</span><span class="op">,</span> <span class="nam">str</span><span class="op">]</span><span class="op">,</span> <span class="nam">drop_constant</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t962" href="#t962">962</a></span><span class="t">        <span class="str">"""Writes this Collation to a file in Hennig86 format with the given address.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t963" href="#t963">963</a></span><span class="t"><span class="str">        Note that because Hennig86 format does not support NEXUS-style ambiguities, such ambiguities will be treated as missing data.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t964" href="#t964">964</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t965" href="#t965">965</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t966" href="#t966">966</a></span><span class="t"><span class="str">            file_addr: A string representing the path to an output file.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t967" href="#t967">967</a></span><span class="t"><span class="str">            drop_constant (bool, optional): An optional flag indicating whether to ignore variation units with one substantive reading.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t968" href="#t968">968</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t969" href="#t969">969</a></span><span class="t">        <span class="com"># Populate a list of sites that will correspond to columns of the sequence alignment:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t970" href="#t970">970</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t971" href="#t971">971</a></span><span class="t">        <span class="key">if</span> <span class="nam">drop_constant</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t972" href="#t972">972</a></span><span class="t">            <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t973" href="#t973">973</a></span><span class="t">                <span class="nam">vu_id</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t974" href="#t974">974</a></span><span class="t">                <span class="key">for</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t975" href="#t975">975</a></span><span class="t">                <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu_id</span><span class="op">]</span><span class="op">)</span> <span class="op">></span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t976" href="#t976">976</a></span><span class="t">            <span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t977" href="#t977">977</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">substantive_variation_unit_ids</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t978" href="#t978">978</a></span><span class="t">        <span class="nam">substantive_variation_unit_reading_tuples_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_variation_unit_reading_tuples</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t979" href="#t979">979</a></span><span class="t">        <span class="com"># Start by calculating the values we will be using here:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t980" href="#t980">980</a></span><span class="t">        <span class="nam">ntax</span> <span class="op">=</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t981" href="#t981">981</a></span><span class="t">        <span class="nam">nchar</span> <span class="op">=</span> <span class="nam">len</span><span class="op">(</span><span class="nam">substantive_variation_unit_ids</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t982" href="#t982">982</a></span><span class="t">        <span class="nam">taxlabels</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t983" href="#t983">983</a></span><span class="t">        <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t984" href="#t984">984</a></span><span class="t">            <span class="nam">taxlabel</span> <span class="op">=</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t985" href="#t985">985</a></span><span class="t">            <span class="com"># Hennig86 format requires taxon names to start with a letter, so if this is not the case, then append "WIT_" to the start of the name:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t986" href="#t986">986</a></span><span class="t">            <span class="key">if</span> <span class="nam">taxlabel</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">string</span><span class="op">.</span><span class="nam">ascii_letters</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t987" href="#t987">987</a></span><span class="t">                <span class="nam">taxlabel</span> <span class="op">=</span> <span class="str">"WIT_"</span> <span class="op">+</span> <span class="nam">taxlabel</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t988" href="#t988">988</a></span><span class="t">            <span class="com"># Then replace any disallowed characters in the string with an underscore:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t989" href="#t989">989</a></span><span class="t">            <span class="nam">taxlabel</span> <span class="op">=</span> <span class="nam">slugify</span><span class="op">(</span><span class="nam">taxlabel</span><span class="op">,</span> <span class="nam">lowercase</span><span class="op">=</span><span class="key">False</span><span class="op">,</span> <span class="nam">separator</span><span class="op">=</span><span class="str">'_'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t990" href="#t990">990</a></span><span class="t">            <span class="nam">taxlabels</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">taxlabel</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t991" href="#t991">991</a></span><span class="t">        <span class="nam">max_taxlabel_length</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t992" href="#t992">992</a></span><span class="t">            <span class="op">[</span><span class="nam">len</span><span class="op">(</span><span class="nam">taxlabel</span><span class="op">)</span> <span class="key">for</span> <span class="nam">taxlabel</span> <span class="key">in</span> <span class="nam">taxlabels</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t993" href="#t993">993</a></span><span class="t">        <span class="op">)</span>  <span class="com"># keep track of the longest taxon label for tabular alignment purposes</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t994" href="#t994">994</a></span><span class="t">        <span class="nam">missing_symbol</span> <span class="op">=</span> <span class="str">'?'</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t995" href="#t995">995</a></span><span class="t">        <span class="nam">symbols</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_hennig86_symbols</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t996" href="#t996">996</a></span><span class="t">        <span class="com"># Generate all parent folders for this file that don't already exist:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t997" href="#t997">997</a></span><span class="t">        <span class="nam">Path</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">)</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">mkdir</span><span class="op">(</span><span class="nam">parents</span><span class="op">=</span><span class="key">True</span><span class="op">,</span> <span class="nam">exist_ok</span><span class="op">=</span><span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t998" href="#t998">998</a></span><span class="t">        <span class="key">with</span> <span class="nam">open</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">,</span> <span class="str">"w"</span><span class="op">,</span> <span class="nam">encoding</span><span class="op">=</span><span class="str">"ascii"</span><span class="op">)</span> <span class="key">as</span> <span class="nam">f</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t999" href="#t999">999</a></span><span class="t">            <span class="com"># Start with the nstates header:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1000" href="#t1000">1000</a></span><span class="t">            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"nstates %d;\n"</span> <span class="op">%</span> <span class="nam">len</span><span class="op">(</span><span class="nam">symbols</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1001" href="#t1001">1001</a></span><span class="t">            <span class="com"># Then begin the xread block:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1002" href="#t1002">1002</a></span><span class="t">            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"xread\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1003" href="#t1003">1003</a></span><span class="t">            <span class="com"># Write the dimensions:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1004" href="#t1004">1004</a></span><span class="t">            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"%d %d\n"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">nchar</span><span class="op">,</span> <span class="nam">ntax</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1005" href="#t1005">1005</a></span><span class="t">            <span class="com"># Now write the matrix:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1006" href="#t1006">1006</a></span><span class="t">            <span class="key">for</span> <span class="nam">i</span><span class="op">,</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1007" href="#t1007">1007</a></span><span class="t">                <span class="nam">taxlabel</span> <span class="op">=</span> <span class="nam">taxlabels</span><span class="op">[</span><span class="nam">i</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1008" href="#t1008">1008</a></span><span class="t">                <span class="com"># Add enough space after this label ensure that all sequences are nicely aligned:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1009" href="#t1009">1009</a></span><span class="t">                <span class="nam">sequence</span> <span class="op">=</span> <span class="nam">taxlabel</span> <span class="op">+</span> <span class="op">(</span><span class="str">" "</span> <span class="op">*</span> <span class="op">(</span><span class="nam">max_taxlabel_length</span> <span class="op">-</span> <span class="nam">len</span><span class="op">(</span><span class="nam">taxlabel</span><span class="op">)</span> <span class="op">+</span> <span class="num">1</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1010" href="#t1010">1010</a></span><span class="t">                <span class="key">for</span> <span class="nam">j</span><span class="op">,</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1011" href="#t1011">1011</a></span><span class="t">                    <span class="key">if</span> <span class="nam">vu_id</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_ids_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1012" href="#t1012">1012</a></span><span class="t">                        <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1013" href="#t1013">1013</a></span><span class="t">                    <span class="nam">rdg_support</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">[</span><span class="nam">j</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1014" href="#t1014">1014</a></span><span class="t">                    <span class="com"># If this reading is lacunose in this witness, then use the missing character:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1015" href="#t1015">1015</a></span><span class="t">                    <span class="key">if</span> <span class="nam">sum</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1016" href="#t1016">1016</a></span><span class="t">                        <span class="nam">sequence</span> <span class="op">+=</span> <span class="nam">missing_symbol</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1017" href="#t1017">1017</a></span><span class="t">                        <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1018" href="#t1018">1018</a></span><span class="t">                    <span class="nam">rdg_inds</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1019" href="#t1019">1019</a></span><span class="t">                        <span class="nam">k</span> <span class="key">for</span> <span class="nam">k</span><span class="op">,</span> <span class="nam">w</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="key">if</span> <span class="nam">w</span> <span class="op">></span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1020" href="#t1020">1020</a></span><span class="t">                    <span class="op">]</span>  <span class="com"># the index list consists of the indices of all readings with any degree of certainty assigned to them</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1021" href="#t1021">1021</a></span><span class="t">                    <span class="com"># For singleton readings, just print the symbol:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1022" href="#t1022">1022</a></span><span class="t">                    <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg_inds</span><span class="op">)</span> <span class="op">==</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1023" href="#t1023">1023</a></span><span class="t">                        <span class="nam">sequence</span> <span class="op">+=</span> <span class="nam">symbols</span><span class="op">[</span><span class="nam">rdg_inds</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1024" href="#t1024">1024</a></span><span class="t">                        <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1025" href="#t1025">1025</a></span><span class="t">                    <span class="com"># For multiple readings, print the missing symbol:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1026" href="#t1026">1026</a></span><span class="t">                    <span class="nam">sequence</span> <span class="op">+=</span> <span class="nam">missing_symbol</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1027" href="#t1027">1027</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"%s\n"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">sequence</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1028" href="#t1028">1028</a></span><span class="t">            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">";"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1029" href="#t1029">1029</a></span><span class="t">        <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1030" href="#t1030">1030</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1031" href="#t1031">1031</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_phylip_symbols</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1032" href="#t1032">1032</a></span><span class="t">        <span class="str">"""Returns a list of one-character symbols needed to represent the states of all substantive readings in PHYLIP format.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1033" href="#t1033">1033</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1034" href="#t1034">1034</a></span><span class="t"><span class="str">        The number of symbols equals the maximum number of substantive readings at any variation unit.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1035" href="#t1035">1035</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1036" href="#t1036">1036</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1037" href="#t1037">1037</a></span><span class="t"><span class="str">            A list of individual characters representing states in readings.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1038" href="#t1038">1038</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1039" href="#t1039">1039</a></span><span class="t">        <span class="nam">possible_symbols</span> <span class="op">=</span> <span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1040" href="#t1040">1040</a></span><span class="t">            <span class="nam">list</span><span class="op">(</span><span class="nam">string</span><span class="op">.</span><span class="nam">digits</span><span class="op">)</span> <span class="op">+</span> <span class="nam">list</span><span class="op">(</span><span class="nam">string</span><span class="op">.</span><span class="nam">ascii_lowercase</span><span class="op">)</span><span class="op">[</span><span class="op">:</span><span class="num">22</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1041" href="#t1041">1041</a></span><span class="t">        <span class="op">)</span>  <span class="com"># NOTE: for RAxML, multistate characters with an alphabet sizes up to 32 are supported</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1042" href="#t1042">1042</a></span><span class="t">        <span class="com"># The number of symbols needed is equal to the length of the longest substantive reading vector:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1043" href="#t1043">1043</a></span><span class="t">        <span class="nam">nsymbols</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1044" href="#t1044">1044</a></span><span class="t">        <span class="com"># If there are no witnesses, then no symbols are needed at all:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1045" href="#t1045">1045</a></span><span class="t">        <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1046" href="#t1046">1046</a></span><span class="t">            <span class="key">return</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1047" href="#t1047">1047</a></span><span class="t">        <span class="nam">wit_id</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1048" href="#t1048">1048</a></span><span class="t">        <span class="key">for</span> <span class="nam">rdg_support</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit_id</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1049" href="#t1049">1049</a></span><span class="t">            <span class="nam">nsymbols</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span><span class="nam">nsymbols</span><span class="op">,</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1050" href="#t1050">1050</a></span><span class="t">        <span class="nam">phylip_symbols</span> <span class="op">=</span> <span class="nam">possible_symbols</span><span class="op">[</span><span class="op">:</span><span class="nam">nsymbols</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1051" href="#t1051">1051</a></span><span class="t">        <span class="key">return</span> <span class="nam">phylip_symbols</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1052" href="#t1052">1052</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1053" href="#t1053">1053</a></span><span class="t">    <span class="key">def</span> <span class="nam">to_phylip</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">file_addr</span><span class="op">:</span> <span class="nam">Union</span><span class="op">[</span><span class="nam">Path</span><span class="op">,</span> <span class="nam">str</span><span class="op">]</span><span class="op">,</span> <span class="nam">drop_constant</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1054" href="#t1054">1054</a></span><span class="t">        <span class="str">"""Writes this Collation to a file in PHYLIP format with the given address.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1055" href="#t1055">1055</a></span><span class="t"><span class="str">        Note that because PHYLIP format does not support NEXUS-style ambiguities, such ambiguities will be treated as missing data.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1056" href="#t1056">1056</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1057" href="#t1057">1057</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1058" href="#t1058">1058</a></span><span class="t"><span class="str">            file_addr: A string representing the path to an output file.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1059" href="#t1059">1059</a></span><span class="t"><span class="str">            drop_constant (bool, optional): An optional flag indicating whether to ignore variation units with one substantive reading.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1060" href="#t1060">1060</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1061" href="#t1061">1061</a></span><span class="t">        <span class="com"># Populate a list of sites that will correspond to columns of the sequence alignment:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1062" href="#t1062">1062</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1063" href="#t1063">1063</a></span><span class="t">        <span class="key">if</span> <span class="nam">drop_constant</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1064" href="#t1064">1064</a></span><span class="t">            <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1065" href="#t1065">1065</a></span><span class="t">                <span class="nam">vu_id</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1066" href="#t1066">1066</a></span><span class="t">                <span class="key">for</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1067" href="#t1067">1067</a></span><span class="t">                <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu_id</span><span class="op">]</span><span class="op">)</span> <span class="op">></span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1068" href="#t1068">1068</a></span><span class="t">            <span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1069" href="#t1069">1069</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">substantive_variation_unit_ids</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1070" href="#t1070">1070</a></span><span class="t">        <span class="nam">substantive_variation_unit_reading_tuples_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_variation_unit_reading_tuples</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1071" href="#t1071">1071</a></span><span class="t">        <span class="com"># Start by calculating the values we will be using here:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1072" href="#t1072">1072</a></span><span class="t">        <span class="nam">ntax</span> <span class="op">=</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1073" href="#t1073">1073</a></span><span class="t">        <span class="nam">nchar</span> <span class="op">=</span> <span class="nam">len</span><span class="op">(</span><span class="nam">substantive_variation_unit_ids</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1074" href="#t1074">1074</a></span><span class="t">        <span class="nam">taxlabels</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1075" href="#t1075">1075</a></span><span class="t">        <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1076" href="#t1076">1076</a></span><span class="t">            <span class="nam">taxlabel</span> <span class="op">=</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1077" href="#t1077">1077</a></span><span class="t">            <span class="com"># Then replace any disallowed characters in the string with an underscore:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1078" href="#t1078">1078</a></span><span class="t">            <span class="nam">taxlabel</span> <span class="op">=</span> <span class="nam">slugify</span><span class="op">(</span><span class="nam">taxlabel</span><span class="op">,</span> <span class="nam">lowercase</span><span class="op">=</span><span class="key">False</span><span class="op">,</span> <span class="nam">separator</span><span class="op">=</span><span class="str">'_'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1079" href="#t1079">1079</a></span><span class="t">            <span class="nam">taxlabels</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">taxlabel</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1080" href="#t1080">1080</a></span><span class="t">        <span class="nam">max_taxlabel_length</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1081" href="#t1081">1081</a></span><span class="t">            <span class="op">[</span><span class="nam">len</span><span class="op">(</span><span class="nam">taxlabel</span><span class="op">)</span> <span class="key">for</span> <span class="nam">taxlabel</span> <span class="key">in</span> <span class="nam">taxlabels</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1082" href="#t1082">1082</a></span><span class="t">        <span class="op">)</span>  <span class="com"># keep track of the longest taxon label for tabular alignment purposes</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1083" href="#t1083">1083</a></span><span class="t">        <span class="nam">missing_symbol</span> <span class="op">=</span> <span class="str">'?'</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1084" href="#t1084">1084</a></span><span class="t">        <span class="nam">symbols</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_phylip_symbols</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1085" href="#t1085">1085</a></span><span class="t">        <span class="com"># Generate all parent folders for this file that don't already exist:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1086" href="#t1086">1086</a></span><span class="t">        <span class="nam">Path</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">)</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">mkdir</span><span class="op">(</span><span class="nam">parents</span><span class="op">=</span><span class="key">True</span><span class="op">,</span> <span class="nam">exist_ok</span><span class="op">=</span><span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1087" href="#t1087">1087</a></span><span class="t">        <span class="key">with</span> <span class="nam">open</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">,</span> <span class="str">"w"</span><span class="op">,</span> <span class="nam">encoding</span><span class="op">=</span><span class="str">"ascii"</span><span class="op">)</span> <span class="key">as</span> <span class="nam">f</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1088" href="#t1088">1088</a></span><span class="t">            <span class="com"># Write the dimensions:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1089" href="#t1089">1089</a></span><span class="t">            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"%d %d\n"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">ntax</span><span class="op">,</span> <span class="nam">nchar</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1090" href="#t1090">1090</a></span><span class="t">            <span class="com"># Now write the matrix:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1091" href="#t1091">1091</a></span><span class="t">            <span class="key">for</span> <span class="nam">i</span><span class="op">,</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1092" href="#t1092">1092</a></span><span class="t">                <span class="nam">taxlabel</span> <span class="op">=</span> <span class="nam">taxlabels</span><span class="op">[</span><span class="nam">i</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1093" href="#t1093">1093</a></span><span class="t">                <span class="com"># Add enough space after this label ensure that all sequences are nicely aligned:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1094" href="#t1094">1094</a></span><span class="t">                <span class="nam">sequence</span> <span class="op">=</span> <span class="nam">taxlabel</span> <span class="op">+</span> <span class="op">(</span><span class="str">" "</span> <span class="op">*</span> <span class="op">(</span><span class="nam">max_taxlabel_length</span> <span class="op">-</span> <span class="nam">len</span><span class="op">(</span><span class="nam">taxlabel</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="str">"\t"</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1095" href="#t1095">1095</a></span><span class="t">                <span class="key">for</span> <span class="nam">j</span><span class="op">,</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1096" href="#t1096">1096</a></span><span class="t">                    <span class="key">if</span> <span class="nam">vu_id</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_ids_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1097" href="#t1097">1097</a></span><span class="t">                        <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1098" href="#t1098">1098</a></span><span class="t">                    <span class="nam">rdg_support</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">[</span><span class="nam">j</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1099" href="#t1099">1099</a></span><span class="t">                    <span class="com"># If this reading is lacunose in this witness, then use the missing character:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1100" href="#t1100">1100</a></span><span class="t">                    <span class="key">if</span> <span class="nam">sum</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1101" href="#t1101">1101</a></span><span class="t">                        <span class="nam">sequence</span> <span class="op">+=</span> <span class="nam">missing_symbol</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1102" href="#t1102">1102</a></span><span class="t">                        <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1103" href="#t1103">1103</a></span><span class="t">                    <span class="nam">rdg_inds</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1104" href="#t1104">1104</a></span><span class="t">                        <span class="nam">k</span> <span class="key">for</span> <span class="nam">k</span><span class="op">,</span> <span class="nam">w</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="key">if</span> <span class="nam">w</span> <span class="op">></span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1105" href="#t1105">1105</a></span><span class="t">                    <span class="op">]</span>  <span class="com"># the index list consists of the indices of all readings with any degree of certainty assigned to them</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1106" href="#t1106">1106</a></span><span class="t">                    <span class="com"># For singleton readings, just print the symbol:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1107" href="#t1107">1107</a></span><span class="t">                    <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg_inds</span><span class="op">)</span> <span class="op">==</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1108" href="#t1108">1108</a></span><span class="t">                        <span class="nam">sequence</span> <span class="op">+=</span> <span class="nam">symbols</span><span class="op">[</span><span class="nam">rdg_inds</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1109" href="#t1109">1109</a></span><span class="t">                        <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1110" href="#t1110">1110</a></span><span class="t">                    <span class="com"># For multiple readings, print the missing symbol:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1111" href="#t1111">1111</a></span><span class="t">                    <span class="nam">sequence</span> <span class="op">+=</span> <span class="nam">missing_symbol</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1112" href="#t1112">1112</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"%s\n"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">sequence</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1113" href="#t1113">1113</a></span><span class="t">        <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1114" href="#t1114">1114</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1115" href="#t1115">1115</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_fasta_symbols</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1116" href="#t1116">1116</a></span><span class="t">        <span class="str">"""Returns a list of one-character symbols needed to represent the states of all substantive readings in FASTA format.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1117" href="#t1117">1117</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1118" href="#t1118">1118</a></span><span class="t"><span class="str">        The number of symbols equals the maximum number of substantive readings at any variation unit.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1119" href="#t1119">1119</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1120" href="#t1120">1120</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1121" href="#t1121">1121</a></span><span class="t"><span class="str">            A list of individual characters representing states in readings.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1122" href="#t1122">1122</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1123" href="#t1123">1123</a></span><span class="t">        <span class="nam">possible_symbols</span> <span class="op">=</span> <span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1124" href="#t1124">1124</a></span><span class="t">            <span class="nam">list</span><span class="op">(</span><span class="nam">string</span><span class="op">.</span><span class="nam">digits</span><span class="op">)</span> <span class="op">+</span> <span class="nam">list</span><span class="op">(</span><span class="nam">string</span><span class="op">.</span><span class="nam">ascii_lowercase</span><span class="op">)</span><span class="op">[</span><span class="op">:</span><span class="num">22</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1125" href="#t1125">1125</a></span><span class="t">        <span class="op">)</span>  <span class="com"># NOTE: for RAxML, multistate characters with an alphabet sizes up to 32 are supported</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1126" href="#t1126">1126</a></span><span class="t">        <span class="com"># The number of symbols needed is equal to the length of the longest substantive reading vector:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1127" href="#t1127">1127</a></span><span class="t">        <span class="nam">nsymbols</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1128" href="#t1128">1128</a></span><span class="t">        <span class="com"># If there are no witnesses, then no symbols are needed at all:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1129" href="#t1129">1129</a></span><span class="t">        <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1130" href="#t1130">1130</a></span><span class="t">            <span class="key">return</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1131" href="#t1131">1131</a></span><span class="t">        <span class="nam">wit_id</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1132" href="#t1132">1132</a></span><span class="t">        <span class="key">for</span> <span class="nam">rdg_support</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit_id</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1133" href="#t1133">1133</a></span><span class="t">            <span class="nam">nsymbols</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span><span class="nam">nsymbols</span><span class="op">,</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1134" href="#t1134">1134</a></span><span class="t">        <span class="nam">fasta_symbols</span> <span class="op">=</span> <span class="nam">possible_symbols</span><span class="op">[</span><span class="op">:</span><span class="nam">nsymbols</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1135" href="#t1135">1135</a></span><span class="t">        <span class="key">return</span> <span class="nam">fasta_symbols</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1136" href="#t1136">1136</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1137" href="#t1137">1137</a></span><span class="t">    <span class="key">def</span> <span class="nam">to_fasta</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">file_addr</span><span class="op">:</span> <span class="nam">Union</span><span class="op">[</span><span class="nam">Path</span><span class="op">,</span> <span class="nam">str</span><span class="op">]</span><span class="op">,</span> <span class="nam">drop_constant</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1138" href="#t1138">1138</a></span><span class="t">        <span class="str">"""Writes this Collation to a file in FASTA format with the given address.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1139" href="#t1139">1139</a></span><span class="t"><span class="str">        Note that because FASTA format does not support NEXUS-style ambiguities, such ambiguities will be treated as missing data.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1140" href="#t1140">1140</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1141" href="#t1141">1141</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1142" href="#t1142">1142</a></span><span class="t"><span class="str">            file_addr: A string representing the path to an output file.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1143" href="#t1143">1143</a></span><span class="t"><span class="str">            drop_constant (bool, optional): An optional flag indicating whether to ignore variation units with one substantive reading.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1144" href="#t1144">1144</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1145" href="#t1145">1145</a></span><span class="t">        <span class="com"># Populate a list of sites that will correspond to columns of the sequence alignment:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1146" href="#t1146">1146</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1147" href="#t1147">1147</a></span><span class="t">        <span class="key">if</span> <span class="nam">drop_constant</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1148" href="#t1148">1148</a></span><span class="t">            <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1149" href="#t1149">1149</a></span><span class="t">                <span class="nam">vu_id</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1150" href="#t1150">1150</a></span><span class="t">                <span class="key">for</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1151" href="#t1151">1151</a></span><span class="t">                <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu_id</span><span class="op">]</span><span class="op">)</span> <span class="op">></span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1152" href="#t1152">1152</a></span><span class="t">            <span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1153" href="#t1153">1153</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">substantive_variation_unit_ids</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1154" href="#t1154">1154</a></span><span class="t">        <span class="nam">substantive_variation_unit_reading_tuples_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_variation_unit_reading_tuples</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1155" href="#t1155">1155</a></span><span class="t">        <span class="com"># Start by calculating the values we will be using here:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1156" href="#t1156">1156</a></span><span class="t">        <span class="nam">ntax</span> <span class="op">=</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1157" href="#t1157">1157</a></span><span class="t">        <span class="nam">nchar</span> <span class="op">=</span> <span class="nam">len</span><span class="op">(</span><span class="nam">substantive_variation_unit_ids</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1158" href="#t1158">1158</a></span><span class="t">        <span class="nam">taxlabels</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1159" href="#t1159">1159</a></span><span class="t">        <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1160" href="#t1160">1160</a></span><span class="t">            <span class="nam">taxlabel</span> <span class="op">=</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1161" href="#t1161">1161</a></span><span class="t">            <span class="com"># Then replace any disallowed characters in the string with an underscore:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1162" href="#t1162">1162</a></span><span class="t">            <span class="nam">taxlabel</span> <span class="op">=</span> <span class="nam">slugify</span><span class="op">(</span><span class="nam">taxlabel</span><span class="op">,</span> <span class="nam">lowercase</span><span class="op">=</span><span class="key">False</span><span class="op">,</span> <span class="nam">separator</span><span class="op">=</span><span class="str">'_'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1163" href="#t1163">1163</a></span><span class="t">            <span class="nam">taxlabels</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">taxlabel</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1164" href="#t1164">1164</a></span><span class="t">        <span class="nam">max_taxlabel_length</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1165" href="#t1165">1165</a></span><span class="t">            <span class="op">[</span><span class="nam">len</span><span class="op">(</span><span class="nam">taxlabel</span><span class="op">)</span> <span class="key">for</span> <span class="nam">taxlabel</span> <span class="key">in</span> <span class="nam">taxlabels</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1166" href="#t1166">1166</a></span><span class="t">        <span class="op">)</span>  <span class="com"># keep track of the longest taxon label for tabular alignment purposes</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1167" href="#t1167">1167</a></span><span class="t">        <span class="nam">missing_symbol</span> <span class="op">=</span> <span class="str">'?'</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1168" href="#t1168">1168</a></span><span class="t">        <span class="nam">symbols</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_fasta_symbols</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1169" href="#t1169">1169</a></span><span class="t">        <span class="com"># Generate all parent folders for this file that don't already exist:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1170" href="#t1170">1170</a></span><span class="t">        <span class="nam">Path</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">)</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">mkdir</span><span class="op">(</span><span class="nam">parents</span><span class="op">=</span><span class="key">True</span><span class="op">,</span> <span class="nam">exist_ok</span><span class="op">=</span><span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1171" href="#t1171">1171</a></span><span class="t">        <span class="key">with</span> <span class="nam">open</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">,</span> <span class="str">"w"</span><span class="op">,</span> <span class="nam">encoding</span><span class="op">=</span><span class="str">"ascii"</span><span class="op">)</span> <span class="key">as</span> <span class="nam">f</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1172" href="#t1172">1172</a></span><span class="t">            <span class="com"># Now write the matrix:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1173" href="#t1173">1173</a></span><span class="t">            <span class="key">for</span> <span class="nam">i</span><span class="op">,</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1174" href="#t1174">1174</a></span><span class="t">                <span class="nam">taxlabel</span> <span class="op">=</span> <span class="nam">taxlabels</span><span class="op">[</span><span class="nam">i</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1175" href="#t1175">1175</a></span><span class="t">                <span class="com"># Add enough space after this label ensure that all sequences are nicely aligned:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1176" href="#t1176">1176</a></span><span class="t">                <span class="nam">sequence</span> <span class="op">=</span> <span class="str">">%s\n"</span> <span class="op">%</span> <span class="nam">taxlabel</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1177" href="#t1177">1177</a></span><span class="t">                <span class="key">for</span> <span class="nam">j</span><span class="op">,</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1178" href="#t1178">1178</a></span><span class="t">                    <span class="key">if</span> <span class="nam">vu_id</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_ids_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1179" href="#t1179">1179</a></span><span class="t">                        <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1180" href="#t1180">1180</a></span><span class="t">                    <span class="nam">rdg_support</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">[</span><span class="nam">j</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1181" href="#t1181">1181</a></span><span class="t">                    <span class="com"># If this reading is lacunose in this witness, then use the missing character:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1182" href="#t1182">1182</a></span><span class="t">                    <span class="key">if</span> <span class="nam">sum</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1183" href="#t1183">1183</a></span><span class="t">                        <span class="nam">sequence</span> <span class="op">+=</span> <span class="nam">missing_symbol</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1184" href="#t1184">1184</a></span><span class="t">                        <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1185" href="#t1185">1185</a></span><span class="t">                    <span class="nam">rdg_inds</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1186" href="#t1186">1186</a></span><span class="t">                        <span class="nam">k</span> <span class="key">for</span> <span class="nam">k</span><span class="op">,</span> <span class="nam">w</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="key">if</span> <span class="nam">w</span> <span class="op">></span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1187" href="#t1187">1187</a></span><span class="t">                    <span class="op">]</span>  <span class="com"># the index list consists of the indices of all readings with any degree of certainty assigned to them</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1188" href="#t1188">1188</a></span><span class="t">                    <span class="com"># For singleton readings, just print the symbol:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1189" href="#t1189">1189</a></span><span class="t">                    <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg_inds</span><span class="op">)</span> <span class="op">==</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1190" href="#t1190">1190</a></span><span class="t">                        <span class="nam">sequence</span> <span class="op">+=</span> <span class="nam">symbols</span><span class="op">[</span><span class="nam">rdg_inds</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1191" href="#t1191">1191</a></span><span class="t">                        <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1192" href="#t1192">1192</a></span><span class="t">                    <span class="com"># For multiple readings, print the missing symbol:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1193" href="#t1193">1193</a></span><span class="t">                    <span class="nam">sequence</span> <span class="op">+=</span> <span class="nam">missing_symbol</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1194" href="#t1194">1194</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"%s\n"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">sequence</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1195" href="#t1195">1195</a></span><span class="t">        <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1196" href="#t1196">1196</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1197" href="#t1197">1197</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_beast_symbols</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1198" href="#t1198">1198</a></span><span class="t">        <span class="str">"""Returns a list of one-character symbols needed to represent the states of all substantive readings in BEAST format.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1199" href="#t1199">1199</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1200" href="#t1200">1200</a></span><span class="t"><span class="str">        The number of symbols equals the maximum number of substantive readings at any variation unit.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1201" href="#t1201">1201</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1202" href="#t1202">1202</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1203" href="#t1203">1203</a></span><span class="t"><span class="str">            A list of individual characters representing states in readings.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1204" href="#t1204">1204</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1205" href="#t1205">1205</a></span><span class="t">        <span class="nam">possible_symbols</span> <span class="op">=</span> <span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1206" href="#t1206">1206</a></span><span class="t">            <span class="nam">list</span><span class="op">(</span><span class="nam">string</span><span class="op">.</span><span class="nam">digits</span><span class="op">)</span> <span class="op">+</span> <span class="nam">list</span><span class="op">(</span><span class="nam">string</span><span class="op">.</span><span class="nam">ascii_lowercase</span><span class="op">)</span> <span class="op">+</span> <span class="nam">list</span><span class="op">(</span><span class="nam">string</span><span class="op">.</span><span class="nam">ascii_uppercase</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1207" href="#t1207">1207</a></span><span class="t">        <span class="op">)</span>  <span class="com"># NOTE: for BEAST, any number of states should theoretically be permissible, but since code maps are required for some reason, we will limit the number of symbols to 62 for now</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1208" href="#t1208">1208</a></span><span class="t">        <span class="com"># The number of symbols needed is equal to the length of the longest substantive reading vector:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1209" href="#t1209">1209</a></span><span class="t">        <span class="nam">nsymbols</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1210" href="#t1210">1210</a></span><span class="t">        <span class="com"># If there are no witnesses, then no symbols are needed at all:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1211" href="#t1211">1211</a></span><span class="t">        <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1212" href="#t1212">1212</a></span><span class="t">            <span class="key">return</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1213" href="#t1213">1213</a></span><span class="t">        <span class="nam">wit_id</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1214" href="#t1214">1214</a></span><span class="t">        <span class="key">for</span> <span class="nam">rdg_support</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit_id</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1215" href="#t1215">1215</a></span><span class="t">            <span class="nam">nsymbols</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span><span class="nam">nsymbols</span><span class="op">,</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1216" href="#t1216">1216</a></span><span class="t">        <span class="nam">beast_symbols</span> <span class="op">=</span> <span class="nam">possible_symbols</span><span class="op">[</span><span class="op">:</span><span class="nam">nsymbols</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1217" href="#t1217">1217</a></span><span class="t">        <span class="key">return</span> <span class="nam">beast_symbols</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1218" href="#t1218">1218</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1219" href="#t1219">1219</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_tip_date_range</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1220" href="#t1220">1220</a></span><span class="t">        <span class="str">"""Gets the minimum and maximum dates attested among the witnesses.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1221" href="#t1221">1221</a></span><span class="t"><span class="str">        Also checks if the witness with the latest possible date has a fixed date</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1222" href="#t1222">1222</a></span><span class="t"><span class="str">        (i.e, if the lower and upper bounds for its date are the same)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1223" href="#t1223">1223</a></span><span class="t"><span class="str">        and issues a warning if not, as this will cause unusual behavior in BEAST 2.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1224" href="#t1224">1224</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1225" href="#t1225">1225</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1226" href="#t1226">1226</a></span><span class="t"><span class="str">            A tuple containing the earliest and latest possible tip dates.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1227" href="#t1227">1227</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1228" href="#t1228">1228</a></span><span class="t">        <span class="nam">earliest_date</span> <span class="op">=</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1229" href="#t1229">1229</a></span><span class="t">        <span class="nam">earliest_wit</span> <span class="op">=</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1230" href="#t1230">1230</a></span><span class="t">        <span class="nam">latest_date</span> <span class="op">=</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1231" href="#t1231">1231</a></span><span class="t">        <span class="nam">latest_wit</span> <span class="op">=</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1232" href="#t1232">1232</a></span><span class="t">        <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1233" href="#t1233">1233</a></span><span class="t">            <span class="nam">wit_id</span> <span class="op">=</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1234" href="#t1234">1234</a></span><span class="t">            <span class="nam">date_range</span> <span class="op">=</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1235" href="#t1235">1235</a></span><span class="t">            <span class="key">if</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1236" href="#t1236">1236</a></span><span class="t">                <span class="key">if</span> <span class="nam">earliest_date</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1237" href="#t1237">1237</a></span><span class="t">                    <span class="nam">earliest_wit</span> <span class="op">=</span> <span class="nam">wit</span> <span class="key">if</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="op">&lt;</span> <span class="nam">earliest_date</span> <span class="key">else</span> <span class="nam">earliest_wit</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1238" href="#t1238">1238</a></span><span class="t">                    <span class="nam">earliest_date</span> <span class="op">=</span> <span class="nam">min</span><span class="op">(</span><span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span> <span class="nam">earliest_date</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1239" href="#t1239">1239</a></span><span class="t">                <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1240" href="#t1240">1240</a></span><span class="t">                    <span class="nam">earliest_wit</span> <span class="op">=</span> <span class="nam">wit</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1241" href="#t1241">1241</a></span><span class="t">                    <span class="nam">earliest_date</span> <span class="op">=</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1242" href="#t1242">1242</a></span><span class="t">            <span class="key">if</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1243" href="#t1243">1243</a></span><span class="t">                <span class="key">if</span> <span class="nam">latest_date</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1244" href="#t1244">1244</a></span><span class="t">                    <span class="nam">latest_wit</span> <span class="op">=</span> <span class="nam">wit</span> <span class="key">if</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="op">></span> <span class="nam">latest_date</span> <span class="key">else</span> <span class="nam">latest_wit</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1245" href="#t1245">1245</a></span><span class="t">                    <span class="nam">latest_date</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span><span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">,</span> <span class="nam">latest_date</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1246" href="#t1246">1246</a></span><span class="t">                <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1247" href="#t1247">1247</a></span><span class="t">                    <span class="nam">latest_wit</span> <span class="op">=</span> <span class="nam">wit</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1248" href="#t1248">1248</a></span><span class="t">                    <span class="nam">latest_date</span> <span class="op">=</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1249" href="#t1249">1249</a></span><span class="t">        <span class="key">if</span> <span class="nam">latest_wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">is</span> <span class="key">None</span> <span class="key">or</span> <span class="nam">latest_wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="op">!=</span> <span class="nam">latest_wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1250" href="#t1250">1250</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1251" href="#t1251">1251</a></span><span class="t">                <span class="str">"WARNING: the latest witness, %s, has a variable date range; this will result in problems with time-dependent substitution models and misalignment of trees in BEAST DensiTree outputs! Please ensure that witness %s has a fixed date."</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1252" href="#t1252">1252</a></span><span class="t">                <span class="op">%</span> <span class="op">(</span><span class="nam">latest_wit</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">latest_wit</span><span class="op">.</span><span class="nam">id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1253" href="#t1253">1253</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1254" href="#t1254">1254</a></span><span class="t">        <span class="key">return</span> <span class="op">(</span><span class="nam">earliest_date</span><span class="op">,</span> <span class="nam">latest_date</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1255" href="#t1255">1255</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1256" href="#t1256">1256</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_beast_origin_span</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">tip_date_range</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1257" href="#t1257">1257</a></span><span class="t">        <span class="str">"""Returns a tuple containing the lower and upper bounds for the height of the origin of the Birth-Death Skyline model.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1258" href="#t1258">1258</a></span><span class="t"><span class="str">        The upper bound on the height of the tree is the difference between the latest tip date</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1259" href="#t1259">1259</a></span><span class="t"><span class="str">        and the lower bound on the date of the original work, if both are defined;</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1260" href="#t1260">1260</a></span><span class="t"><span class="str">        otherwise, it is left undefined.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1261" href="#t1261">1261</a></span><span class="t"><span class="str">        The lower bound on the height of the tree is the difference between the latest tip date</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1262" href="#t1262">1262</a></span><span class="t"><span class="str">        and the upper bound on the date of the original work, if both are defined;</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1263" href="#t1263">1263</a></span><span class="t"><span class="str">        otherwise, it is the difference between the earliest tip date and the latest, if both are defined.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1264" href="#t1264">1264</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1265" href="#t1265">1265</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1266" href="#t1266">1266</a></span><span class="t"><span class="str">            tip_date_range: A tuple containing the earliest and latest possible tip dates.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1267" href="#t1267">1267</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1268" href="#t1268">1268</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1269" href="#t1269">1269</a></span><span class="t"><span class="str">            A tuple containing lower and upper bounds on the origin height for the Birth-Death Skyline model.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1270" href="#t1270">1270</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1271" href="#t1271">1271</a></span><span class="t">        <span class="nam">origin_span</span> <span class="op">=</span> <span class="op">[</span><span class="num">0</span><span class="op">,</span> <span class="key">None</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1272" href="#t1272">1272</a></span><span class="t">        <span class="com"># If the upper bound on the date of the work's composition is defined, then set the lower bound on the height of the origin using it and the latest tip date</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1273" href="#t1273">1273</a></span><span class="t">        <span class="com"># (note that if it had to be defined in terms of witness date lower bounds, then this would have happened already):</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1274" href="#t1274">1274</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1275" href="#t1275">1275</a></span><span class="t">            <span class="nam">origin_span</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="op">=</span> <span class="nam">tip_date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1276" href="#t1276">1276</a></span><span class="t">        <span class="com"># If the lower bound on the date of the work's composition is defined, then set the upper bound on the height of the origin using it and the latest tip date:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1277" href="#t1277">1277</a></span><span class="t">        <span class="key">if</span> <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1278" href="#t1278">1278</a></span><span class="t">            <span class="nam">origin_span</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="op">=</span> <span class="nam">tip_date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="op">-</span> <span class="nam">self</span><span class="op">.</span><span class="nam">origin_date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1279" href="#t1279">1279</a></span><span class="t">        <span class="key">return</span> <span class="nam">tuple</span><span class="op">(</span><span class="nam">origin_span</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1280" href="#t1280">1280</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1281" href="#t1281">1281</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_beast_date_map</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">taxlabels</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1282" href="#t1282">1282</a></span><span class="t">        <span class="str">"""Returns a string representing witness-to-date mappings in BEAST format.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1283" href="#t1283">1283</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1284" href="#t1284">1284</a></span><span class="t"><span class="str">        Since this format requires single dates as opposed to date ranges,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1285" href="#t1285">1285</a></span><span class="t"><span class="str">        witnesses with closed date ranges will be mapped to the average of their lower and upper bounds,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1286" href="#t1286">1286</a></span><span class="t"><span class="str">        and witnesses with open date ranges will not be mapped.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1287" href="#t1287">1287</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1288" href="#t1288">1288</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1289" href="#t1289">1289</a></span><span class="t"><span class="str">            taxlabels: A list of slugified taxon labels.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1290" href="#t1290">1290</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1291" href="#t1291">1291</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1292" href="#t1292">1292</a></span><span class="t"><span class="str">            A string containing comma-separated date calibrations of the form witness_id=date.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1293" href="#t1293">1293</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1294" href="#t1294">1294</a></span><span class="t">        <span class="nam">calibrate_strings</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1295" href="#t1295">1295</a></span><span class="t">        <span class="key">for</span> <span class="nam">i</span><span class="op">,</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1296" href="#t1296">1296</a></span><span class="t">            <span class="nam">taxlabel</span> <span class="op">=</span> <span class="nam">taxlabels</span><span class="op">[</span><span class="nam">i</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1297" href="#t1297">1297</a></span><span class="t">            <span class="nam">date_range</span> <span class="op">=</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1298" href="#t1298">1298</a></span><span class="t">            <span class="com"># If either end of this witness's date range is empty, then do not include it:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1299" href="#t1299">1299</a></span><span class="t">            <span class="key">if</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">is</span> <span class="key">None</span> <span class="key">or</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="key">is</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="mis show_mis"><span class="n"><a id="t1300" href="#t1300">1300</a></span><span class="t">                <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1301" href="#t1301">1301</a></span><span class="t">            <span class="com"># Otherwise, take the midpoint of its date range as its date:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1302" href="#t1302">1302</a></span><span class="t">            <span class="nam">date</span> <span class="op">=</span> <span class="nam">int</span><span class="op">(</span><span class="op">(</span><span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="op">+</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="num">2</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1303" href="#t1303">1303</a></span><span class="t">            <span class="nam">calibrate_string</span> <span class="op">=</span> <span class="str">"%s=%d"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">taxlabel</span><span class="op">,</span> <span class="nam">date</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1304" href="#t1304">1304</a></span><span class="t">            <span class="nam">calibrate_strings</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">calibrate_string</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1305" href="#t1305">1305</a></span><span class="t">        <span class="com"># Then output the full date map string:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1306" href="#t1306">1306</a></span><span class="t">        <span class="nam">date_map</span> <span class="op">=</span> <span class="str">","</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="nam">calibrate_strings</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1307" href="#t1307">1307</a></span><span class="t">        <span class="key">return</span> <span class="nam">date_map</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1308" href="#t1308">1308</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1309" href="#t1309">1309</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_beast_code_map_for_unit</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">symbols</span><span class="op">,</span> <span class="nam">missing_symbol</span><span class="op">,</span> <span class="nam">vu_ind</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1310" href="#t1310">1310</a></span><span class="t">        <span class="str">"""Returns a string containing state/reading code mappings in BEAST format using the given single-state and missing state symbols for the character/variation unit at the given index.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1311" href="#t1311">1311</a></span><span class="t"><span class="str">        If the variation unit at the given index is a singleton unit (i.e., if it has only one substantive reading), then a code for a dummy state will be included.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1312" href="#t1312">1312</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1313" href="#t1313">1313</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1314" href="#t1314">1314</a></span><span class="t"><span class="str">            vu_ind: An integer index for the desired unit.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1315" href="#t1315">1315</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1316" href="#t1316">1316</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1317" href="#t1317">1317</a></span><span class="t"><span class="str">            A string containing comma-separated code mappings.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1318" href="#t1318">1318</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1319" href="#t1319">1319</a></span><span class="t">        <span class="nam">vu</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_units</span><span class="op">[</span><span class="nam">vu_ind</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1320" href="#t1320">1320</a></span><span class="t">        <span class="nam">vu_id</span> <span class="op">=</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1321" href="#t1321">1321</a></span><span class="t">        <span class="nam">code_map</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1322" href="#t1322">1322</a></span><span class="t">        <span class="key">for</span> <span class="nam">k</span> <span class="key">in</span> <span class="nam">range</span><span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1323" href="#t1323">1323</a></span><span class="t">            <span class="nam">code_map</span><span class="op">[</span><span class="nam">symbols</span><span class="op">[</span><span class="nam">k</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="nam">str</span><span class="op">(</span><span class="nam">k</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1324" href="#t1324">1324</a></span><span class="t">        <span class="com"># If this site is a singleton site, then add a code mapping for the dummy state:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1325" href="#t1325">1325</a></span><span class="t">        <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span> <span class="op">==</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1326" href="#t1326">1326</a></span><span class="t">            <span class="nam">code_map</span><span class="op">[</span><span class="nam">symbols</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="nam">str</span><span class="op">(</span><span class="num">1</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1327" href="#t1327">1327</a></span><span class="t">        <span class="com"># Then add a mapping for the missing state, including a dummy state if this is a singleton site:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1328" href="#t1328">1328</a></span><span class="t">        <span class="nam">code_map</span><span class="op">[</span><span class="nam">missing_symbol</span><span class="op">]</span> <span class="op">=</span> <span class="str">" "</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1329" href="#t1329">1329</a></span><span class="t">            <span class="nam">str</span><span class="op">(</span><span class="nam">k</span><span class="op">)</span> <span class="key">for</span> <span class="nam">k</span> <span class="key">in</span> <span class="nam">range</span><span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1330" href="#t1330">1330</a></span><span class="t">        <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1331" href="#t1331">1331</a></span><span class="t">        <span class="com"># If this site is a singleton site, then add the dummy state to the missing state mapping:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1332" href="#t1332">1332</a></span><span class="t">        <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span> <span class="op">==</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1333" href="#t1333">1333</a></span><span class="t">            <span class="nam">code_map</span><span class="op">[</span><span class="nam">missing_symbol</span><span class="op">]</span> <span class="op">=</span> <span class="nam">code_map</span><span class="op">[</span><span class="nam">missing_symbol</span><span class="op">]</span> <span class="op">+</span> <span class="str">" "</span> <span class="op">+</span> <span class="nam">str</span><span class="op">(</span><span class="num">1</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1334" href="#t1334">1334</a></span><span class="t">        <span class="com"># Then combine all of the mappings into a single string:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1335" href="#t1335">1335</a></span><span class="t">        <span class="nam">code_map_string</span> <span class="op">=</span> <span class="str">", "</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="op">[</span><span class="nam">code</span> <span class="op">+</span> <span class="str">"="</span> <span class="op">+</span> <span class="nam">code_map</span><span class="op">[</span><span class="nam">code</span><span class="op">]</span> <span class="key">for</span> <span class="nam">code</span> <span class="key">in</span> <span class="nam">code_map</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1336" href="#t1336">1336</a></span><span class="t">        <span class="key">return</span> <span class="nam">code_map_string</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1337" href="#t1337">1337</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1338" href="#t1338">1338</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_beast_equilibrium_frequencies_for_unit</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">vu_ind</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1339" href="#t1339">1339</a></span><span class="t">        <span class="str">"""Returns a string containing state/reading equilibrium frequencies in BEAST format for the character/variation unit at the given index.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1340" href="#t1340">1340</a></span><span class="t"><span class="str">        Since the equilibrium frequencies are not used with the substitution models, the equilibrium frequencies simply correspond to a uniform distribution over the states.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1341" href="#t1341">1341</a></span><span class="t"><span class="str">        If the variation unit at the given index is a singleton unit (i.e., if it has only one substantive reading), then an equilibrium frequency of 0 will be added for a dummy state.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1342" href="#t1342">1342</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1343" href="#t1343">1343</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1344" href="#t1344">1344</a></span><span class="t"><span class="str">            vu_ind: An integer index for the desired unit.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1345" href="#t1345">1345</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1346" href="#t1346">1346</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1347" href="#t1347">1347</a></span><span class="t"><span class="str">            A string containing space-separated equilibrium frequencies.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1348" href="#t1348">1348</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1349" href="#t1349">1349</a></span><span class="t">        <span class="nam">vu</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_units</span><span class="op">[</span><span class="nam">vu_ind</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1350" href="#t1350">1350</a></span><span class="t">        <span class="nam">vu_id</span> <span class="op">=</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1351" href="#t1351">1351</a></span><span class="t">        <span class="com"># If this unit is a singleton, then return the string "0.5 0.5":</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1352" href="#t1352">1352</a></span><span class="t">        <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu_id</span><span class="op">]</span><span class="op">)</span> <span class="op">==</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1353" href="#t1353">1353</a></span><span class="t">            <span class="key">return</span> <span class="str">"0.5 0.5"</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1354" href="#t1354">1354</a></span><span class="t">        <span class="com"># Otherwise, set the equilibrium frequencies according to a uniform distribution:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1355" href="#t1355">1355</a></span><span class="t">        <span class="nam">equilibrium_frequencies</span> <span class="op">=</span> <span class="op">[</span><span class="num">1.0</span> <span class="op">/</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu_id</span><span class="op">]</span><span class="op">)</span><span class="op">]</span> <span class="op">*</span> <span class="nam">len</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1356" href="#t1356">1356</a></span><span class="t">            <span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu_id</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1357" href="#t1357">1357</a></span><span class="t">        <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1358" href="#t1358">1358</a></span><span class="t">        <span class="nam">equilibrium_frequencies_string</span> <span class="op">=</span> <span class="str">" "</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="op">[</span><span class="nam">str</span><span class="op">(</span><span class="nam">w</span><span class="op">)</span> <span class="key">for</span> <span class="nam">w</span> <span class="key">in</span> <span class="nam">equilibrium_frequencies</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1359" href="#t1359">1359</a></span><span class="t">        <span class="key">return</span> <span class="nam">equilibrium_frequencies_string</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1360" href="#t1360">1360</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1361" href="#t1361">1361</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_beast_root_frequencies_for_unit</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">vu_ind</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1362" href="#t1362">1362</a></span><span class="t">        <span class="str">"""Returns a string containing state/reading root frequencies in BEAST format for the character/variation unit at the given index.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1363" href="#t1363">1363</a></span><span class="t"><span class="str">        The root frequencies are calculated from the intrinsic odds at this unit.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1364" href="#t1364">1364</a></span><span class="t"><span class="str">        If the variation unit at the given index is a singleton unit (i.e., if it has only one substantive reading), then a root frequency of 0 will be added for a dummy state.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1365" href="#t1365">1365</a></span><span class="t"><span class="str">        If no intrinsic odds are specified, then a uniform distribution over all states is assumed.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1366" href="#t1366">1366</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1367" href="#t1367">1367</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1368" href="#t1368">1368</a></span><span class="t"><span class="str">            vu_ind: An integer index for the desired unit.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1369" href="#t1369">1369</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1370" href="#t1370">1370</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1371" href="#t1371">1371</a></span><span class="t"><span class="str">            A string containing space-separated root frequencies.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1372" href="#t1372">1372</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1373" href="#t1373">1373</a></span><span class="t">        <span class="nam">vu</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_units</span><span class="op">[</span><span class="nam">vu_ind</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1374" href="#t1374">1374</a></span><span class="t">        <span class="nam">vu_id</span> <span class="op">=</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1375" href="#t1375">1375</a></span><span class="t">        <span class="nam">intrinsic_relations</span> <span class="op">=</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">intrinsic_relations</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1376" href="#t1376">1376</a></span><span class="t">        <span class="nam">intrinsic_odds_by_id</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">intrinsic_odds_by_id</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1377" href="#t1377">1377</a></span><span class="t">        <span class="com"># If this unit is a singleton, then return the string "1 0":</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1378" href="#t1378">1378</a></span><span class="t">        <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu_id</span><span class="op">]</span><span class="op">)</span> <span class="op">==</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1379" href="#t1379">1379</a></span><span class="t">            <span class="key">return</span> <span class="str">"1 0"</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1380" href="#t1380">1380</a></span><span class="t">        <span class="com"># If this unit has no intrinsic odds, then assume a uniform distribution over all readings:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1381" href="#t1381">1381</a></span><span class="t">        <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">intrinsic_relations</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1382" href="#t1382">1382</a></span><span class="t">            <span class="nam">root_frequencies</span> <span class="op">=</span> <span class="op">[</span><span class="num">1.0</span> <span class="op">/</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu_id</span><span class="op">]</span><span class="op">)</span><span class="op">]</span> <span class="op">*</span> <span class="nam">len</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1383" href="#t1383">1383</a></span><span class="t">                <span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu_id</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1384" href="#t1384">1384</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1385" href="#t1385">1385</a></span><span class="t">            <span class="nam">root_frequencies_string</span> <span class="op">=</span> <span class="str">" "</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="op">[</span><span class="nam">str</span><span class="op">(</span><span class="nam">w</span><span class="op">)</span> <span class="key">for</span> <span class="nam">w</span> <span class="key">in</span> <span class="nam">root_frequencies</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1386" href="#t1386">1386</a></span><span class="t">            <span class="key">return</span> <span class="nam">root_frequencies_string</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1387" href="#t1387">1387</a></span><span class="t">        <span class="com"># We will populate the root frequencies based on the intrinsic odds of the readings:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1388" href="#t1388">1388</a></span><span class="t">        <span class="nam">root_frequencies_by_id</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1389" href="#t1389">1389</a></span><span class="t">        <span class="key">for</span> <span class="nam">rdg_id</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu_id</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1390" href="#t1390">1390</a></span><span class="t">            <span class="nam">root_frequencies_by_id</span><span class="op">[</span><span class="nam">rdg_id</span><span class="op">]</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1391" href="#t1391">1391</a></span><span class="t">        <span class="com"># First, construct an adjacency list for efficient edge iteration:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1392" href="#t1392">1392</a></span><span class="t">        <span class="nam">neighbors_by_source</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1393" href="#t1393">1393</a></span><span class="t">        <span class="key">for</span> <span class="nam">edge</span> <span class="key">in</span> <span class="nam">intrinsic_relations</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1394" href="#t1394">1394</a></span><span class="t">            <span class="nam">s</span> <span class="op">=</span> <span class="nam">edge</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1395" href="#t1395">1395</a></span><span class="t">            <span class="nam">t</span> <span class="op">=</span> <span class="nam">edge</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1396" href="#t1396">1396</a></span><span class="t">            <span class="key">if</span> <span class="nam">s</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">neighbors_by_source</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1397" href="#t1397">1397</a></span><span class="t">                <span class="nam">neighbors_by_source</span><span class="op">[</span><span class="nam">s</span><span class="op">]</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1398" href="#t1398">1398</a></span><span class="t">            <span class="key">if</span> <span class="nam">t</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">neighbors_by_source</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1399" href="#t1399">1399</a></span><span class="t">                <span class="nam">neighbors_by_source</span><span class="op">[</span><span class="nam">t</span><span class="op">]</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1400" href="#t1400">1400</a></span><span class="t">            <span class="nam">neighbors_by_source</span><span class="op">[</span><span class="nam">s</span><span class="op">]</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">t</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1401" href="#t1401">1401</a></span><span class="t">        <span class="com"># Next, identify all readings that are not targeted by any intrinsic odds relation:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1402" href="#t1402">1402</a></span><span class="t">        <span class="nam">in_degree_by_reading</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1403" href="#t1403">1403</a></span><span class="t">        <span class="key">for</span> <span class="nam">edge</span> <span class="key">in</span> <span class="nam">intrinsic_relations</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1404" href="#t1404">1404</a></span><span class="t">            <span class="nam">s</span> <span class="op">=</span> <span class="nam">edge</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1405" href="#t1405">1405</a></span><span class="t">            <span class="nam">t</span> <span class="op">=</span> <span class="nam">edge</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1406" href="#t1406">1406</a></span><span class="t">            <span class="key">if</span> <span class="nam">s</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">in_degree_by_reading</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1407" href="#t1407">1407</a></span><span class="t">                <span class="nam">in_degree_by_reading</span><span class="op">[</span><span class="nam">s</span><span class="op">]</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1408" href="#t1408">1408</a></span><span class="t">            <span class="key">if</span> <span class="nam">t</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">in_degree_by_reading</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1409" href="#t1409">1409</a></span><span class="t">                <span class="nam">in_degree_by_reading</span><span class="op">[</span><span class="nam">t</span><span class="op">]</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1410" href="#t1410">1410</a></span><span class="t">            <span class="nam">in_degree_by_reading</span><span class="op">[</span><span class="nam">t</span><span class="op">]</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1411" href="#t1411">1411</a></span><span class="t">        <span class="nam">starting_nodes</span> <span class="op">=</span> <span class="op">[</span><span class="nam">t</span> <span class="key">for</span> <span class="nam">t</span> <span class="key">in</span> <span class="nam">in_degree_by_reading</span> <span class="key">if</span> <span class="nam">in_degree_by_reading</span><span class="op">[</span><span class="nam">t</span><span class="op">]</span> <span class="op">==</span> <span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1412" href="#t1412">1412</a></span><span class="t">        <span class="com"># Set the root frequencies for these readings to 1 (they will be normalized later):</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1413" href="#t1413">1413</a></span><span class="t">        <span class="key">for</span> <span class="nam">starting_node</span> <span class="key">in</span> <span class="nam">starting_nodes</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1414" href="#t1414">1414</a></span><span class="t">            <span class="nam">root_frequencies_by_id</span><span class="op">[</span><span class="nam">starting_node</span><span class="op">]</span> <span class="op">=</span> <span class="num">1.0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1415" href="#t1415">1415</a></span><span class="t">        <span class="com"># Next, set the frequencies for the remaining readings recursively using the adjacency list:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1416" href="#t1416">1416</a></span><span class="t">        <span class="key">def</span> <span class="nam">update_root_frequencies</span><span class="op">(</span><span class="nam">s</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1417" href="#t1417">1417</a></span><span class="t">            <span class="key">for</span> <span class="nam">t</span> <span class="key">in</span> <span class="nam">neighbors_by_source</span><span class="op">[</span><span class="nam">s</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1418" href="#t1418">1418</a></span><span class="t">                <span class="nam">intrinsic_category</span> <span class="op">=</span> <span class="nam">intrinsic_relations</span><span class="op">[</span><span class="op">(</span><span class="nam">s</span><span class="op">,</span> <span class="nam">t</span><span class="op">)</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1419" href="#t1419">1419</a></span><span class="t">                <span class="nam">odds</span> <span class="op">=</span> <span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1420" href="#t1420">1420</a></span><span class="t">                    <span class="nam">intrinsic_odds_by_id</span><span class="op">[</span><span class="nam">intrinsic_category</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1421" href="#t1421">1421</a></span><span class="t">                    <span class="key">if</span> <span class="nam">intrinsic_odds_by_id</span><span class="op">[</span><span class="nam">intrinsic_category</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1422" href="#t1422">1422</a></span><span class="t">                    <span class="key">else</span> <span class="num">1.0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1423" href="#t1423">1423</a></span><span class="t">                <span class="op">)</span>  <span class="com"># TODO: This needs to be handled using parameters once we have it implemented in BEAST</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1424" href="#t1424">1424</a></span><span class="t">                <span class="nam">root_frequencies_by_id</span><span class="op">[</span><span class="nam">t</span><span class="op">]</span> <span class="op">=</span> <span class="nam">root_frequencies_by_id</span><span class="op">[</span><span class="nam">s</span><span class="op">]</span> <span class="op">/</span> <span class="nam">odds</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1425" href="#t1425">1425</a></span><span class="t">                <span class="nam">update_root_frequencies</span><span class="op">(</span><span class="nam">t</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1426" href="#t1426">1426</a></span><span class="t">            <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1427" href="#t1427">1427</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1428" href="#t1428">1428</a></span><span class="t">        <span class="key">for</span> <span class="nam">starting_node</span> <span class="key">in</span> <span class="nam">starting_nodes</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1429" href="#t1429">1429</a></span><span class="t">            <span class="nam">update_root_frequencies</span><span class="op">(</span><span class="nam">starting_node</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1430" href="#t1430">1430</a></span><span class="t">        <span class="com"># Then produce a normalized vector of root frequencies that corresponds to a probability distribution:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1431" href="#t1431">1431</a></span><span class="t">        <span class="nam">root_frequencies</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1432" href="#t1432">1432</a></span><span class="t">            <span class="nam">root_frequencies_by_id</span><span class="op">[</span><span class="nam">rdg_id</span><span class="op">]</span> <span class="key">for</span> <span class="nam">rdg_id</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu_id</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1433" href="#t1433">1433</a></span><span class="t">        <span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1434" href="#t1434">1434</a></span><span class="t">        <span class="nam">total_frequencies</span> <span class="op">=</span> <span class="nam">sum</span><span class="op">(</span><span class="nam">root_frequencies</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1435" href="#t1435">1435</a></span><span class="t">        <span class="key">for</span> <span class="nam">k</span> <span class="key">in</span> <span class="nam">range</span><span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">root_frequencies</span><span class="op">)</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1436" href="#t1436">1436</a></span><span class="t">            <span class="nam">root_frequencies</span><span class="op">[</span><span class="nam">k</span><span class="op">]</span> <span class="op">=</span> <span class="nam">root_frequencies</span><span class="op">[</span><span class="nam">k</span><span class="op">]</span> <span class="op">/</span> <span class="nam">total_frequencies</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1437" href="#t1437">1437</a></span><span class="t">        <span class="nam">root_frequencies_string</span> <span class="op">=</span> <span class="str">" "</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="op">[</span><span class="nam">str</span><span class="op">(</span><span class="nam">w</span><span class="op">)</span> <span class="key">for</span> <span class="nam">w</span> <span class="key">in</span> <span class="nam">root_frequencies</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1438" href="#t1438">1438</a></span><span class="t">        <span class="key">return</span> <span class="nam">root_frequencies_string</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1439" href="#t1439">1439</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1440" href="#t1440">1440</a></span><span class="t">    <span class="key">def</span> <span class="nam">to_beast</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1441" href="#t1441">1441</a></span><span class="t">        <span class="nam">self</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1442" href="#t1442">1442</a></span><span class="t">        <span class="nam">file_addr</span><span class="op">:</span> <span class="nam">Union</span><span class="op">[</span><span class="nam">Path</span><span class="op">,</span> <span class="nam">str</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1443" href="#t1443">1443</a></span><span class="t">        <span class="nam">drop_constant</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1444" href="#t1444">1444</a></span><span class="t">        <span class="nam">clock_model</span><span class="op">:</span> <span class="nam">ClockModel</span> <span class="op">=</span> <span class="nam">ClockModel</span><span class="op">.</span><span class="nam">strict</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1445" href="#t1445">1445</a></span><span class="t">        <span class="nam">ancestral_logger</span><span class="op">:</span> <span class="nam">AncestralLogger</span> <span class="op">=</span> <span class="nam">AncestralLogger</span><span class="op">.</span><span class="nam">state</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1446" href="#t1446">1446</a></span><span class="t">        <span class="nam">seed</span><span class="op">:</span> <span class="nam">int</span> <span class="op">=</span> <span class="key">None</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1447" href="#t1447">1447</a></span><span class="t">    <span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1448" href="#t1448">1448</a></span><span class="t">        <span class="str">"""Writes this Collation to a file in BEAST format with the given address.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1449" href="#t1449">1449</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1450" href="#t1450">1450</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1451" href="#t1451">1451</a></span><span class="t"><span class="str">            file_addr: A string representing the path to an output file.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1452" href="#t1452">1452</a></span><span class="t"><span class="str">            drop_constant (bool, optional): An optional flag indicating whether to ignore variation units with one substantive reading.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1453" href="#t1453">1453</a></span><span class="t"><span class="str">            clock_model: A ClockModel option indicating which clock model to use.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1454" href="#t1454">1454</a></span><span class="t"><span class="str">            ancestral_logger: An AncestralLogger option indicating which class of logger (if any) to use for ancestral states.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1455" href="#t1455">1455</a></span><span class="t"><span class="str">            seed: A seed for random number generation (for setting initial values of unspecified transcriptional rates).</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1456" href="#t1456">1456</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1457" href="#t1457">1457</a></span><span class="t">        <span class="com"># Populate a list of sites that will correspond to columns of the sequence alignment:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1458" href="#t1458">1458</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1459" href="#t1459">1459</a></span><span class="t">        <span class="key">if</span> <span class="nam">drop_constant</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1460" href="#t1460">1460</a></span><span class="t">            <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1461" href="#t1461">1461</a></span><span class="t">                <span class="nam">vu_id</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1462" href="#t1462">1462</a></span><span class="t">                <span class="key">for</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1463" href="#t1463">1463</a></span><span class="t">                <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu_id</span><span class="op">]</span><span class="op">)</span> <span class="op">></span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1464" href="#t1464">1464</a></span><span class="t">            <span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1465" href="#t1465">1465</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">substantive_variation_unit_ids</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1466" href="#t1466">1466</a></span><span class="t">        <span class="nam">substantive_variation_unit_reading_tuples_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_variation_unit_reading_tuples</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1467" href="#t1467">1467</a></span><span class="t">        <span class="com"># First, calculate the values we will be using for the main template:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1468" href="#t1468">1468</a></span><span class="t">        <span class="nam">taxlabels</span> <span class="op">=</span> <span class="op">[</span><span class="nam">slugify</span><span class="op">(</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">lowercase</span><span class="op">=</span><span class="key">False</span><span class="op">,</span> <span class="nam">separator</span><span class="op">=</span><span class="str">'_'</span><span class="op">)</span> <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1469" href="#t1469">1469</a></span><span class="t">        <span class="nam">missing_symbol</span> <span class="op">=</span> <span class="str">'?'</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1470" href="#t1470">1470</a></span><span class="t">        <span class="nam">symbols</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_beast_symbols</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1471" href="#t1471">1471</a></span><span class="t">        <span class="nam">tip_date_range</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_tip_date_range</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1472" href="#t1472">1472</a></span><span class="t">        <span class="nam">origin_span</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_beast_origin_span</span><span class="op">(</span><span class="nam">tip_date_range</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1473" href="#t1473">1473</a></span><span class="t">        <span class="nam">date_map</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_beast_date_map</span><span class="op">(</span><span class="nam">taxlabels</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1474" href="#t1474">1474</a></span><span class="t">        <span class="com"># Then populate the necessary objects for the BEAST XML Jinja template:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1475" href="#t1475">1475</a></span><span class="t">        <span class="nam">witness_objects</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1476" href="#t1476">1476</a></span><span class="t">        <span class="nam">variation_unit_objects</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1477" href="#t1477">1477</a></span><span class="t">        <span class="nam">intrinsic_category_objects</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1478" href="#t1478">1478</a></span><span class="t">        <span class="nam">transcriptional_category_objects</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1479" href="#t1479">1479</a></span><span class="t">        <span class="com"># Start with witnesses:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1480" href="#t1480">1480</a></span><span class="t">        <span class="key">for</span> <span class="nam">i</span><span class="op">,</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1481" href="#t1481">1481</a></span><span class="t">            <span class="nam">witness_object</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1482" href="#t1482">1482</a></span><span class="t">            <span class="com"># Copy the ID for this witness:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1483" href="#t1483">1483</a></span><span class="t">            <span class="nam">witness_object</span><span class="op">[</span><span class="str">"id"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1484" href="#t1484">1484</a></span><span class="t">            <span class="com"># Copy its date bounds:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1485" href="#t1485">1485</a></span><span class="t">            <span class="nam">witness_object</span><span class="op">[</span><span class="str">"min_date"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1486" href="#t1486">1486</a></span><span class="t">            <span class="nam">witness_object</span><span class="op">[</span><span class="str">"max_date"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1487" href="#t1487">1487</a></span><span class="t">            <span class="com"># Populate its sequence from its entries in the witness's readings dictionary:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1488" href="#t1488">1488</a></span><span class="t">            <span class="nam">sequence</span> <span class="op">=</span> <span class="str">""</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1489" href="#t1489">1489</a></span><span class="t">            <span class="key">for</span> <span class="nam">j</span><span class="op">,</span> <span class="nam">rdg_support</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1490" href="#t1490">1490</a></span><span class="t">                <span class="nam">vu_id</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span><span class="op">[</span><span class="nam">j</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1491" href="#t1491">1491</a></span><span class="t">                <span class="com"># Skip any variation units deemed non-substantive:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1492" href="#t1492">1492</a></span><span class="t">                <span class="key">if</span> <span class="nam">vu_id</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_ids</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1493" href="#t1493">1493</a></span><span class="t">                    <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1494" href="#t1494">1494</a></span><span class="t">                <span class="com"># If this witness has a certainty of 0 for all readings, then it is a gap; assign a likelihood of 1 to each reading:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1495" href="#t1495">1495</a></span><span class="t">                <span class="key">if</span> <span class="nam">sum</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1496" href="#t1496">1496</a></span><span class="t">                    <span class="key">for</span> <span class="nam">k</span><span class="op">,</span> <span class="nam">w</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1497" href="#t1497">1497</a></span><span class="t">                        <span class="nam">sequence</span> <span class="op">+=</span> <span class="str">"1"</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1498" href="#t1498">1498</a></span><span class="t">                        <span class="key">if</span> <span class="nam">k</span> <span class="op">&lt;</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="op">-</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1499" href="#t1499">1499</a></span><span class="t">                            <span class="nam">sequence</span> <span class="op">+=</span> <span class="str">", "</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1500" href="#t1500">1500</a></span><span class="t">                        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1501" href="#t1501">1501</a></span><span class="t">                            <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="op">></span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1502" href="#t1502">1502</a></span><span class="t">                                <span class="nam">sequence</span> <span class="op">+=</span> <span class="str">"; "</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1503" href="#t1503">1503</a></span><span class="t">                            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1504" href="#t1504">1504</a></span><span class="t">                                <span class="com"># If this site is a singleton site, then add a dummy state:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1505" href="#t1505">1505</a></span><span class="t">                                <span class="nam">sequence</span> <span class="op">+=</span> <span class="str">", 0; "</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1506" href="#t1506">1506</a></span><span class="t">                <span class="com"># Otherwise, read the probabilities as they are given:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1507" href="#t1507">1507</a></span><span class="t">                <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1508" href="#t1508">1508</a></span><span class="t">                    <span class="key">for</span> <span class="nam">k</span><span class="op">,</span> <span class="nam">w</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1509" href="#t1509">1509</a></span><span class="t">                        <span class="nam">sequence</span> <span class="op">+=</span> <span class="nam">str</span><span class="op">(</span><span class="nam">w</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1510" href="#t1510">1510</a></span><span class="t">                        <span class="key">if</span> <span class="nam">k</span> <span class="op">&lt;</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="op">-</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1511" href="#t1511">1511</a></span><span class="t">                            <span class="nam">sequence</span> <span class="op">+=</span> <span class="str">", "</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1512" href="#t1512">1512</a></span><span class="t">                        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1513" href="#t1513">1513</a></span><span class="t">                            <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="op">></span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1514" href="#t1514">1514</a></span><span class="t">                                <span class="nam">sequence</span> <span class="op">+=</span> <span class="str">"; "</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1515" href="#t1515">1515</a></span><span class="t">                            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1516" href="#t1516">1516</a></span><span class="t">                                <span class="com"># If this site is a singleton site, then add a dummy state:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1517" href="#t1517">1517</a></span><span class="t">                                <span class="nam">sequence</span> <span class="op">+=</span> <span class="str">", 0; "</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1518" href="#t1518">1518</a></span><span class="t">            <span class="com"># Strip the final semicolon and space from the sequence:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1519" href="#t1519">1519</a></span><span class="t">            <span class="nam">sequence</span> <span class="op">=</span> <span class="nam">sequence</span><span class="op">.</span><span class="nam">strip</span><span class="op">(</span><span class="str">"; "</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1520" href="#t1520">1520</a></span><span class="t">            <span class="com"># Then set the witness object's sequence attribute to this string:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1521" href="#t1521">1521</a></span><span class="t">            <span class="nam">witness_object</span><span class="op">[</span><span class="str">"sequence"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">sequence</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1522" href="#t1522">1522</a></span><span class="t">            <span class="nam">witness_objects</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">witness_object</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1523" href="#t1523">1523</a></span><span class="t">        <span class="com"># Then proceed to variation units:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1524" href="#t1524">1524</a></span><span class="t">        <span class="key">for</span> <span class="nam">j</span><span class="op">,</span> <span class="nam">vu</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">variation_units</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1525" href="#t1525">1525</a></span><span class="t">            <span class="key">if</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">id</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_ids_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1526" href="#t1526">1526</a></span><span class="t">                <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1527" href="#t1527">1527</a></span><span class="t">            <span class="nam">variation_unit_object</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1528" href="#t1528">1528</a></span><span class="t">            <span class="com"># Copy the ID of this variation unit:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1529" href="#t1529">1529</a></span><span class="t">            <span class="nam">variation_unit_object</span><span class="op">[</span><span class="str">"id"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1530" href="#t1530">1530</a></span><span class="t">            <span class="com"># Copy this variation unit's number of substantive readings,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1531" href="#t1531">1531</a></span><span class="t">            <span class="com"># setting it to 2 if it is a singleton unit:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1532" href="#t1532">1532</a></span><span class="t">            <span class="nam">variation_unit_object</span><span class="op">[</span><span class="str">"nstates"</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1533" href="#t1533">1533</a></span><span class="t">                <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1534" href="#t1534">1534</a></span><span class="t">                <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span> <span class="op">></span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1535" href="#t1535">1535</a></span><span class="t">                <span class="key">else</span> <span class="num">2</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1536" href="#t1536">1536</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1537" href="#t1537">1537</a></span><span class="t">            <span class="com"># Then construct the code map for this unit:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1538" href="#t1538">1538</a></span><span class="t">            <span class="nam">variation_unit_object</span><span class="op">[</span><span class="str">"code_map"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_beast_code_map_for_unit</span><span class="op">(</span><span class="nam">symbols</span><span class="op">,</span> <span class="nam">missing_symbol</span><span class="op">,</span> <span class="nam">j</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1539" href="#t1539">1539</a></span><span class="t">            <span class="com"># Then populate a comma-separated string of reading labels for this unit:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1540" href="#t1540">1540</a></span><span class="t">            <span class="nam">rdg_texts</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1541" href="#t1541">1541</a></span><span class="t">            <span class="nam">vu_label</span> <span class="op">=</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1542" href="#t1542">1542</a></span><span class="t">            <span class="key">for</span> <span class="nam">rdg</span> <span class="key">in</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">readings</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1543" href="#t1543">1543</a></span><span class="t">                <span class="nam">key</span> <span class="op">=</span> <span class="nam">tuple</span><span class="op">(</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1544" href="#t1544">1544</a></span><span class="t">                <span class="key">if</span> <span class="nam">key</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_reading_tuples_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1545" href="#t1545">1545</a></span><span class="t">                    <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1546" href="#t1546">1546</a></span><span class="t">                <span class="nam">rdg_text</span> <span class="op">=</span> <span class="nam">slugify</span><span class="op">(</span><span class="nam">rdg</span><span class="op">.</span><span class="nam">text</span><span class="op">,</span> <span class="nam">lowercase</span><span class="op">=</span><span class="key">False</span><span class="op">,</span> <span class="nam">allow_unicode</span><span class="op">=</span><span class="key">True</span><span class="op">,</span> <span class="nam">separator</span><span class="op">=</span><span class="str">'_'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1547" href="#t1547">1547</a></span><span class="t">                <span class="com"># Replace any empty reading text with an omission marker:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1548" href="#t1548">1548</a></span><span class="t">                <span class="key">if</span> <span class="nam">rdg_text</span> <span class="op">==</span> <span class="str">""</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1549" href="#t1549">1549</a></span><span class="t">                    <span class="nam">rdg_text</span> <span class="op">=</span> <span class="str">"om."</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1550" href="#t1550">1550</a></span><span class="t">                <span class="nam">rdg_texts</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">rdg_text</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1551" href="#t1551">1551</a></span><span class="t">            <span class="com"># If this site is a singleton site, then add a dummy reading for the dummy state:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1552" href="#t1552">1552</a></span><span class="t">            <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span> <span class="op">==</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1553" href="#t1553">1553</a></span><span class="t">                <span class="nam">rdg_texts</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="str">"DUMMY"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1554" href="#t1554">1554</a></span><span class="t">            <span class="nam">rdg_texts_string</span> <span class="op">=</span> <span class="str">", "</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="nam">rdg_texts</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1555" href="#t1555">1555</a></span><span class="t">            <span class="nam">variation_unit_object</span><span class="op">[</span><span class="str">"rdg_texts"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">rdg_texts_string</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1556" href="#t1556">1556</a></span><span class="t">            <span class="com"># Then populate this unit's equilibrium frequency string and its root frequency string:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1557" href="#t1557">1557</a></span><span class="t">            <span class="nam">variation_unit_object</span><span class="op">[</span><span class="str">"equilibrium_frequencies"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_beast_equilibrium_frequencies_for_unit</span><span class="op">(</span><span class="nam">j</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1558" href="#t1558">1558</a></span><span class="t">            <span class="nam">variation_unit_object</span><span class="op">[</span><span class="str">"root_frequencies"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_beast_root_frequencies_for_unit</span><span class="op">(</span><span class="nam">j</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1559" href="#t1559">1559</a></span><span class="t">            <span class="com"># Then populate a dictionary mapping epoch height ranges to lists of off-diagonal entries for substitution models:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1560" href="#t1560">1560</a></span><span class="t">            <span class="nam">rate_objects_by_epoch_height_range</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1561" href="#t1561">1561</a></span><span class="t">            <span class="nam">epoch_height_ranges</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1562" href="#t1562">1562</a></span><span class="t">            <span class="com"># Then proceed based on whether the transcriptional relations for this variation unit have been defined:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1563" href="#t1563">1563</a></span><span class="t">            <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">vu</span><span class="op">.</span><span class="nam">transcriptional_relations_by_date_range</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1564" href="#t1564">1564</a></span><span class="t">                <span class="com"># If there are no transcriptional relations, then map the epoch range of (None, None) to their list of off-diagonal entries:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1565" href="#t1565">1565</a></span><span class="t">                <span class="nam">epoch_height_ranges</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="op">(</span><span class="key">None</span><span class="op">,</span> <span class="key">None</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1566" href="#t1566">1566</a></span><span class="t">                <span class="nam">rate_objects_by_epoch_height_range</span><span class="op">[</span><span class="op">(</span><span class="key">None</span><span class="op">,</span> <span class="key">None</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1567" href="#t1567">1567</a></span><span class="t">                <span class="nam">rate_objects</span> <span class="op">=</span> <span class="nam">rate_objects_by_epoch_height_range</span><span class="op">[</span><span class="op">(</span><span class="key">None</span><span class="op">,</span> <span class="key">None</span><span class="op">)</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1568" href="#t1568">1568</a></span><span class="t">                <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span> <span class="op">==</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1569" href="#t1569">1569</a></span><span class="t">                    <span class="com"># If this is a singleton site, then use an arbitrary 2x2 rate matrix:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1570" href="#t1570">1570</a></span><span class="t">                    <span class="nam">rate_objects</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="op">{</span><span class="str">"transcriptional_categories"</span><span class="op">:</span> <span class="op">[</span><span class="str">"default"</span><span class="op">]</span><span class="op">,</span> <span class="str">"expression"</span><span class="op">:</span> <span class="key">None</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1571" href="#t1571">1571</a></span><span class="t">                    <span class="nam">rate_objects</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="op">{</span><span class="str">"transcriptional_categories"</span><span class="op">:</span> <span class="op">[</span><span class="str">"default"</span><span class="op">]</span><span class="op">,</span> <span class="str">"expression"</span><span class="op">:</span> <span class="key">None</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1572" href="#t1572">1572</a></span><span class="t">                <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1573" href="#t1573">1573</a></span><span class="t">                    <span class="com"># If this is a site with multiple substantive readings, but no transcriptional relations list,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1574" href="#t1574">1574</a></span><span class="t">                    <span class="com"># then use a Lewis Mk substitution matrix with the appropriate number of states:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1575" href="#t1575">1575</a></span><span class="t">                    <span class="key">for</span> <span class="nam">k_1</span><span class="op">,</span> <span class="nam">rdg_id_1</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1576" href="#t1576">1576</a></span><span class="t">                        <span class="key">for</span> <span class="nam">k_2</span><span class="op">,</span> <span class="nam">rdg_id_2</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1577" href="#t1577">1577</a></span><span class="t">                            <span class="com"># Skip diagonal elements:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1578" href="#t1578">1578</a></span><span class="t">                            <span class="key">if</span> <span class="nam">k_1</span> <span class="op">==</span> <span class="nam">k_2</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1579" href="#t1579">1579</a></span><span class="t">                                <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1580" href="#t1580">1580</a></span><span class="t">                            <span class="nam">rate_objects</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="op">{</span><span class="str">"transcriptional_categories"</span><span class="op">:</span> <span class="op">[</span><span class="str">"default"</span><span class="op">]</span><span class="op">,</span> <span class="str">"expression"</span><span class="op">:</span> <span class="key">None</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1581" href="#t1581">1581</a></span><span class="t">            <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1582" href="#t1582">1582</a></span><span class="t">                <span class="com"># Otherwise, proceed for every date range:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1583" href="#t1583">1583</a></span><span class="t">                <span class="key">for</span> <span class="nam">date_range</span> <span class="key">in</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">transcriptional_relations_by_date_range</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1584" href="#t1584">1584</a></span><span class="t">                    <span class="com"># Get the map of transcriptional relations for reference later:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1585" href="#t1585">1585</a></span><span class="t">                    <span class="nam">transcriptional_relations</span> <span class="op">=</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">transcriptional_relations_by_date_range</span><span class="op">[</span><span class="nam">date_range</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1586" href="#t1586">1586</a></span><span class="t">                    <span class="com"># Now get the epoch height range corresponding to this date range, and initialize its list in the dictionary:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1587" href="#t1587">1587</a></span><span class="t">                    <span class="nam">epoch_height_range</span> <span class="op">=</span> <span class="op">[</span><span class="key">None</span><span class="op">,</span> <span class="key">None</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1588" href="#t1588">1588</a></span><span class="t">                    <span class="nam">epoch_height_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="op">=</span> <span class="nam">tip_date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="op">-</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="key">if</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span> <span class="key">else</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1589" href="#t1589">1589</a></span><span class="t">                    <span class="nam">epoch_height_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="op">=</span> <span class="nam">tip_date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="op">-</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">if</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span> <span class="key">else</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1590" href="#t1590">1590</a></span><span class="t">                    <span class="nam">epoch_height_range</span> <span class="op">=</span> <span class="nam">tuple</span><span class="op">(</span><span class="nam">epoch_height_range</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1591" href="#t1591">1591</a></span><span class="t">                    <span class="nam">epoch_height_ranges</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">epoch_height_range</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1592" href="#t1592">1592</a></span><span class="t">                    <span class="nam">rate_objects_by_epoch_height_range</span><span class="op">[</span><span class="nam">epoch_height_range</span><span class="op">]</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1593" href="#t1593">1593</a></span><span class="t">                    <span class="nam">rate_objects</span> <span class="op">=</span> <span class="nam">rate_objects_by_epoch_height_range</span><span class="op">[</span><span class="nam">epoch_height_range</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1594" href="#t1594">1594</a></span><span class="t">                    <span class="com"># Then proceed for every pair of readings in this unit:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1595" href="#t1595">1595</a></span><span class="t">                    <span class="key">for</span> <span class="nam">k_1</span><span class="op">,</span> <span class="nam">rdg_id_1</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1596" href="#t1596">1596</a></span><span class="t">                        <span class="key">for</span> <span class="nam">k_2</span><span class="op">,</span> <span class="nam">rdg_id_2</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1597" href="#t1597">1597</a></span><span class="t">                            <span class="com"># Skip diagonal elements:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1598" href="#t1598">1598</a></span><span class="t">                            <span class="key">if</span> <span class="nam">k_1</span> <span class="op">==</span> <span class="nam">k_2</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1599" href="#t1599">1599</a></span><span class="t">                                <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1600" href="#t1600">1600</a></span><span class="t">                            <span class="com"># If the first reading has no transcriptional relation to the second in this unit, then use the default rate:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1601" href="#t1601">1601</a></span><span class="t">                            <span class="key">if</span> <span class="op">(</span><span class="nam">rdg_id_1</span><span class="op">,</span> <span class="nam">rdg_id_2</span><span class="op">)</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">transcriptional_relations</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1602" href="#t1602">1602</a></span><span class="t">                                <span class="nam">rate_objects</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="op">{</span><span class="str">"transcriptional_categories"</span><span class="op">:</span> <span class="op">[</span><span class="str">"default"</span><span class="op">]</span><span class="op">,</span> <span class="str">"expression"</span><span class="op">:</span> <span class="key">None</span><span class="op">}</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1603" href="#t1603">1603</a></span><span class="t">                                <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1604" href="#t1604">1604</a></span><span class="t">                            <span class="com"># Otherwise, if only one category of transcriptional relations holds between the first and second readings,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1605" href="#t1605">1605</a></span><span class="t">                            <span class="com"># then use its rate:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1606" href="#t1606">1606</a></span><span class="t">                            <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">transcriptional_relations</span><span class="op">[</span><span class="op">(</span><span class="nam">rdg_id_1</span><span class="op">,</span> <span class="nam">rdg_id_2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">==</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1607" href="#t1607">1607</a></span><span class="t">                                <span class="com"># If there is only one such category, then add its rate as a standalone var element:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1608" href="#t1608">1608</a></span><span class="t">                                <span class="nam">transcriptional_category</span> <span class="op">=</span> <span class="nam">list</span><span class="op">(</span><span class="nam">transcriptional_relations</span><span class="op">[</span><span class="op">(</span><span class="nam">rdg_id_1</span><span class="op">,</span> <span class="nam">rdg_id_2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1609" href="#t1609">1609</a></span><span class="t">                                <span class="nam">rate_objects</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1610" href="#t1610">1610</a></span><span class="t">                                    <span class="op">{</span><span class="str">"transcriptional_categories"</span><span class="op">:</span> <span class="op">[</span><span class="nam">transcriptional_category</span><span class="op">]</span><span class="op">,</span> <span class="str">"expression"</span><span class="op">:</span> <span class="key">None</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1611" href="#t1611">1611</a></span><span class="t">                                <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1612" href="#t1612">1612</a></span><span class="t">                                <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1613" href="#t1613">1613</a></span><span class="t">                            <span class="com"># If there is more than one, then add a var element that is a sum of the individual categories' rates:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1614" href="#t1614">1614</a></span><span class="t">                            <span class="nam">transcriptional_categories</span> <span class="op">=</span> <span class="nam">list</span><span class="op">(</span><span class="nam">transcriptional_relations</span><span class="op">[</span><span class="op">(</span><span class="nam">rdg_id_1</span><span class="op">,</span> <span class="nam">rdg_id_2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1615" href="#t1615">1615</a></span><span class="t">                            <span class="nam">args</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1616" href="#t1616">1616</a></span><span class="t">                            <span class="key">for</span> <span class="nam">transcriptional_category</span> <span class="key">in</span> <span class="nam">transcriptional_categories</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1617" href="#t1617">1617</a></span><span class="t">                                <span class="nam">args</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="str">"%s_rate"</span> <span class="op">%</span> <span class="nam">transcriptional_category</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1618" href="#t1618">1618</a></span><span class="t">                            <span class="nam">args_string</span> <span class="op">=</span> <span class="str">" "</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="nam">args</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1619" href="#t1619">1619</a></span><span class="t">                            <span class="nam">ops</span> <span class="op">=</span> <span class="op">[</span><span class="str">"+"</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">args</span><span class="op">)</span> <span class="op">-</span> <span class="num">1</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1620" href="#t1620">1620</a></span><span class="t">                            <span class="nam">ops_string</span> <span class="op">=</span> <span class="str">" "</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="nam">ops</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1621" href="#t1621">1621</a></span><span class="t">                            <span class="nam">expression_string</span> <span class="op">=</span> <span class="str">" "</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="op">[</span><span class="nam">args_string</span><span class="op">,</span> <span class="nam">ops_string</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1622" href="#t1622">1622</a></span><span class="t">                            <span class="nam">rate_objects</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1623" href="#t1623">1623</a></span><span class="t">                                <span class="op">{</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1624" href="#t1624">1624</a></span><span class="t">                                    <span class="str">"transcriptional_categories"</span><span class="op">:</span> <span class="nam">transcriptional_categories</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1625" href="#t1625">1625</a></span><span class="t">                                    <span class="str">"expression"</span><span class="op">:</span> <span class="nam">expression_string</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1626" href="#t1626">1626</a></span><span class="t">                                <span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1627" href="#t1627">1627</a></span><span class="t">                            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1628" href="#t1628">1628</a></span><span class="t">            <span class="com"># Now reorder the list of epoch height ranges, and get a list of non-null epoch dates in ascending order from the dictionary:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1629" href="#t1629">1629</a></span><span class="t">            <span class="nam">epoch_height_ranges</span><span class="op">.</span><span class="nam">reverse</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1630" href="#t1630">1630</a></span><span class="t">            <span class="nam">epoch_heights</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1631" href="#t1631">1631</a></span><span class="t">                <span class="nam">epoch_height_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">for</span> <span class="nam">epoch_height_range</span> <span class="key">in</span> <span class="nam">epoch_height_ranges</span> <span class="key">if</span> <span class="nam">epoch_height_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1632" href="#t1632">1632</a></span><span class="t">            <span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1633" href="#t1633">1633</a></span><span class="t">            <span class="com"># Then add all of these data structures to the variation unit object:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1634" href="#t1634">1634</a></span><span class="t">            <span class="nam">variation_unit_object</span><span class="op">[</span><span class="str">"epoch_heights"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">epoch_heights</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1635" href="#t1635">1635</a></span><span class="t">            <span class="nam">variation_unit_object</span><span class="op">[</span><span class="str">"epoch_heights_string"</span><span class="op">]</span> <span class="op">=</span> <span class="str">" "</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1636" href="#t1636">1636</a></span><span class="t">                <span class="op">[</span><span class="nam">str</span><span class="op">(</span><span class="nam">epoch_height</span><span class="op">)</span> <span class="key">for</span> <span class="nam">epoch_height</span> <span class="key">in</span> <span class="nam">epoch_heights</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1637" href="#t1637">1637</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1638" href="#t1638">1638</a></span><span class="t">            <span class="nam">variation_unit_object</span><span class="op">[</span><span class="str">"epoch_height_ranges"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">epoch_height_ranges</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1639" href="#t1639">1639</a></span><span class="t">            <span class="nam">variation_unit_object</span><span class="op">[</span><span class="str">"epoch_rates"</span><span class="op">]</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1640" href="#t1640">1640</a></span><span class="t">                <span class="nam">rate_objects_by_epoch_height_range</span><span class="op">[</span><span class="nam">epoch_height_range</span><span class="op">]</span> <span class="key">for</span> <span class="nam">epoch_height_range</span> <span class="key">in</span> <span class="nam">epoch_height_ranges</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1641" href="#t1641">1641</a></span><span class="t">            <span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1642" href="#t1642">1642</a></span><span class="t">            <span class="nam">variation_unit_objects</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">variation_unit_object</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1643" href="#t1643">1643</a></span><span class="t">        <span class="com"># Then proceed to intrinsic odds categories:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1644" href="#t1644">1644</a></span><span class="t">        <span class="key">for</span> <span class="nam">intrinsic_category</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">intrinsic_categories</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1645" href="#t1645">1645</a></span><span class="t">            <span class="nam">intrinsic_category_object</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1646" href="#t1646">1646</a></span><span class="t">            <span class="com"># Copy the ID of this intrinsic category:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1647" href="#t1647">1647</a></span><span class="t">            <span class="nam">intrinsic_category_object</span><span class="op">[</span><span class="str">"id"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">intrinsic_category</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1648" href="#t1648">1648</a></span><span class="t">            <span class="com"># Then copy the odds factors associated with this intrinsic category,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1649" href="#t1649">1649</a></span><span class="t">            <span class="com"># setting it to 1.0 if it is not specified and setting the estimate attribute accordingly:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1650" href="#t1650">1650</a></span><span class="t">            <span class="nam">odds</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">intrinsic_odds_by_id</span><span class="op">[</span><span class="nam">intrinsic_category</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1651" href="#t1651">1651</a></span><span class="t">            <span class="nam">intrinsic_category_object</span><span class="op">[</span><span class="str">"odds"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">odds</span> <span class="key">if</span> <span class="nam">odds</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span> <span class="key">else</span> <span class="num">1.0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1652" href="#t1652">1652</a></span><span class="t">            <span class="nam">intrinsic_category_object</span><span class="op">[</span><span class="str">"estimate"</span><span class="op">]</span> <span class="op">=</span> <span class="str">"false"</span> <span class="key">if</span> <span class="nam">odds</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span> <span class="key">else</span> <span class="str">"true"</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1653" href="#t1653">1653</a></span><span class="t">            <span class="nam">intrinsic_category_objects</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">intrinsic_category_object</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1654" href="#t1654">1654</a></span><span class="t">        <span class="com"># Then proceed to transcriptional rate categories:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1655" href="#t1655">1655</a></span><span class="t">        <span class="nam">rng</span> <span class="op">=</span> <span class="nam">np</span><span class="op">.</span><span class="nam">random</span><span class="op">.</span><span class="nam">default_rng</span><span class="op">(</span><span class="nam">seed</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1656" href="#t1656">1656</a></span><span class="t">        <span class="key">for</span> <span class="nam">transcriptional_category</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">transcriptional_categories</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1657" href="#t1657">1657</a></span><span class="t">            <span class="nam">transcriptional_category_object</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1658" href="#t1658">1658</a></span><span class="t">            <span class="com"># Copy the ID of this transcriptional category:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1659" href="#t1659">1659</a></span><span class="t">            <span class="nam">transcriptional_category_object</span><span class="op">[</span><span class="str">"id"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">transcriptional_category</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1660" href="#t1660">1660</a></span><span class="t">            <span class="com"># Then copy the rate of this transcriptional category,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1661" href="#t1661">1661</a></span><span class="t">            <span class="com"># setting it to a random number sampled from a Gamma distribution if it is not specified and setting the estimate attribute accordingly:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1662" href="#t1662">1662</a></span><span class="t">            <span class="nam">rate</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">transcriptional_rates_by_id</span><span class="op">[</span><span class="nam">transcriptional_category</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1663" href="#t1663">1663</a></span><span class="t">            <span class="nam">transcriptional_category_object</span><span class="op">[</span><span class="str">"rate"</span><span class="op">]</span> <span class="op">=</span> <span class="nam">rate</span> <span class="key">if</span> <span class="nam">rate</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span> <span class="key">else</span> <span class="nam">rng</span><span class="op">.</span><span class="nam">gamma</span><span class="op">(</span><span class="num">5.0</span><span class="op">,</span> <span class="num">2.0</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1664" href="#t1664">1664</a></span><span class="t">            <span class="nam">transcriptional_category_object</span><span class="op">[</span><span class="str">"estimate"</span><span class="op">]</span> <span class="op">=</span> <span class="str">"false"</span> <span class="key">if</span> <span class="nam">rate</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span> <span class="key">else</span> <span class="str">"true"</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1665" href="#t1665">1665</a></span><span class="t">            <span class="nam">transcriptional_category_objects</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">transcriptional_category_object</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1666" href="#t1666">1666</a></span><span class="t">        <span class="com"># Now render the output XML file using the Jinja template:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1667" href="#t1667">1667</a></span><span class="t">        <span class="nam">env</span> <span class="op">=</span> <span class="nam">Environment</span><span class="op">(</span><span class="nam">loader</span><span class="op">=</span><span class="nam">PackageLoader</span><span class="op">(</span><span class="str">"teiphy"</span><span class="op">,</span> <span class="str">"templates"</span><span class="op">)</span><span class="op">,</span> <span class="nam">autoescape</span><span class="op">=</span><span class="nam">select_autoescape</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1668" href="#t1668">1668</a></span><span class="t">        <span class="nam">template</span> <span class="op">=</span> <span class="nam">env</span><span class="op">.</span><span class="nam">get_template</span><span class="op">(</span><span class="str">"beast_template.xml"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1669" href="#t1669">1669</a></span><span class="t">        <span class="nam">rendered</span> <span class="op">=</span> <span class="nam">template</span><span class="op">.</span><span class="nam">render</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1670" href="#t1670">1670</a></span><span class="t">            <span class="nam">nsymbols</span><span class="op">=</span><span class="nam">len</span><span class="op">(</span><span class="nam">symbols</span><span class="op">)</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1671" href="#t1671">1671</a></span><span class="t">            <span class="nam">date_map</span><span class="op">=</span><span class="nam">date_map</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1672" href="#t1672">1672</a></span><span class="t">            <span class="nam">origin_span</span><span class="op">=</span><span class="nam">origin_span</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1673" href="#t1673">1673</a></span><span class="t">            <span class="nam">clock_model</span><span class="op">=</span><span class="nam">clock_model</span><span class="op">.</span><span class="nam">value</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1674" href="#t1674">1674</a></span><span class="t">            <span class="nam">clock_rate_categories</span><span class="op">=</span><span class="num">2</span> <span class="op">*</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span> <span class="op">-</span> <span class="num">1</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1675" href="#t1675">1675</a></span><span class="t">            <span class="nam">ancestral_logger</span><span class="op">=</span><span class="nam">ancestral_logger</span><span class="op">.</span><span class="nam">value</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1676" href="#t1676">1676</a></span><span class="t">            <span class="nam">witnesses</span><span class="op">=</span><span class="nam">witness_objects</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1677" href="#t1677">1677</a></span><span class="t">            <span class="nam">variation_units</span><span class="op">=</span><span class="nam">variation_unit_objects</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1678" href="#t1678">1678</a></span><span class="t">            <span class="nam">intrinsic_categories</span><span class="op">=</span><span class="nam">intrinsic_category_objects</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1679" href="#t1679">1679</a></span><span class="t">            <span class="nam">transcriptional_categories</span><span class="op">=</span><span class="nam">transcriptional_category_objects</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1680" href="#t1680">1680</a></span><span class="t">        <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1681" href="#t1681">1681</a></span><span class="t">        <span class="com"># Generate all parent folders for this file that don't already exist:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1682" href="#t1682">1682</a></span><span class="t">        <span class="nam">Path</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">)</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">mkdir</span><span class="op">(</span><span class="nam">parents</span><span class="op">=</span><span class="key">True</span><span class="op">,</span> <span class="nam">exist_ok</span><span class="op">=</span><span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1683" href="#t1683">1683</a></span><span class="t">        <span class="key">with</span> <span class="nam">open</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">,</span> <span class="str">"w"</span><span class="op">,</span> <span class="nam">encoding</span><span class="op">=</span><span class="str">"utf-8"</span><span class="op">)</span> <span class="key">as</span> <span class="nam">f</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1684" href="#t1684">1684</a></span><span class="t">            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="nam">rendered</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1685" href="#t1685">1685</a></span><span class="t">        <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1686" href="#t1686">1686</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1687" href="#t1687">1687</a></span><span class="t">    <span class="key">def</span> <span class="nam">to_numpy</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">drop_constant</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span> <span class="nam">split_missing</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">True</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1688" href="#t1688">1688</a></span><span class="t">        <span class="str">"""Returns this Collation in the form of a NumPy array, along with arrays of its row and column labels.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1689" href="#t1689">1689</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1690" href="#t1690">1690</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1691" href="#t1691">1691</a></span><span class="t"><span class="str">            drop_constant (bool, optional): An optional flag indicating whether to ignore variation units with one substantive reading.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1692" href="#t1692">1692</a></span><span class="t"><span class="str">            split_missing: An optional flag indicating whether or not to treat missing characters/variation units as having a contribution of 1 split over all states/readings; if False, then missing data is ignored (i.e., all states are 0). Default value is True.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1693" href="#t1693">1693</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1694" href="#t1694">1694</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1695" href="#t1695">1695</a></span><span class="t"><span class="str">            A NumPy array with a row for each substantive reading and a column for each witness.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1696" href="#t1696">1696</a></span><span class="t"><span class="str">            A list of substantive reading ID strings.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1697" href="#t1697">1697</a></span><span class="t"><span class="str">            A list of witness ID strings.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1698" href="#t1698">1698</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1699" href="#t1699">1699</a></span><span class="t">        <span class="com"># Populate a list of sites that will correspond to columns of the sequence alignment:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1700" href="#t1700">1700</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1701" href="#t1701">1701</a></span><span class="t">        <span class="key">if</span> <span class="nam">drop_constant</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1702" href="#t1702">1702</a></span><span class="t">            <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1703" href="#t1703">1703</a></span><span class="t">                <span class="nam">vu_id</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1704" href="#t1704">1704</a></span><span class="t">                <span class="key">for</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1705" href="#t1705">1705</a></span><span class="t">                <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu_id</span><span class="op">]</span><span class="op">)</span> <span class="op">></span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1706" href="#t1706">1706</a></span><span class="t">            <span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1707" href="#t1707">1707</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">substantive_variation_unit_ids</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1708" href="#t1708">1708</a></span><span class="t">        <span class="nam">substantive_variation_unit_reading_tuples_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_variation_unit_reading_tuples</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1709" href="#t1709">1709</a></span><span class="t">        <span class="com"># Initialize the output array with the appropriate dimensions:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1710" href="#t1710">1710</a></span><span class="t">        <span class="nam">reading_labels</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1711" href="#t1711">1711</a></span><span class="t">        <span class="key">for</span> <span class="nam">vu</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_units</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1712" href="#t1712">1712</a></span><span class="t">            <span class="key">if</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">id</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_ids_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1713" href="#t1713">1713</a></span><span class="t">                <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1714" href="#t1714">1714</a></span><span class="t">            <span class="key">for</span> <span class="nam">rdg</span> <span class="key">in</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">readings</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1715" href="#t1715">1715</a></span><span class="t">                <span class="nam">key</span> <span class="op">=</span> <span class="nam">tuple</span><span class="op">(</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1716" href="#t1716">1716</a></span><span class="t">                <span class="key">if</span> <span class="nam">key</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_reading_tuples_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1717" href="#t1717">1717</a></span><span class="t">                    <span class="nam">reading_labels</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span> <span class="op">+</span> <span class="str">", "</span> <span class="op">+</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">text</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1718" href="#t1718">1718</a></span><span class="t">        <span class="nam">witness_labels</span> <span class="op">=</span> <span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span> <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1719" href="#t1719">1719</a></span><span class="t">        <span class="nam">matrix</span> <span class="op">=</span> <span class="nam">np</span><span class="op">.</span><span class="nam">zeros</span><span class="op">(</span><span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">reading_labels</span><span class="op">)</span><span class="op">,</span> <span class="nam">len</span><span class="op">(</span><span class="nam">witness_labels</span><span class="op">)</span><span class="op">)</span><span class="op">,</span> <span class="nam">dtype</span><span class="op">=</span><span class="nam">float</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1720" href="#t1720">1720</a></span><span class="t">        <span class="com"># Then populate it with the appropriate values:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1721" href="#t1721">1721</a></span><span class="t">        <span class="nam">col_ind</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1722" href="#t1722">1722</a></span><span class="t">        <span class="key">for</span> <span class="nam">i</span><span class="op">,</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1723" href="#t1723">1723</a></span><span class="t">            <span class="nam">row_ind</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1724" href="#t1724">1724</a></span><span class="t">            <span class="key">for</span> <span class="nam">j</span><span class="op">,</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1725" href="#t1725">1725</a></span><span class="t">                <span class="key">if</span> <span class="nam">vu_id</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_ids_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1726" href="#t1726">1726</a></span><span class="t">                    <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1727" href="#t1727">1727</a></span><span class="t">                <span class="nam">rdg_support</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">[</span><span class="nam">j</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1728" href="#t1728">1728</a></span><span class="t">                <span class="com"># If this reading support vector sums to 0, then this is missing data; handle it as specified:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1729" href="#t1729">1729</a></span><span class="t">                <span class="key">if</span> <span class="nam">sum</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1730" href="#t1730">1730</a></span><span class="t">                    <span class="key">if</span> <span class="nam">split_missing</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1731" href="#t1731">1731</a></span><span class="t">                        <span class="key">for</span> <span class="nam">i</span> <span class="key">in</span> <span class="nam">range</span><span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1732" href="#t1732">1732</a></span><span class="t">                            <span class="nam">matrix</span><span class="op">[</span><span class="nam">row_ind</span><span class="op">,</span> <span class="nam">col_ind</span><span class="op">]</span> <span class="op">=</span> <span class="num">1</span> <span class="op">/</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1733" href="#t1733">1733</a></span><span class="t">                            <span class="nam">row_ind</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1734" href="#t1734">1734</a></span><span class="t">                    <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1735" href="#t1735">1735</a></span><span class="t">                        <span class="nam">row_ind</span> <span class="op">+=</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1736" href="#t1736">1736</a></span><span class="t">                <span class="com"># Otherwise, add its coefficients normally:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1737" href="#t1737">1737</a></span><span class="t">                <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1738" href="#t1738">1738</a></span><span class="t">                    <span class="key">for</span> <span class="nam">i</span> <span class="key">in</span> <span class="nam">range</span><span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1739" href="#t1739">1739</a></span><span class="t">                        <span class="nam">matrix</span><span class="op">[</span><span class="nam">row_ind</span><span class="op">,</span> <span class="nam">col_ind</span><span class="op">]</span> <span class="op">=</span> <span class="nam">rdg_support</span><span class="op">[</span><span class="nam">i</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1740" href="#t1740">1740</a></span><span class="t">                        <span class="nam">row_ind</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1741" href="#t1741">1741</a></span><span class="t">            <span class="nam">col_ind</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1742" href="#t1742">1742</a></span><span class="t">        <span class="key">return</span> <span class="nam">matrix</span><span class="op">,</span> <span class="nam">reading_labels</span><span class="op">,</span> <span class="nam">witness_labels</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1743" href="#t1743">1743</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1744" href="#t1744">1744</a></span><span class="t">    <span class="key">def</span> <span class="nam">to_distance_matrix</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">drop_constant</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span> <span class="nam">proportion</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span> <span class="nam">show_ext</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1745" href="#t1745">1745</a></span><span class="t">        <span class="str">"""Transforms this Collation into a NumPy distance matrix between witnesses, along with an array of its labels for the witnesses.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1746" href="#t1746">1746</a></span><span class="t"><span class="str">        Distances can be computed either as counts of disagreements (the default setting), or as proportions of disagreements over all variation units where both witnesses have singleton readings.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1747" href="#t1747">1747</a></span><span class="t"><span class="str">        Optionally, the count of units where both witnesses have singleton readings can be included after the count/proportion of disagreements.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1748" href="#t1748">1748</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1749" href="#t1749">1749</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1750" href="#t1750">1750</a></span><span class="t"><span class="str">            drop_constant (bool, optional): An optional flag indicating whether to ignore variation units with one substantive reading.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1751" href="#t1751">1751</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1752" href="#t1752">1752</a></span><span class="t"><span class="str">            proportion (bool, optional): An optional flag indicating whether or not to calculate distances as proportions over extant, unambiguous variation units.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1753" href="#t1753">1753</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1754" href="#t1754">1754</a></span><span class="t"><span class="str">            show_ext: An optional flag indicating whether each cell in a distance or similarity matrix</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1755" href="#t1755">1755</a></span><span class="t"><span class="str">                should include the number of their extant, unambiguous variation units after the number of their disagreements.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1756" href="#t1756">1756</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1757" href="#t1757">1757</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1758" href="#t1758">1758</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1759" href="#t1759">1759</a></span><span class="t"><span class="str">            A NumPy distance matrix with a row and column for each witness.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1760" href="#t1760">1760</a></span><span class="t"><span class="str">            A list of witness ID strings.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1761" href="#t1761">1761</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1762" href="#t1762">1762</a></span><span class="t">        <span class="com"># Populate a list of sites that will correspond to columns of the sequence alignment:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1763" href="#t1763">1763</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1764" href="#t1764">1764</a></span><span class="t">        <span class="key">if</span> <span class="nam">drop_constant</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1765" href="#t1765">1765</a></span><span class="t">            <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1766" href="#t1766">1766</a></span><span class="t">                <span class="nam">vu_id</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1767" href="#t1767">1767</a></span><span class="t">                <span class="key">for</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1768" href="#t1768">1768</a></span><span class="t">                <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu_id</span><span class="op">]</span><span class="op">)</span> <span class="op">></span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1769" href="#t1769">1769</a></span><span class="t">            <span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1770" href="#t1770">1770</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">substantive_variation_unit_ids</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1771" href="#t1771">1771</a></span><span class="t">        <span class="nam">substantive_variation_unit_reading_tuples_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_variation_unit_reading_tuples</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1772" href="#t1772">1772</a></span><span class="t">        <span class="com"># Initialize the output array with the appropriate dimensions:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1773" href="#t1773">1773</a></span><span class="t">        <span class="nam">witness_labels</span> <span class="op">=</span> <span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span> <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1774" href="#t1774">1774</a></span><span class="t">        <span class="com"># The type of the matrix will depend on the input options:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1775" href="#t1775">1775</a></span><span class="t">        <span class="nam">matrix</span> <span class="op">=</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1776" href="#t1776">1776</a></span><span class="t">        <span class="key">if</span> <span class="nam">show_ext</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1777" href="#t1777">1777</a></span><span class="t">            <span class="nam">matrix</span> <span class="op">=</span> <span class="nam">np</span><span class="op">.</span><span class="nam">full</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1778" href="#t1778">1778</a></span><span class="t">                <span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">witness_labels</span><span class="op">)</span><span class="op">,</span> <span class="nam">len</span><span class="op">(</span><span class="nam">witness_labels</span><span class="op">)</span><span class="op">)</span><span class="op">,</span> <span class="str">"NA"</span><span class="op">,</span> <span class="nam">dtype</span><span class="op">=</span><span class="nam">object</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1779" href="#t1779">1779</a></span><span class="t">            <span class="op">)</span>  <span class="com"># strings of the form "disagreements/extant"</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1780" href="#t1780">1780</a></span><span class="t">        <span class="key">elif</span> <span class="nam">proportion</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1781" href="#t1781">1781</a></span><span class="t">            <span class="nam">matrix</span> <span class="op">=</span> <span class="nam">np</span><span class="op">.</span><span class="nam">full</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1782" href="#t1782">1782</a></span><span class="t">                <span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">witness_labels</span><span class="op">)</span><span class="op">,</span> <span class="nam">len</span><span class="op">(</span><span class="nam">witness_labels</span><span class="op">)</span><span class="op">)</span><span class="op">,</span> <span class="num">0.0</span><span class="op">,</span> <span class="nam">dtype</span><span class="op">=</span><span class="nam">float</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1783" href="#t1783">1783</a></span><span class="t">            <span class="op">)</span>  <span class="com"># floats of the form disagreements/extant</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1784" href="#t1784">1784</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1785" href="#t1785">1785</a></span><span class="t">            <span class="nam">matrix</span> <span class="op">=</span> <span class="nam">np</span><span class="op">.</span><span class="nam">full</span><span class="op">(</span><span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">witness_labels</span><span class="op">)</span><span class="op">,</span> <span class="nam">len</span><span class="op">(</span><span class="nam">witness_labels</span><span class="op">)</span><span class="op">)</span><span class="op">,</span> <span class="num">0</span><span class="op">,</span> <span class="nam">dtype</span><span class="op">=</span><span class="nam">int</span><span class="op">)</span>  <span class="com"># ints of the form disagreements</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1786" href="#t1786">1786</a></span><span class="t">        <span class="key">for</span> <span class="nam">i</span><span class="op">,</span> <span class="nam">wit_1</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">witness_labels</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1787" href="#t1787">1787</a></span><span class="t">            <span class="key">for</span> <span class="nam">j</span><span class="op">,</span> <span class="nam">wit_2</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">witness_labels</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1788" href="#t1788">1788</a></span><span class="t">                <span class="nam">extant_units</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1789" href="#t1789">1789</a></span><span class="t">                <span class="nam">disagreements</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1790" href="#t1790">1790</a></span><span class="t">                <span class="com"># If either of the cells for this pair of witnesses has been populated already,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1791" href="#t1791">1791</a></span><span class="t">                <span class="com"># then just copy the entry from the other side of the diagonal without recalculating:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1792" href="#t1792">1792</a></span><span class="t">                <span class="key">if</span> <span class="nam">i</span> <span class="op">></span> <span class="nam">j</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1793" href="#t1793">1793</a></span><span class="t">                    <span class="nam">matrix</span><span class="op">[</span><span class="nam">i</span><span class="op">,</span> <span class="nam">j</span><span class="op">]</span> <span class="op">=</span> <span class="nam">matrix</span><span class="op">[</span><span class="nam">j</span><span class="op">,</span> <span class="nam">i</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1794" href="#t1794">1794</a></span><span class="t">                    <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1795" href="#t1795">1795</a></span><span class="t">                <span class="com"># Otherwise, calculate the number of units where both witnesses have unambiguous readings</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1796" href="#t1796">1796</a></span><span class="t">                <span class="com"># and the number of units where they disagree:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1797" href="#t1797">1797</a></span><span class="t">                <span class="key">for</span> <span class="nam">k</span><span class="op">,</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1798" href="#t1798">1798</a></span><span class="t">                    <span class="key">if</span> <span class="nam">vu_id</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_ids_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1799" href="#t1799">1799</a></span><span class="t">                        <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1800" href="#t1800">1800</a></span><span class="t">                    <span class="nam">wit_1_rdg_support</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit_1</span><span class="op">]</span><span class="op">[</span><span class="nam">k</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1801" href="#t1801">1801</a></span><span class="t">                    <span class="nam">wit_2_rdg_support</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit_2</span><span class="op">]</span><span class="op">[</span><span class="nam">k</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1802" href="#t1802">1802</a></span><span class="t">                    <span class="nam">wit_1_rdg_inds</span> <span class="op">=</span> <span class="op">[</span><span class="nam">l</span> <span class="key">for</span> <span class="nam">l</span><span class="op">,</span> <span class="nam">w</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">wit_1_rdg_support</span><span class="op">)</span> <span class="key">if</span> <span class="nam">w</span> <span class="op">></span> <span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1803" href="#t1803">1803</a></span><span class="t">                    <span class="nam">wit_2_rdg_inds</span> <span class="op">=</span> <span class="op">[</span><span class="nam">l</span> <span class="key">for</span> <span class="nam">l</span><span class="op">,</span> <span class="nam">w</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">wit_2_rdg_support</span><span class="op">)</span> <span class="key">if</span> <span class="nam">w</span> <span class="op">></span> <span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1804" href="#t1804">1804</a></span><span class="t">                    <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">wit_1_rdg_inds</span><span class="op">)</span> <span class="op">!=</span> <span class="num">1</span> <span class="key">or</span> <span class="nam">len</span><span class="op">(</span><span class="nam">wit_2_rdg_inds</span><span class="op">)</span> <span class="op">!=</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1805" href="#t1805">1805</a></span><span class="t">                        <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1806" href="#t1806">1806</a></span><span class="t">                    <span class="nam">extant_units</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1807" href="#t1807">1807</a></span><span class="t">                    <span class="key">if</span> <span class="nam">wit_1_rdg_inds</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="op">!=</span> <span class="nam">wit_2_rdg_inds</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1808" href="#t1808">1808</a></span><span class="t">                        <span class="nam">disagreements</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1809" href="#t1809">1809</a></span><span class="t">                <span class="nam">cell_entry</span> <span class="op">=</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1810" href="#t1810">1810</a></span><span class="t">                <span class="key">if</span> <span class="nam">proportion</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1811" href="#t1811">1811</a></span><span class="t">                    <span class="nam">cell_entry</span> <span class="op">=</span> <span class="nam">disagreements</span> <span class="op">/</span> <span class="nam">max</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1812" href="#t1812">1812</a></span><span class="t">                        <span class="nam">extant_units</span><span class="op">,</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1813" href="#t1813">1813</a></span><span class="t">                    <span class="op">)</span>  <span class="com"># the max in the denominator is to prevent division by 0; the distance entry will be 0 if the two witnesses have no overlap</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1814" href="#t1814">1814</a></span><span class="t">                <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1815" href="#t1815">1815</a></span><span class="t">                    <span class="nam">cell_entry</span> <span class="op">=</span> <span class="nam">disagreements</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1816" href="#t1816">1816</a></span><span class="t">                <span class="key">if</span> <span class="nam">show_ext</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1817" href="#t1817">1817</a></span><span class="t">                    <span class="nam">cell_entry</span> <span class="op">=</span> <span class="nam">str</span><span class="op">(</span><span class="nam">cell_entry</span><span class="op">)</span> <span class="op">+</span> <span class="str">"/"</span> <span class="op">+</span> <span class="nam">str</span><span class="op">(</span><span class="nam">extant_units</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1818" href="#t1818">1818</a></span><span class="t">                <span class="nam">matrix</span><span class="op">[</span><span class="nam">i</span><span class="op">,</span> <span class="nam">j</span><span class="op">]</span> <span class="op">=</span> <span class="nam">cell_entry</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1819" href="#t1819">1819</a></span><span class="t">        <span class="key">return</span> <span class="nam">matrix</span><span class="op">,</span> <span class="nam">witness_labels</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1820" href="#t1820">1820</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1821" href="#t1821">1821</a></span><span class="t">    <span class="key">def</span> <span class="nam">to_similarity_matrix</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">drop_constant</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span> <span class="nam">proportion</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span> <span class="nam">show_ext</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1822" href="#t1822">1822</a></span><span class="t">        <span class="str">"""Transforms this Collation into a NumPy similarity matrix between witnesses, along with an array of its labels for the witnesses.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1823" href="#t1823">1823</a></span><span class="t"><span class="str">        Similarities can be computed either as counts of agreements (the default setting), or as proportions of agreements over all variation units where both witnesses have singleton readings.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1824" href="#t1824">1824</a></span><span class="t"><span class="str">        Optionally, the count of units where both witnesses have singleton readings can be included after the count/proportion of agreements.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1825" href="#t1825">1825</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1826" href="#t1826">1826</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1827" href="#t1827">1827</a></span><span class="t"><span class="str">            drop_constant (bool, optional): An optional flag indicating whether to ignore variation units with one substantive reading.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1828" href="#t1828">1828</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1829" href="#t1829">1829</a></span><span class="t"><span class="str">            proportion (bool, optional): An optional flag indicating whether or not to calculate similarities as proportions over extant, unambiguous variation units.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1830" href="#t1830">1830</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1831" href="#t1831">1831</a></span><span class="t"><span class="str">            show_ext: An optional flag indicating whether each cell in a distance or similarity matrix</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1832" href="#t1832">1832</a></span><span class="t"><span class="str">                should include the number of their extant, unambiguous variation units after the number of agreements.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1833" href="#t1833">1833</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1834" href="#t1834">1834</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1835" href="#t1835">1835</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1836" href="#t1836">1836</a></span><span class="t"><span class="str">            A NumPy distance matrix with a row and column for each witness.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1837" href="#t1837">1837</a></span><span class="t"><span class="str">            A list of witness ID strings.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1838" href="#t1838">1838</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1839" href="#t1839">1839</a></span><span class="t">        <span class="com"># Populate a list of sites that will correspond to columns of the sequence alignment:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1840" href="#t1840">1840</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1841" href="#t1841">1841</a></span><span class="t">        <span class="key">if</span> <span class="nam">drop_constant</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1842" href="#t1842">1842</a></span><span class="t">            <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1843" href="#t1843">1843</a></span><span class="t">                <span class="nam">vu_id</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1844" href="#t1844">1844</a></span><span class="t">                <span class="key">for</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1845" href="#t1845">1845</a></span><span class="t">                <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu_id</span><span class="op">]</span><span class="op">)</span> <span class="op">></span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1846" href="#t1846">1846</a></span><span class="t">            <span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1847" href="#t1847">1847</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">substantive_variation_unit_ids</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1848" href="#t1848">1848</a></span><span class="t">        <span class="nam">substantive_variation_unit_reading_tuples_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_variation_unit_reading_tuples</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1849" href="#t1849">1849</a></span><span class="t">        <span class="com"># Initialize the output array with the appropriate dimensions:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1850" href="#t1850">1850</a></span><span class="t">        <span class="nam">witness_labels</span> <span class="op">=</span> <span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span> <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1851" href="#t1851">1851</a></span><span class="t">        <span class="com"># The type of the matrix will depend on the input options:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1852" href="#t1852">1852</a></span><span class="t">        <span class="nam">matrix</span> <span class="op">=</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1853" href="#t1853">1853</a></span><span class="t">        <span class="key">if</span> <span class="nam">show_ext</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1854" href="#t1854">1854</a></span><span class="t">            <span class="nam">matrix</span> <span class="op">=</span> <span class="nam">np</span><span class="op">.</span><span class="nam">full</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1855" href="#t1855">1855</a></span><span class="t">                <span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">witness_labels</span><span class="op">)</span><span class="op">,</span> <span class="nam">len</span><span class="op">(</span><span class="nam">witness_labels</span><span class="op">)</span><span class="op">)</span><span class="op">,</span> <span class="str">"NA"</span><span class="op">,</span> <span class="nam">dtype</span><span class="op">=</span><span class="nam">object</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1856" href="#t1856">1856</a></span><span class="t">            <span class="op">)</span>  <span class="com"># strings of the form "agreements/extant"</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1857" href="#t1857">1857</a></span><span class="t">        <span class="key">elif</span> <span class="nam">proportion</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1858" href="#t1858">1858</a></span><span class="t">            <span class="nam">matrix</span> <span class="op">=</span> <span class="nam">np</span><span class="op">.</span><span class="nam">full</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1859" href="#t1859">1859</a></span><span class="t">                <span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">witness_labels</span><span class="op">)</span><span class="op">,</span> <span class="nam">len</span><span class="op">(</span><span class="nam">witness_labels</span><span class="op">)</span><span class="op">)</span><span class="op">,</span> <span class="num">0.0</span><span class="op">,</span> <span class="nam">dtype</span><span class="op">=</span><span class="nam">float</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1860" href="#t1860">1860</a></span><span class="t">            <span class="op">)</span>  <span class="com"># floats of the form agreements/extant</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1861" href="#t1861">1861</a></span><span class="t">        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1862" href="#t1862">1862</a></span><span class="t">            <span class="nam">matrix</span> <span class="op">=</span> <span class="nam">np</span><span class="op">.</span><span class="nam">full</span><span class="op">(</span><span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">witness_labels</span><span class="op">)</span><span class="op">,</span> <span class="nam">len</span><span class="op">(</span><span class="nam">witness_labels</span><span class="op">)</span><span class="op">)</span><span class="op">,</span> <span class="num">0</span><span class="op">,</span> <span class="nam">dtype</span><span class="op">=</span><span class="nam">int</span><span class="op">)</span>  <span class="com"># ints of the form agreements</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1863" href="#t1863">1863</a></span><span class="t">        <span class="key">for</span> <span class="nam">i</span><span class="op">,</span> <span class="nam">wit_1</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">witness_labels</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1864" href="#t1864">1864</a></span><span class="t">            <span class="key">for</span> <span class="nam">j</span><span class="op">,</span> <span class="nam">wit_2</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">witness_labels</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1865" href="#t1865">1865</a></span><span class="t">                <span class="nam">extant_units</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1866" href="#t1866">1866</a></span><span class="t">                <span class="nam">agreements</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1867" href="#t1867">1867</a></span><span class="t">                <span class="com"># If either of the cells for this pair of witnesses has been populated already,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1868" href="#t1868">1868</a></span><span class="t">                <span class="com"># then just copy the entry from the other side of the diagonal without recalculating:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1869" href="#t1869">1869</a></span><span class="t">                <span class="key">if</span> <span class="nam">i</span> <span class="op">></span> <span class="nam">j</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1870" href="#t1870">1870</a></span><span class="t">                    <span class="nam">matrix</span><span class="op">[</span><span class="nam">i</span><span class="op">,</span> <span class="nam">j</span><span class="op">]</span> <span class="op">=</span> <span class="nam">matrix</span><span class="op">[</span><span class="nam">j</span><span class="op">,</span> <span class="nam">i</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1871" href="#t1871">1871</a></span><span class="t">                    <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1872" href="#t1872">1872</a></span><span class="t">                <span class="com"># Otherwise, calculate the number of units where both witnesses have unambiguous readings</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1873" href="#t1873">1873</a></span><span class="t">                <span class="com"># and the number of units where they agree:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1874" href="#t1874">1874</a></span><span class="t">                <span class="key">for</span> <span class="nam">k</span><span class="op">,</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1875" href="#t1875">1875</a></span><span class="t">                    <span class="key">if</span> <span class="nam">vu_id</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_ids_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1876" href="#t1876">1876</a></span><span class="t">                        <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1877" href="#t1877">1877</a></span><span class="t">                    <span class="nam">wit_1_rdg_support</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit_1</span><span class="op">]</span><span class="op">[</span><span class="nam">k</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1878" href="#t1878">1878</a></span><span class="t">                    <span class="nam">wit_2_rdg_support</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit_2</span><span class="op">]</span><span class="op">[</span><span class="nam">k</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1879" href="#t1879">1879</a></span><span class="t">                    <span class="nam">wit_1_rdg_inds</span> <span class="op">=</span> <span class="op">[</span><span class="nam">l</span> <span class="key">for</span> <span class="nam">l</span><span class="op">,</span> <span class="nam">w</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">wit_1_rdg_support</span><span class="op">)</span> <span class="key">if</span> <span class="nam">w</span> <span class="op">></span> <span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1880" href="#t1880">1880</a></span><span class="t">                    <span class="nam">wit_2_rdg_inds</span> <span class="op">=</span> <span class="op">[</span><span class="nam">l</span> <span class="key">for</span> <span class="nam">l</span><span class="op">,</span> <span class="nam">w</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">wit_2_rdg_support</span><span class="op">)</span> <span class="key">if</span> <span class="nam">w</span> <span class="op">></span> <span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1881" href="#t1881">1881</a></span><span class="t">                    <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">wit_1_rdg_inds</span><span class="op">)</span> <span class="op">!=</span> <span class="num">1</span> <span class="key">or</span> <span class="nam">len</span><span class="op">(</span><span class="nam">wit_2_rdg_inds</span><span class="op">)</span> <span class="op">!=</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1882" href="#t1882">1882</a></span><span class="t">                        <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1883" href="#t1883">1883</a></span><span class="t">                    <span class="nam">extant_units</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1884" href="#t1884">1884</a></span><span class="t">                    <span class="key">if</span> <span class="nam">wit_1_rdg_inds</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="op">==</span> <span class="nam">wit_2_rdg_inds</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1885" href="#t1885">1885</a></span><span class="t">                        <span class="nam">agreements</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1886" href="#t1886">1886</a></span><span class="t">                <span class="nam">cell_entry</span> <span class="op">=</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1887" href="#t1887">1887</a></span><span class="t">                <span class="key">if</span> <span class="nam">proportion</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1888" href="#t1888">1888</a></span><span class="t">                    <span class="nam">cell_entry</span> <span class="op">=</span> <span class="nam">agreements</span> <span class="op">/</span> <span class="nam">max</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1889" href="#t1889">1889</a></span><span class="t">                        <span class="nam">extant_units</span><span class="op">,</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1890" href="#t1890">1890</a></span><span class="t">                    <span class="op">)</span>  <span class="com"># the max in the denominator is to prevent division by 0; the distance entry will be 0 if the two witnesses have no overlap</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1891" href="#t1891">1891</a></span><span class="t">                <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1892" href="#t1892">1892</a></span><span class="t">                    <span class="nam">cell_entry</span> <span class="op">=</span> <span class="nam">agreements</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1893" href="#t1893">1893</a></span><span class="t">                <span class="key">if</span> <span class="nam">show_ext</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1894" href="#t1894">1894</a></span><span class="t">                    <span class="nam">cell_entry</span> <span class="op">=</span> <span class="nam">str</span><span class="op">(</span><span class="nam">cell_entry</span><span class="op">)</span> <span class="op">+</span> <span class="str">"/"</span> <span class="op">+</span> <span class="nam">str</span><span class="op">(</span><span class="nam">extant_units</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1895" href="#t1895">1895</a></span><span class="t">                <span class="nam">matrix</span><span class="op">[</span><span class="nam">i</span><span class="op">,</span> <span class="nam">j</span><span class="op">]</span> <span class="op">=</span> <span class="nam">cell_entry</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1896" href="#t1896">1896</a></span><span class="t">        <span class="key">return</span> <span class="nam">matrix</span><span class="op">,</span> <span class="nam">witness_labels</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1897" href="#t1897">1897</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1898" href="#t1898">1898</a></span><span class="t">    <span class="key">def</span> <span class="nam">to_nexus_table</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">drop_constant</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span> <span class="nam">ambiguous_as_missing</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1899" href="#t1899">1899</a></span><span class="t">        <span class="str">"""Returns this Collation in the form of a table with rows for taxa, columns for characters, and reading IDs in cells.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1900" href="#t1900">1900</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1901" href="#t1901">1901</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1902" href="#t1902">1902</a></span><span class="t"><span class="str">            drop_constant (bool, optional): An optional flag indicating whether to ignore variation units with one substantive reading.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1903" href="#t1903">1903</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1904" href="#t1904">1904</a></span><span class="t"><span class="str">            ambiguous_as_missing (bool, optional): An optional flag indicating whether to treat all ambiguous states as missing data.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1905" href="#t1905">1905</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1906" href="#t1906">1906</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1907" href="#t1907">1907</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1908" href="#t1908">1908</a></span><span class="t"><span class="str">            A NumPy array with rows for taxa, columns for characters, and reading IDs in cells.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1909" href="#t1909">1909</a></span><span class="t"><span class="str">            A list of substantive reading ID strings.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1910" href="#t1910">1910</a></span><span class="t"><span class="str">            A list of witness ID strings.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1911" href="#t1911">1911</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1912" href="#t1912">1912</a></span><span class="t">        <span class="com"># Populate a list of sites that will correspond to columns of the sequence alignment:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1913" href="#t1913">1913</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1914" href="#t1914">1914</a></span><span class="t">        <span class="key">if</span> <span class="nam">drop_constant</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1915" href="#t1915">1915</a></span><span class="t">            <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1916" href="#t1916">1916</a></span><span class="t">                <span class="nam">vu_id</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1917" href="#t1917">1917</a></span><span class="t">                <span class="key">for</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1918" href="#t1918">1918</a></span><span class="t">                <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu_id</span><span class="op">]</span><span class="op">)</span> <span class="op">></span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1919" href="#t1919">1919</a></span><span class="t">            <span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1920" href="#t1920">1920</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">substantive_variation_unit_ids</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1921" href="#t1921">1921</a></span><span class="t">        <span class="nam">substantive_variation_unit_reading_tuples_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_variation_unit_reading_tuples</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1922" href="#t1922">1922</a></span><span class="t">        <span class="com"># In a first pass, populate a dictionary mapping (variation unit index, reading index) tuples from the readings_by_witness dictionary</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1923" href="#t1923">1923</a></span><span class="t">        <span class="com"># to the readings' IDs:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1924" href="#t1924">1924</a></span><span class="t">        <span class="nam">reading_ids_by_indices</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1925" href="#t1925">1925</a></span><span class="t">        <span class="key">for</span> <span class="nam">j</span><span class="op">,</span> <span class="nam">vu</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">variation_units</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1926" href="#t1926">1926</a></span><span class="t">            <span class="key">if</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">id</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_ids_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1927" href="#t1927">1927</a></span><span class="t">                <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1928" href="#t1928">1928</a></span><span class="t">            <span class="nam">k</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1929" href="#t1929">1929</a></span><span class="t">            <span class="key">for</span> <span class="nam">rdg</span> <span class="key">in</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">readings</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1930" href="#t1930">1930</a></span><span class="t">                <span class="nam">key</span> <span class="op">=</span> <span class="nam">tuple</span><span class="op">(</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1931" href="#t1931">1931</a></span><span class="t">                <span class="key">if</span> <span class="nam">key</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_reading_tuples_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1932" href="#t1932">1932</a></span><span class="t">                    <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1933" href="#t1933">1933</a></span><span class="t">                <span class="nam">indices</span> <span class="op">=</span> <span class="nam">tuple</span><span class="op">(</span><span class="op">[</span><span class="nam">j</span><span class="op">,</span> <span class="nam">k</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1934" href="#t1934">1934</a></span><span class="t">                <span class="nam">reading_ids_by_indices</span><span class="op">[</span><span class="nam">indices</span><span class="op">]</span> <span class="op">=</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1935" href="#t1935">1935</a></span><span class="t">                <span class="nam">k</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1936" href="#t1936">1936</a></span><span class="t">        <span class="com"># Initialize the output array with the appropriate dimensions:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1937" href="#t1937">1937</a></span><span class="t">        <span class="nam">missing_symbol</span> <span class="op">=</span> <span class="str">'?'</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1938" href="#t1938">1938</a></span><span class="t">        <span class="nam">witness_labels</span> <span class="op">=</span> <span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span> <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1939" href="#t1939">1939</a></span><span class="t">        <span class="nam">matrix</span> <span class="op">=</span> <span class="nam">np</span><span class="op">.</span><span class="nam">full</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1940" href="#t1940">1940</a></span><span class="t">            <span class="op">(</span><span class="nam">len</span><span class="op">(</span><span class="nam">witness_labels</span><span class="op">)</span><span class="op">,</span> <span class="nam">len</span><span class="op">(</span><span class="nam">substantive_variation_unit_ids</span><span class="op">)</span><span class="op">)</span><span class="op">,</span> <span class="nam">missing_symbol</span><span class="op">,</span> <span class="nam">dtype</span><span class="op">=</span><span class="nam">object</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1941" href="#t1941">1941</a></span><span class="t">        <span class="op">)</span>  <span class="com"># use dtype=object because the maximum string length is not known up front</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1942" href="#t1942">1942</a></span><span class="t">        <span class="com"># Then populate it with the appropriate values:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1943" href="#t1943">1943</a></span><span class="t">        <span class="nam">row_ind</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1944" href="#t1944">1944</a></span><span class="t">        <span class="key">for</span> <span class="nam">i</span><span class="op">,</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1945" href="#t1945">1945</a></span><span class="t">            <span class="nam">col_ind</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1946" href="#t1946">1946</a></span><span class="t">            <span class="key">for</span> <span class="nam">j</span><span class="op">,</span> <span class="nam">vu</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">variation_units</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1947" href="#t1947">1947</a></span><span class="t">                <span class="key">if</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">id</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_ids_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1948" href="#t1948">1948</a></span><span class="t">                    <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1949" href="#t1949">1949</a></span><span class="t">                <span class="nam">rdg_support</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">[</span><span class="nam">j</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1950" href="#t1950">1950</a></span><span class="t">                <span class="com"># If this reading support vector sums to 0, then this is missing data; handle it as specified:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1951" href="#t1951">1951</a></span><span class="t">                <span class="key">if</span> <span class="nam">sum</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1952" href="#t1952">1952</a></span><span class="t">                    <span class="nam">matrix</span><span class="op">[</span><span class="nam">row_ind</span><span class="op">,</span> <span class="nam">col_ind</span><span class="op">]</span> <span class="op">=</span> <span class="nam">missing_symbol</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1953" href="#t1953">1953</a></span><span class="t">                <span class="com"># Otherwise, add its coefficients normally:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1954" href="#t1954">1954</a></span><span class="t">                <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1955" href="#t1955">1955</a></span><span class="t">                    <span class="nam">rdg_inds</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1956" href="#t1956">1956</a></span><span class="t">                        <span class="nam">k</span> <span class="key">for</span> <span class="nam">k</span><span class="op">,</span> <span class="nam">w</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="key">if</span> <span class="nam">w</span> <span class="op">></span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1957" href="#t1957">1957</a></span><span class="t">                    <span class="op">]</span>  <span class="com"># the index list consists of the indices of all readings with any degree of certainty assigned to them</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1958" href="#t1958">1958</a></span><span class="t">                    <span class="com"># For singleton readings, just print the reading ID:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1959" href="#t1959">1959</a></span><span class="t">                    <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg_inds</span><span class="op">)</span> <span class="op">==</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1960" href="#t1960">1960</a></span><span class="t">                        <span class="nam">k</span> <span class="op">=</span> <span class="nam">rdg_inds</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1961" href="#t1961">1961</a></span><span class="t">                        <span class="nam">matrix</span><span class="op">[</span><span class="nam">row_ind</span><span class="op">,</span> <span class="nam">col_ind</span><span class="op">]</span> <span class="op">=</span> <span class="nam">reading_ids_by_indices</span><span class="op">[</span><span class="op">(</span><span class="nam">j</span><span class="op">,</span> <span class="nam">k</span><span class="op">)</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1962" href="#t1962">1962</a></span><span class="t">                    <span class="com"># For multiple readings, print the corresponding reading IDs in braces or the missing symbol depending on input settings:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1963" href="#t1963">1963</a></span><span class="t">                    <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1964" href="#t1964">1964</a></span><span class="t">                        <span class="key">if</span> <span class="nam">ambiguous_as_missing</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1965" href="#t1965">1965</a></span><span class="t">                            <span class="nam">matrix</span><span class="op">[</span><span class="nam">row_ind</span><span class="op">,</span> <span class="nam">col_ind</span><span class="op">]</span> <span class="op">=</span> <span class="nam">missing_symbol</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1966" href="#t1966">1966</a></span><span class="t">                        <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1967" href="#t1967">1967</a></span><span class="t">                            <span class="nam">matrix</span><span class="op">[</span><span class="nam">row_ind</span><span class="op">,</span> <span class="nam">col_ind</span><span class="op">]</span> <span class="op">=</span> <span class="str">"{%s}"</span> <span class="op">%</span> <span class="str">" "</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1968" href="#t1968">1968</a></span><span class="t">                                <span class="op">[</span><span class="nam">reading_ids_by_indices</span><span class="op">[</span><span class="op">(</span><span class="nam">j</span><span class="op">,</span> <span class="nam">k</span><span class="op">)</span><span class="op">]</span> <span class="key">for</span> <span class="nam">k</span> <span class="key">in</span> <span class="nam">rdg_inds</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1969" href="#t1969">1969</a></span><span class="t">                            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1970" href="#t1970">1970</a></span><span class="t">                <span class="nam">col_ind</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1971" href="#t1971">1971</a></span><span class="t">            <span class="nam">row_ind</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1972" href="#t1972">1972</a></span><span class="t">        <span class="key">return</span> <span class="nam">matrix</span><span class="op">,</span> <span class="nam">witness_labels</span><span class="op">,</span> <span class="nam">substantive_variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1973" href="#t1973">1973</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1974" href="#t1974">1974</a></span><span class="t">    <span class="key">def</span> <span class="nam">to_long_table</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">drop_constant</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1975" href="#t1975">1975</a></span><span class="t">        <span class="str">"""Returns this Collation in the form of a long table with columns for taxa, characters, reading indices, and reading values.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1976" href="#t1976">1976</a></span><span class="t"><span class="str">        Note that this method treats ambiguous readings as missing data.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1977" href="#t1977">1977</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1978" href="#t1978">1978</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1979" href="#t1979">1979</a></span><span class="t"><span class="str">            drop_constant (bool, optional): An optional flag indicating whether to ignore variation units with one substantive reading.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1980" href="#t1980">1980</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1981" href="#t1981">1981</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1982" href="#t1982">1982</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1983" href="#t1983">1983</a></span><span class="t"><span class="str">            A NumPy array with columns for taxa, characters, reading indices, and reading values, and rows for each combination of these values in the matrix.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1984" href="#t1984">1984</a></span><span class="t"><span class="str">            A list of column label strings.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1985" href="#t1985">1985</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1986" href="#t1986">1986</a></span><span class="t">        <span class="com"># Populate a list of sites that will correspond to columns of the sequence alignment:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1987" href="#t1987">1987</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1988" href="#t1988">1988</a></span><span class="t">        <span class="key">if</span> <span class="nam">drop_constant</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1989" href="#t1989">1989</a></span><span class="t">            <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1990" href="#t1990">1990</a></span><span class="t">                <span class="nam">vu_id</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1991" href="#t1991">1991</a></span><span class="t">                <span class="key">for</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1992" href="#t1992">1992</a></span><span class="t">                <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu_id</span><span class="op">]</span><span class="op">)</span> <span class="op">></span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1993" href="#t1993">1993</a></span><span class="t">            <span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1994" href="#t1994">1994</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">substantive_variation_unit_ids</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1995" href="#t1995">1995</a></span><span class="t">        <span class="nam">substantive_variation_unit_reading_tuples_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_variation_unit_reading_tuples</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1996" href="#t1996">1996</a></span><span class="t">        <span class="com"># Initialize the outputs:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1997" href="#t1997">1997</a></span><span class="t">        <span class="nam">column_labels</span> <span class="op">=</span> <span class="op">[</span><span class="str">"taxon"</span><span class="op">,</span> <span class="str">"character"</span><span class="op">,</span> <span class="str">"state"</span><span class="op">,</span> <span class="str">"value"</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t1998" href="#t1998">1998</a></span><span class="t">        <span class="nam">long_table_list</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t1999" href="#t1999">1999</a></span><span class="t">        <span class="com"># Populate a dictionary mapping (variation unit index, reading index) tuples to reading texts:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2000" href="#t2000">2000</a></span><span class="t">        <span class="nam">reading_texts_by_indices</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2001" href="#t2001">2001</a></span><span class="t">        <span class="key">for</span> <span class="nam">j</span><span class="op">,</span> <span class="nam">vu</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">variation_units</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2002" href="#t2002">2002</a></span><span class="t">            <span class="key">if</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">id</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_ids_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2003" href="#t2003">2003</a></span><span class="t">                <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2004" href="#t2004">2004</a></span><span class="t">            <span class="nam">k</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2005" href="#t2005">2005</a></span><span class="t">            <span class="key">for</span> <span class="nam">rdg</span> <span class="key">in</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">readings</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2006" href="#t2006">2006</a></span><span class="t">                <span class="nam">key</span> <span class="op">=</span> <span class="nam">tuple</span><span class="op">(</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2007" href="#t2007">2007</a></span><span class="t">                <span class="key">if</span> <span class="nam">key</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_reading_tuples_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2008" href="#t2008">2008</a></span><span class="t">                    <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2009" href="#t2009">2009</a></span><span class="t">                <span class="nam">indices</span> <span class="op">=</span> <span class="nam">tuple</span><span class="op">(</span><span class="op">[</span><span class="nam">j</span><span class="op">,</span> <span class="nam">k</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2010" href="#t2010">2010</a></span><span class="t">                <span class="nam">reading_texts_by_indices</span><span class="op">[</span><span class="nam">indices</span><span class="op">]</span> <span class="op">=</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">text</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2011" href="#t2011">2011</a></span><span class="t">                <span class="nam">k</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2012" href="#t2012">2012</a></span><span class="t">        <span class="com"># Then populate the output list with the appropriate values:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2013" href="#t2013">2013</a></span><span class="t">        <span class="nam">witness_labels</span> <span class="op">=</span> <span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span> <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2014" href="#t2014">2014</a></span><span class="t">        <span class="nam">missing_symbol</span> <span class="op">=</span> <span class="str">'?'</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2015" href="#t2015">2015</a></span><span class="t">        <span class="key">for</span> <span class="nam">i</span><span class="op">,</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2016" href="#t2016">2016</a></span><span class="t">            <span class="nam">row_ind</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2017" href="#t2017">2017</a></span><span class="t">            <span class="key">for</span> <span class="nam">j</span><span class="op">,</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2018" href="#t2018">2018</a></span><span class="t">                <span class="key">if</span> <span class="nam">vu_id</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_ids_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2019" href="#t2019">2019</a></span><span class="t">                    <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2020" href="#t2020">2020</a></span><span class="t">                <span class="nam">rdg_support</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">[</span><span class="nam">j</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2021" href="#t2021">2021</a></span><span class="t">                <span class="com"># Populate a list of nonzero coefficients for this reading support vector:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2022" href="#t2022">2022</a></span><span class="t">                <span class="nam">rdg_inds</span> <span class="op">=</span> <span class="op">[</span><span class="nam">k</span> <span class="key">for</span> <span class="nam">k</span><span class="op">,</span> <span class="nam">w</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="key">if</span> <span class="nam">w</span> <span class="op">></span> <span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2023" href="#t2023">2023</a></span><span class="t">                <span class="com"># If this list does not consist of exactly one reading, then treat it as missing data:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2024" href="#t2024">2024</a></span><span class="t">                <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg_inds</span><span class="op">)</span> <span class="op">!=</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2025" href="#t2025">2025</a></span><span class="t">                    <span class="nam">long_table_list</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">vu_id</span><span class="op">,</span> <span class="nam">missing_symbol</span><span class="op">,</span> <span class="nam">missing_symbol</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2026" href="#t2026">2026</a></span><span class="t">                    <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2027" href="#t2027">2027</a></span><span class="t">                <span class="nam">k</span> <span class="op">=</span> <span class="nam">rdg_inds</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2028" href="#t2028">2028</a></span><span class="t">                <span class="nam">rdg_text</span> <span class="op">=</span> <span class="nam">reading_texts_by_indices</span><span class="op">[</span><span class="op">(</span><span class="nam">j</span><span class="op">,</span> <span class="nam">k</span><span class="op">)</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2029" href="#t2029">2029</a></span><span class="t">                <span class="com"># Replace empty reading texts with the omission placeholder:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2030" href="#t2030">2030</a></span><span class="t">                <span class="key">if</span> <span class="nam">rdg_text</span> <span class="op">==</span> <span class="str">""</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2031" href="#t2031">2031</a></span><span class="t">                    <span class="nam">rdg_text</span> <span class="op">=</span> <span class="str">"om."</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2032" href="#t2032">2032</a></span><span class="t">                <span class="nam">long_table_list</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">vu_id</span><span class="op">,</span> <span class="nam">k</span><span class="op">,</span> <span class="nam">rdg_text</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2033" href="#t2033">2033</a></span><span class="t">        <span class="com"># Then convert the long table entries list to a NumPy array:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2034" href="#t2034">2034</a></span><span class="t">        <span class="nam">long_table</span> <span class="op">=</span> <span class="nam">np</span><span class="op">.</span><span class="nam">array</span><span class="op">(</span><span class="nam">long_table_list</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2035" href="#t2035">2035</a></span><span class="t">        <span class="key">return</span> <span class="nam">long_table</span><span class="op">,</span> <span class="nam">column_labels</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2036" href="#t2036">2036</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2037" href="#t2037">2037</a></span><span class="t">    <span class="key">def</span> <span class="nam">to_dataframe</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2038" href="#t2038">2038</a></span><span class="t">        <span class="nam">self</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2039" href="#t2039">2039</a></span><span class="t">        <span class="nam">drop_constant</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2040" href="#t2040">2040</a></span><span class="t">        <span class="nam">ambiguous_as_missing</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2041" href="#t2041">2041</a></span><span class="t">        <span class="nam">proportion</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2042" href="#t2042">2042</a></span><span class="t">        <span class="nam">table_type</span><span class="op">:</span> <span class="nam">TableType</span> <span class="op">=</span> <span class="nam">TableType</span><span class="op">.</span><span class="nam">matrix</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2043" href="#t2043">2043</a></span><span class="t">        <span class="nam">split_missing</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">True</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2044" href="#t2044">2044</a></span><span class="t">        <span class="nam">show_ext</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2045" href="#t2045">2045</a></span><span class="t">    <span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2046" href="#t2046">2046</a></span><span class="t">        <span class="str">"""Returns this Collation in the form of a Pandas DataFrame array, including the appropriate row and column labels.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2047" href="#t2047">2047</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2048" href="#t2048">2048</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2049" href="#t2049">2049</a></span><span class="t"><span class="str">            drop_constant (bool, optional): An optional flag indicating whether to ignore variation units with one substantive reading.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2050" href="#t2050">2050</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2051" href="#t2051">2051</a></span><span class="t"><span class="str">            ambiguous_as_missing (bool, optional): An optional flag indicating whether to treat all ambiguous states as missing data.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2052" href="#t2052">2052</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2053" href="#t2053">2053</a></span><span class="t"><span class="str">            proportion (bool, optional): An optional flag indicating whether or not to calculate distances as proportions over extant, unambiguous variation units.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2054" href="#t2054">2054</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2055" href="#t2055">2055</a></span><span class="t"><span class="str">            table_type (TableType, optional): A TableType option indicating which type of tabular output to generate.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2056" href="#t2056">2056</a></span><span class="t"><span class="str">                Only applicable for tabular outputs.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2057" href="#t2057">2057</a></span><span class="t"><span class="str">                Default value is "matrix".</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2058" href="#t2058">2058</a></span><span class="t"><span class="str">            split_missing: An optional flag indicating whether or not to treat missing characters/variation units as having a contribution of 1 split over all states/readings;</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2059" href="#t2059">2059</a></span><span class="t"><span class="str">                if False, then missing data is ignored (i.e., all states are 0).</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2060" href="#t2060">2060</a></span><span class="t"><span class="str">                Default value is True.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2061" href="#t2061">2061</a></span><span class="t"><span class="str">            show_ext: An optional flag indicating whether each cell in a distance or similarity matrix</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2062" href="#t2062">2062</a></span><span class="t"><span class="str">                should include the number of their extant, unambiguous variation units after the number of their disagreements/agreements.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2063" href="#t2063">2063</a></span><span class="t"><span class="str">                Only applicable for tabular output formats of type \"distance\" or \"similarity\".</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2064" href="#t2064">2064</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2065" href="#t2065">2065</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2066" href="#t2066">2066</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2067" href="#t2067">2067</a></span><span class="t"><span class="str">            A Pandas DataFrame corresponding to a collation matrix with reading frequencies or a long table with discrete reading states.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2068" href="#t2068">2068</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2069" href="#t2069">2069</a></span><span class="t">        <span class="nam">df</span> <span class="op">=</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2070" href="#t2070">2070</a></span><span class="t">        <span class="com"># Proceed based on the table type:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2071" href="#t2071">2071</a></span><span class="t">        <span class="key">if</span> <span class="nam">table_type</span> <span class="op">==</span> <span class="nam">TableType</span><span class="op">.</span><span class="nam">matrix</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2072" href="#t2072">2072</a></span><span class="t">            <span class="com"># Convert the collation to a NumPy array and get its row and column labels first:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2073" href="#t2073">2073</a></span><span class="t">            <span class="nam">matrix</span><span class="op">,</span> <span class="nam">reading_labels</span><span class="op">,</span> <span class="nam">witness_labels</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">to_numpy</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2074" href="#t2074">2074</a></span><span class="t">                <span class="nam">drop_constant</span><span class="op">=</span><span class="nam">drop_constant</span><span class="op">,</span> <span class="nam">split_missing</span><span class="op">=</span><span class="nam">split_missing</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2075" href="#t2075">2075</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2076" href="#t2076">2076</a></span><span class="t">            <span class="nam">df</span> <span class="op">=</span> <span class="nam">pd</span><span class="op">.</span><span class="nam">DataFrame</span><span class="op">(</span><span class="nam">matrix</span><span class="op">,</span> <span class="nam">index</span><span class="op">=</span><span class="nam">reading_labels</span><span class="op">,</span> <span class="nam">columns</span><span class="op">=</span><span class="nam">witness_labels</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2077" href="#t2077">2077</a></span><span class="t">        <span class="key">elif</span> <span class="nam">table_type</span> <span class="op">==</span> <span class="nam">TableType</span><span class="op">.</span><span class="nam">distance</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2078" href="#t2078">2078</a></span><span class="t">            <span class="com"># Convert the collation to a NumPy array and get its row and column labels first:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2079" href="#t2079">2079</a></span><span class="t">            <span class="nam">matrix</span><span class="op">,</span> <span class="nam">witness_labels</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">to_distance_matrix</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2080" href="#t2080">2080</a></span><span class="t">                <span class="nam">drop_constant</span><span class="op">=</span><span class="nam">drop_constant</span><span class="op">,</span> <span class="nam">proportion</span><span class="op">=</span><span class="nam">proportion</span><span class="op">,</span> <span class="nam">show_ext</span><span class="op">=</span><span class="nam">show_ext</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2081" href="#t2081">2081</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2082" href="#t2082">2082</a></span><span class="t">            <span class="nam">df</span> <span class="op">=</span> <span class="nam">pd</span><span class="op">.</span><span class="nam">DataFrame</span><span class="op">(</span><span class="nam">matrix</span><span class="op">,</span> <span class="nam">index</span><span class="op">=</span><span class="nam">witness_labels</span><span class="op">,</span> <span class="nam">columns</span><span class="op">=</span><span class="nam">witness_labels</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2083" href="#t2083">2083</a></span><span class="t">        <span class="key">elif</span> <span class="nam">table_type</span> <span class="op">==</span> <span class="nam">TableType</span><span class="op">.</span><span class="nam">similarity</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2084" href="#t2084">2084</a></span><span class="t">            <span class="com"># Convert the collation to a NumPy array and get its row and column labels first:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2085" href="#t2085">2085</a></span><span class="t">            <span class="nam">matrix</span><span class="op">,</span> <span class="nam">witness_labels</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">to_similarity_matrix</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2086" href="#t2086">2086</a></span><span class="t">                <span class="nam">drop_constant</span><span class="op">=</span><span class="nam">drop_constant</span><span class="op">,</span> <span class="nam">proportion</span><span class="op">=</span><span class="nam">proportion</span><span class="op">,</span> <span class="nam">show_ext</span><span class="op">=</span><span class="nam">show_ext</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2087" href="#t2087">2087</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2088" href="#t2088">2088</a></span><span class="t">            <span class="nam">df</span> <span class="op">=</span> <span class="nam">pd</span><span class="op">.</span><span class="nam">DataFrame</span><span class="op">(</span><span class="nam">matrix</span><span class="op">,</span> <span class="nam">index</span><span class="op">=</span><span class="nam">witness_labels</span><span class="op">,</span> <span class="nam">columns</span><span class="op">=</span><span class="nam">witness_labels</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2089" href="#t2089">2089</a></span><span class="t">        <span class="key">elif</span> <span class="nam">table_type</span> <span class="op">==</span> <span class="nam">TableType</span><span class="op">.</span><span class="nam">nexus</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2090" href="#t2090">2090</a></span><span class="t">            <span class="com"># Convert the collation to a NumPy array and get its row and column labels first:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2091" href="#t2091">2091</a></span><span class="t">            <span class="nam">matrix</span><span class="op">,</span> <span class="nam">witness_labels</span><span class="op">,</span> <span class="nam">vu_labels</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">to_nexus_table</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2092" href="#t2092">2092</a></span><span class="t">                <span class="nam">drop_constant</span><span class="op">=</span><span class="nam">drop_constant</span><span class="op">,</span> <span class="nam">ambiguous_as_missing</span><span class="op">=</span><span class="nam">ambiguous_as_missing</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2093" href="#t2093">2093</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2094" href="#t2094">2094</a></span><span class="t">            <span class="nam">df</span> <span class="op">=</span> <span class="nam">pd</span><span class="op">.</span><span class="nam">DataFrame</span><span class="op">(</span><span class="nam">matrix</span><span class="op">,</span> <span class="nam">index</span><span class="op">=</span><span class="nam">witness_labels</span><span class="op">,</span> <span class="nam">columns</span><span class="op">=</span><span class="nam">vu_labels</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2095" href="#t2095">2095</a></span><span class="t">        <span class="key">elif</span> <span class="nam">table_type</span> <span class="op">==</span> <span class="nam">TableType</span><span class="op">.</span><span class="nam">long</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2096" href="#t2096">2096</a></span><span class="t">            <span class="com"># Convert the collation to a long table and get its column labels first:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2097" href="#t2097">2097</a></span><span class="t">            <span class="nam">long_table</span><span class="op">,</span> <span class="nam">column_labels</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">to_long_table</span><span class="op">(</span><span class="nam">drop_constant</span><span class="op">=</span><span class="nam">drop_constant</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2098" href="#t2098">2098</a></span><span class="t">            <span class="nam">df</span> <span class="op">=</span> <span class="nam">pd</span><span class="op">.</span><span class="nam">DataFrame</span><span class="op">(</span><span class="nam">long_table</span><span class="op">,</span> <span class="nam">columns</span><span class="op">=</span><span class="nam">column_labels</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2099" href="#t2099">2099</a></span><span class="t">        <span class="key">return</span> <span class="nam">df</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2100" href="#t2100">2100</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2101" href="#t2101">2101</a></span><span class="t">    <span class="key">def</span> <span class="nam">to_csv</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2102" href="#t2102">2102</a></span><span class="t">        <span class="nam">self</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2103" href="#t2103">2103</a></span><span class="t">        <span class="nam">file_addr</span><span class="op">:</span> <span class="nam">Union</span><span class="op">[</span><span class="nam">Path</span><span class="op">,</span> <span class="nam">str</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2104" href="#t2104">2104</a></span><span class="t">        <span class="nam">drop_constant</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2105" href="#t2105">2105</a></span><span class="t">        <span class="nam">ambiguous_as_missing</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2106" href="#t2106">2106</a></span><span class="t">        <span class="nam">proportion</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2107" href="#t2107">2107</a></span><span class="t">        <span class="nam">table_type</span><span class="op">:</span> <span class="nam">TableType</span> <span class="op">=</span> <span class="nam">TableType</span><span class="op">.</span><span class="nam">matrix</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2108" href="#t2108">2108</a></span><span class="t">        <span class="nam">split_missing</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">True</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2109" href="#t2109">2109</a></span><span class="t">        <span class="nam">show_ext</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2110" href="#t2110">2110</a></span><span class="t">        <span class="op">**</span><span class="nam">kwargs</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2111" href="#t2111">2111</a></span><span class="t">    <span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2112" href="#t2112">2112</a></span><span class="t">        <span class="str">"""Writes this Collation to a comma-separated value (CSV) file with the given address.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2113" href="#t2113">2113</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2114" href="#t2114">2114</a></span><span class="t"><span class="str">        If your witness IDs are numeric (e.g., Gregory-Aland numbers), then they will be written in full to the CSV file, but Excel will likely interpret them as numbers and truncate any leading zeroes!</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2115" href="#t2115">2115</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2116" href="#t2116">2116</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2117" href="#t2117">2117</a></span><span class="t"><span class="str">            file_addr: A string representing the path to an output CSV file; the file type should be .csv.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2118" href="#t2118">2118</a></span><span class="t"><span class="str">            drop_constant: An optional flag indicating whether to ignore variation units with one substantive reading.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2119" href="#t2119">2119</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2120" href="#t2120">2120</a></span><span class="t"><span class="str">            ambiguous_as_missing: An optional flag indicating whether to treat all ambiguous states as missing data.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2121" href="#t2121">2121</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2122" href="#t2122">2122</a></span><span class="t"><span class="str">            proportion: An optional flag indicating whether or not to calculate distances as proportions over extant, unambiguous variation units.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2123" href="#t2123">2123</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2124" href="#t2124">2124</a></span><span class="t"><span class="str">            table_type: A TableType option indicating which type of tabular output to generate.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2125" href="#t2125">2125</a></span><span class="t"><span class="str">                Only applicable for tabular outputs.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2126" href="#t2126">2126</a></span><span class="t"><span class="str">                Default value is "matrix".</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2127" href="#t2127">2127</a></span><span class="t"><span class="str">            split_missing: An optional flag indicating whether or not to treat missing characters/variation units as having a contribution of 1 split over all states/readings;</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2128" href="#t2128">2128</a></span><span class="t"><span class="str">                if False, then missing data is ignored (i.e., all states are 0).</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2129" href="#t2129">2129</a></span><span class="t"><span class="str">                Default value is True.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2130" href="#t2130">2130</a></span><span class="t"><span class="str">            show_ext: An optional flag indicating whether each cell in a distance or similarity matrix</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2131" href="#t2131">2131</a></span><span class="t"><span class="str">                should include the number of their extant, unambiguous variation units after the number of their disagreements/agreements.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2132" href="#t2132">2132</a></span><span class="t"><span class="str">                Only applicable for tabular output formats of type \"distance\" or \"similarity\".</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2133" href="#t2133">2133</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2134" href="#t2134">2134</a></span><span class="t"><span class="str">            **kwargs: Keyword arguments for pandas.DataFrame.to_csv.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2135" href="#t2135">2135</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2136" href="#t2136">2136</a></span><span class="t">        <span class="com"># Convert the collation to a Pandas DataFrame first:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2137" href="#t2137">2137</a></span><span class="t">        <span class="nam">df</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">to_dataframe</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2138" href="#t2138">2138</a></span><span class="t">            <span class="nam">drop_constant</span><span class="op">=</span><span class="nam">drop_constant</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2139" href="#t2139">2139</a></span><span class="t">            <span class="nam">ambiguous_as_missing</span><span class="op">=</span><span class="nam">ambiguous_as_missing</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2140" href="#t2140">2140</a></span><span class="t">            <span class="nam">proportion</span><span class="op">=</span><span class="nam">proportion</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2141" href="#t2141">2141</a></span><span class="t">            <span class="nam">table_type</span><span class="op">=</span><span class="nam">table_type</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2142" href="#t2142">2142</a></span><span class="t">            <span class="nam">split_missing</span><span class="op">=</span><span class="nam">split_missing</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2143" href="#t2143">2143</a></span><span class="t">            <span class="nam">show_ext</span><span class="op">=</span><span class="nam">show_ext</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2144" href="#t2144">2144</a></span><span class="t">        <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2145" href="#t2145">2145</a></span><span class="t">        <span class="com"># Generate all parent folders for this file that don't already exist:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2146" href="#t2146">2146</a></span><span class="t">        <span class="nam">Path</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">)</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">mkdir</span><span class="op">(</span><span class="nam">parents</span><span class="op">=</span><span class="key">True</span><span class="op">,</span> <span class="nam">exist_ok</span><span class="op">=</span><span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2147" href="#t2147">2147</a></span><span class="t">        <span class="com"># Proceed based on the table type:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2148" href="#t2148">2148</a></span><span class="t">        <span class="key">if</span> <span class="nam">table_type</span> <span class="op">==</span> <span class="nam">TableType</span><span class="op">.</span><span class="nam">long</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2149" href="#t2149">2149</a></span><span class="t">            <span class="key">return</span> <span class="nam">df</span><span class="op">.</span><span class="nam">to_csv</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2150" href="#t2150">2150</a></span><span class="t">                <span class="nam">file_addr</span><span class="op">,</span> <span class="nam">encoding</span><span class="op">=</span><span class="str">"utf-8-sig"</span><span class="op">,</span> <span class="nam">index</span><span class="op">=</span><span class="key">False</span><span class="op">,</span> <span class="op">**</span><span class="nam">kwargs</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2151" href="#t2151">2151</a></span><span class="t">            <span class="op">)</span>  <span class="com"># add BOM to start of file so that Excel will know to read it as Unicode</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2152" href="#t2152">2152</a></span><span class="t">        <span class="key">return</span> <span class="nam">df</span><span class="op">.</span><span class="nam">to_csv</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2153" href="#t2153">2153</a></span><span class="t">            <span class="nam">file_addr</span><span class="op">,</span> <span class="nam">encoding</span><span class="op">=</span><span class="str">"utf-8-sig"</span><span class="op">,</span> <span class="op">**</span><span class="nam">kwargs</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2154" href="#t2154">2154</a></span><span class="t">        <span class="op">)</span>  <span class="com"># add BOM to start of file so that Excel will know to read it as Unicode</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2155" href="#t2155">2155</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2156" href="#t2156">2156</a></span><span class="t">    <span class="key">def</span> <span class="nam">to_excel</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2157" href="#t2157">2157</a></span><span class="t">        <span class="nam">self</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2158" href="#t2158">2158</a></span><span class="t">        <span class="nam">file_addr</span><span class="op">:</span> <span class="nam">Union</span><span class="op">[</span><span class="nam">Path</span><span class="op">,</span> <span class="nam">str</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2159" href="#t2159">2159</a></span><span class="t">        <span class="nam">drop_constant</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2160" href="#t2160">2160</a></span><span class="t">        <span class="nam">ambiguous_as_missing</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2161" href="#t2161">2161</a></span><span class="t">        <span class="nam">proportion</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2162" href="#t2162">2162</a></span><span class="t">        <span class="nam">table_type</span><span class="op">:</span> <span class="nam">TableType</span> <span class="op">=</span> <span class="nam">TableType</span><span class="op">.</span><span class="nam">matrix</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2163" href="#t2163">2163</a></span><span class="t">        <span class="nam">split_missing</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">True</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2164" href="#t2164">2164</a></span><span class="t">        <span class="nam">show_ext</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2165" href="#t2165">2165</a></span><span class="t">    <span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2166" href="#t2166">2166</a></span><span class="t">        <span class="str">"""Writes this Collation to an Excel (.xlsx) file with the given address.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2167" href="#t2167">2167</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2168" href="#t2168">2168</a></span><span class="t"><span class="str">        Since Pandas is deprecating its support for xlwt, specifying an output in old Excel (.xls) output is not recommended.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2169" href="#t2169">2169</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2170" href="#t2170">2170</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2171" href="#t2171">2171</a></span><span class="t"><span class="str">            file_addr: A string representing the path to an output Excel file; the file type should be .xlsx.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2172" href="#t2172">2172</a></span><span class="t"><span class="str">            drop_constant: An optional flag indicating whether to ignore variation units with one substantive reading.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2173" href="#t2173">2173</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2174" href="#t2174">2174</a></span><span class="t"><span class="str">            ambiguous_as_missing: An optional flag indicating whether to treat all ambiguous states as missing data.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2175" href="#t2175">2175</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2176" href="#t2176">2176</a></span><span class="t"><span class="str">            proportion: An optional flag indicating whether or not to calculate distances as proportions over extant, unambiguous variation units.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2177" href="#t2177">2177</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2178" href="#t2178">2178</a></span><span class="t"><span class="str">            table_type: A TableType option indicating which type of tabular output to generate.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2179" href="#t2179">2179</a></span><span class="t"><span class="str">                Only applicable for tabular outputs.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2180" href="#t2180">2180</a></span><span class="t"><span class="str">                Default value is "matrix".</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2181" href="#t2181">2181</a></span><span class="t"><span class="str">            split_missing: An optional flag indicating whether or not to treat missing characters/variation units as having a contribution of 1 split over all states/readings;</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2182" href="#t2182">2182</a></span><span class="t"><span class="str">                if False, then missing data is ignored (i.e., all states are 0).</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2183" href="#t2183">2183</a></span><span class="t"><span class="str">                Default value is True.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2184" href="#t2184">2184</a></span><span class="t"><span class="str">            show_ext: An optional flag indicating whether each cell in a distance or similarity matrix</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2185" href="#t2185">2185</a></span><span class="t"><span class="str">                should include the number of their extant, unambiguous variation units after the number of their disagreements/agreements.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2186" href="#t2186">2186</a></span><span class="t"><span class="str">                Only applicable for tabular output formats of type \"distance\" or \"similarity\".</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2187" href="#t2187">2187</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2188" href="#t2188">2188</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2189" href="#t2189">2189</a></span><span class="t">        <span class="com"># Convert the collation to a Pandas DataFrame first:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2190" href="#t2190">2190</a></span><span class="t">        <span class="nam">df</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">to_dataframe</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2191" href="#t2191">2191</a></span><span class="t">            <span class="nam">drop_constant</span><span class="op">=</span><span class="nam">drop_constant</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2192" href="#t2192">2192</a></span><span class="t">            <span class="nam">ambiguous_as_missing</span><span class="op">=</span><span class="nam">ambiguous_as_missing</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2193" href="#t2193">2193</a></span><span class="t">            <span class="nam">proportion</span><span class="op">=</span><span class="nam">proportion</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2194" href="#t2194">2194</a></span><span class="t">            <span class="nam">table_type</span><span class="op">=</span><span class="nam">table_type</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2195" href="#t2195">2195</a></span><span class="t">            <span class="nam">split_missing</span><span class="op">=</span><span class="nam">split_missing</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2196" href="#t2196">2196</a></span><span class="t">            <span class="nam">show_ext</span><span class="op">=</span><span class="nam">show_ext</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2197" href="#t2197">2197</a></span><span class="t">        <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2198" href="#t2198">2198</a></span><span class="t">        <span class="com"># Generate all parent folders for this file that don't already exist:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2199" href="#t2199">2199</a></span><span class="t">        <span class="nam">Path</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">)</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">mkdir</span><span class="op">(</span><span class="nam">parents</span><span class="op">=</span><span class="key">True</span><span class="op">,</span> <span class="nam">exist_ok</span><span class="op">=</span><span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2200" href="#t2200">2200</a></span><span class="t">        <span class="com"># Proceed based on the table type:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2201" href="#t2201">2201</a></span><span class="t">        <span class="key">if</span> <span class="nam">table_type</span> <span class="op">==</span> <span class="nam">TableType</span><span class="op">.</span><span class="nam">long</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2202" href="#t2202">2202</a></span><span class="t">            <span class="key">return</span> <span class="nam">df</span><span class="op">.</span><span class="nam">to_excel</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">,</span> <span class="nam">index</span><span class="op">=</span><span class="key">False</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2203" href="#t2203">2203</a></span><span class="t">        <span class="key">return</span> <span class="nam">df</span><span class="op">.</span><span class="nam">to_excel</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2204" href="#t2204">2204</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2205" href="#t2205">2205</a></span><span class="t">    <span class="key">def</span> <span class="nam">to_phylip_matrix</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2206" href="#t2206">2206</a></span><span class="t">        <span class="nam">self</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2207" href="#t2207">2207</a></span><span class="t">        <span class="nam">file_addr</span><span class="op">:</span> <span class="nam">Union</span><span class="op">[</span><span class="nam">Path</span><span class="op">,</span> <span class="nam">str</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2208" href="#t2208">2208</a></span><span class="t">        <span class="nam">drop_constant</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2209" href="#t2209">2209</a></span><span class="t">        <span class="nam">proportion</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2210" href="#t2210">2210</a></span><span class="t">        <span class="nam">table_type</span><span class="op">:</span> <span class="nam">TableType</span> <span class="op">=</span> <span class="nam">TableType</span><span class="op">.</span><span class="nam">distance</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2211" href="#t2211">2211</a></span><span class="t">        <span class="nam">show_ext</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2212" href="#t2212">2212</a></span><span class="t">    <span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2213" href="#t2213">2213</a></span><span class="t">        <span class="str">"""Writes this Collation as a PHYLIP-formatted distance/similarity matrix to the file with the given address.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2214" href="#t2214">2214</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2215" href="#t2215">2215</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2216" href="#t2216">2216</a></span><span class="t"><span class="str">            file_addr: A string representing the path to an output PHYLIP file; the file type should be .ph or .phy.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2217" href="#t2217">2217</a></span><span class="t"><span class="str">            drop_constant: An optional flag indicating whether to ignore variation units with one substantive reading.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2218" href="#t2218">2218</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2219" href="#t2219">2219</a></span><span class="t"><span class="str">            proportion: An optional flag indicating whether or not to calculate distances as proportions over extant, unambiguous variation units.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2220" href="#t2220">2220</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2221" href="#t2221">2221</a></span><span class="t"><span class="str">            table_type: A TableType option indicating which type of tabular output to generate.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2222" href="#t2222">2222</a></span><span class="t"><span class="str">                For PHYLIP-formatted outputs, distance and similarity matrices are the only supported table types.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2223" href="#t2223">2223</a></span><span class="t"><span class="str">                Default value is "distance".</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2224" href="#t2224">2224</a></span><span class="t"><span class="str">            show_ext: An optional flag indicating whether each cell in a distance or similarity matrix</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2225" href="#t2225">2225</a></span><span class="t"><span class="str">                should include the number of their extant, unambiguous variation units after the number of their disagreements/agreements.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2226" href="#t2226">2226</a></span><span class="t"><span class="str">                Only applicable for tabular output formats of type \"distance\" or \"similarity\".</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2227" href="#t2227">2227</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2228" href="#t2228">2228</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2229" href="#t2229">2229</a></span><span class="t">        <span class="com"># Convert the collation to a Pandas DataFrame first:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2230" href="#t2230">2230</a></span><span class="t">        <span class="nam">matrix</span> <span class="op">=</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2231" href="#t2231">2231</a></span><span class="t">        <span class="nam">witness_labels</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2232" href="#t2232">2232</a></span><span class="t">        <span class="com"># Proceed based on the table type:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2233" href="#t2233">2233</a></span><span class="t">        <span class="key">if</span> <span class="nam">table_type</span> <span class="op">==</span> <span class="nam">TableType</span><span class="op">.</span><span class="nam">distance</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2234" href="#t2234">2234</a></span><span class="t">            <span class="com"># Convert the collation to a NumPy array and get its row and column labels first:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2235" href="#t2235">2235</a></span><span class="t">            <span class="nam">matrix</span><span class="op">,</span> <span class="nam">witness_labels</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">to_distance_matrix</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2236" href="#t2236">2236</a></span><span class="t">                <span class="nam">drop_constant</span><span class="op">=</span><span class="nam">drop_constant</span><span class="op">,</span> <span class="nam">proportion</span><span class="op">=</span><span class="nam">proportion</span><span class="op">,</span> <span class="nam">show_ext</span><span class="op">=</span><span class="nam">show_ext</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2237" href="#t2237">2237</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2238" href="#t2238">2238</a></span><span class="t">        <span class="key">elif</span> <span class="nam">table_type</span> <span class="op">==</span> <span class="nam">TableType</span><span class="op">.</span><span class="nam">similarity</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2239" href="#t2239">2239</a></span><span class="t">            <span class="com"># Convert the collation to a NumPy array and get its row and column labels first:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2240" href="#t2240">2240</a></span><span class="t">            <span class="nam">matrix</span><span class="op">,</span> <span class="nam">witness_labels</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">to_similarity_matrix</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2241" href="#t2241">2241</a></span><span class="t">                <span class="nam">drop_constant</span><span class="op">=</span><span class="nam">drop_constant</span><span class="op">,</span> <span class="nam">proportion</span><span class="op">=</span><span class="nam">proportion</span><span class="op">,</span> <span class="nam">show_ext</span><span class="op">=</span><span class="nam">show_ext</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2242" href="#t2242">2242</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2243" href="#t2243">2243</a></span><span class="t">        <span class="com"># Generate all parent folders for this file that don't already exist:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2244" href="#t2244">2244</a></span><span class="t">        <span class="nam">Path</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">)</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">mkdir</span><span class="op">(</span><span class="nam">parents</span><span class="op">=</span><span class="key">True</span><span class="op">,</span> <span class="nam">exist_ok</span><span class="op">=</span><span class="key">True</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2245" href="#t2245">2245</a></span><span class="t">        <span class="key">with</span> <span class="nam">open</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">,</span> <span class="str">"w"</span><span class="op">,</span> <span class="nam">encoding</span><span class="op">=</span><span class="str">"utf-8"</span><span class="op">)</span> <span class="key">as</span> <span class="nam">f</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2246" href="#t2246">2246</a></span><span class="t">            <span class="com"># The first line contains the number of taxa:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2247" href="#t2247">2247</a></span><span class="t">            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"%d\n"</span> <span class="op">%</span> <span class="nam">len</span><span class="op">(</span><span class="nam">witness_labels</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2248" href="#t2248">2248</a></span><span class="t">            <span class="com"># Every subsequent line contains a witness label, followed by the values in its row of the matrix:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2249" href="#t2249">2249</a></span><span class="t">            <span class="key">for</span> <span class="nam">i</span><span class="op">,</span> <span class="nam">wit_id</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">witness_labels</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2250" href="#t2250">2250</a></span><span class="t">                <span class="nam">wit_label</span> <span class="op">=</span> <span class="nam">slugify</span><span class="op">(</span><span class="nam">wit_id</span><span class="op">,</span> <span class="nam">lowercase</span><span class="op">=</span><span class="key">False</span><span class="op">,</span> <span class="nam">allow_unicode</span><span class="op">=</span><span class="key">True</span><span class="op">,</span> <span class="nam">separator</span><span class="op">=</span><span class="str">'_'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2251" href="#t2251">2251</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"%s %s\n"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">wit_label</span><span class="op">,</span> <span class="str">" "</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="op">[</span><span class="nam">str</span><span class="op">(</span><span class="nam">v</span><span class="op">)</span> <span class="key">for</span> <span class="nam">v</span> <span class="key">in</span> <span class="nam">matrix</span><span class="op">[</span><span class="nam">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2252" href="#t2252">2252</a></span><span class="t">        <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2253" href="#t2253">2253</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2254" href="#t2254">2254</a></span><span class="t">    <span class="key">def</span> <span class="nam">get_stemma_symbols</span><span class="op">(</span><span class="nam">self</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2255" href="#t2255">2255</a></span><span class="t">        <span class="str">"""Returns a list of one-character symbols needed to represent the states of all substantive readings in STEMMA format.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2256" href="#t2256">2256</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2257" href="#t2257">2257</a></span><span class="t"><span class="str">        The number of symbols equals the maximum number of substantive readings at any variation unit.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2258" href="#t2258">2258</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2259" href="#t2259">2259</a></span><span class="t"><span class="str">        Returns:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2260" href="#t2260">2260</a></span><span class="t"><span class="str">            A list of individual characters representing states in readings.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2261" href="#t2261">2261</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2262" href="#t2262">2262</a></span><span class="t">        <span class="nam">possible_symbols</span> <span class="op">=</span> <span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2263" href="#t2263">2263</a></span><span class="t">            <span class="nam">list</span><span class="op">(</span><span class="nam">string</span><span class="op">.</span><span class="nam">digits</span><span class="op">)</span> <span class="op">+</span> <span class="nam">list</span><span class="op">(</span><span class="nam">string</span><span class="op">.</span><span class="nam">ascii_lowercase</span><span class="op">)</span> <span class="op">+</span> <span class="nam">list</span><span class="op">(</span><span class="nam">string</span><span class="op">.</span><span class="nam">ascii_uppercase</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2264" href="#t2264">2264</a></span><span class="t">        <span class="op">)</span>  <span class="com"># NOTE: the maximum number of symbols allowed in STEMMA format (other than "?" and "-") is 62</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2265" href="#t2265">2265</a></span><span class="t">        <span class="com"># The number of symbols needed is equal to the length of the longest substantive reading vector:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2266" href="#t2266">2266</a></span><span class="t">        <span class="nam">nsymbols</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2267" href="#t2267">2267</a></span><span class="t">        <span class="com"># If there are no witnesses, then no symbols are needed at all:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2268" href="#t2268">2268</a></span><span class="t">        <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2269" href="#t2269">2269</a></span><span class="t">            <span class="key">return</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2270" href="#t2270">2270</a></span><span class="t">        <span class="nam">wit_id</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="nam">id</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2271" href="#t2271">2271</a></span><span class="t">        <span class="key">for</span> <span class="nam">rdg_support</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit_id</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2272" href="#t2272">2272</a></span><span class="t">            <span class="nam">nsymbols</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span><span class="nam">nsymbols</span><span class="op">,</span> <span class="nam">len</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2273" href="#t2273">2273</a></span><span class="t">        <span class="nam">stemma_symbols</span> <span class="op">=</span> <span class="nam">possible_symbols</span><span class="op">[</span><span class="op">:</span><span class="nam">nsymbols</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2274" href="#t2274">2274</a></span><span class="t">        <span class="key">return</span> <span class="nam">stemma_symbols</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2275" href="#t2275">2275</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2276" href="#t2276">2276</a></span><span class="t">    <span class="key">def</span> <span class="nam">to_stemma</span><span class="op">(</span><span class="nam">self</span><span class="op">,</span> <span class="nam">file_addr</span><span class="op">:</span> <span class="nam">Union</span><span class="op">[</span><span class="nam">Path</span><span class="op">,</span> <span class="nam">str</span><span class="op">]</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2277" href="#t2277">2277</a></span><span class="t">        <span class="str">"""Writes this Collation to a STEMMA file without an extension and a Chron file (containing low, middle, and high dates for all witnesses) without an extension.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2278" href="#t2278">2278</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2279" href="#t2279">2279</a></span><span class="t"><span class="str">        Since this format does not support ambiguous states, all reading vectors with anything other than one nonzero entry will be interpreted as lacunose.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2280" href="#t2280">2280</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2281" href="#t2281">2281</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2282" href="#t2282">2282</a></span><span class="t"><span class="str">            file_addr: A string representing the path to an output STEMMA prep file; the file should have no extension.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2283" href="#t2283">2283</a></span><span class="t"><span class="str">            The accompanying chron file will match this file name, except that it will have "_chron" appended to the end.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2284" href="#t2284">2284</a></span><span class="t"><span class="str">            drop_constant: An optional flag indicating whether to ignore variation units with one substantive reading.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2285" href="#t2285">2285</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2286" href="#t2286">2286</a></span><span class="t">        <span class="com"># Populate a list of sites that will correspond to columns of the sequence alignment</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2287" href="#t2287">2287</a></span><span class="t">        <span class="com"># (by default, constant sites are dropped):</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2288" href="#t2288">2288</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids</span> <span class="op">=</span> <span class="op">[</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2289" href="#t2289">2289</a></span><span class="t">            <span class="nam">vu_id</span> <span class="key">for</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span> <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_readings_by_variation_unit_id</span><span class="op">[</span><span class="nam">vu_id</span><span class="op">]</span><span class="op">)</span> <span class="op">></span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2290" href="#t2290">2290</a></span><span class="t">        <span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2291" href="#t2291">2291</a></span><span class="t">        <span class="nam">substantive_variation_unit_ids_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">substantive_variation_unit_ids</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2292" href="#t2292">2292</a></span><span class="t">        <span class="nam">substantive_variation_unit_reading_tuples_set</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">substantive_variation_unit_reading_tuples</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2293" href="#t2293">2293</a></span><span class="t">        <span class="com"># In a first pass, populate a dictionary mapping (variation unit index, reading index) tuples from the readings_by_witness dictionary</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2294" href="#t2294">2294</a></span><span class="t">        <span class="com"># to the readings' texts:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2295" href="#t2295">2295</a></span><span class="t">        <span class="nam">reading_texts_by_indices</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2296" href="#t2296">2296</a></span><span class="t">        <span class="key">for</span> <span class="nam">j</span><span class="op">,</span> <span class="nam">vu</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">variation_units</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2297" href="#t2297">2297</a></span><span class="t">            <span class="key">if</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">id</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_ids_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2298" href="#t2298">2298</a></span><span class="t">                <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2299" href="#t2299">2299</a></span><span class="t">            <span class="nam">k</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2300" href="#t2300">2300</a></span><span class="t">            <span class="key">for</span> <span class="nam">rdg</span> <span class="key">in</span> <span class="nam">vu</span><span class="op">.</span><span class="nam">readings</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2301" href="#t2301">2301</a></span><span class="t">                <span class="nam">key</span> <span class="op">=</span> <span class="nam">tuple</span><span class="op">(</span><span class="op">[</span><span class="nam">vu</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2302" href="#t2302">2302</a></span><span class="t">                <span class="key">if</span> <span class="nam">key</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_reading_tuples_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2303" href="#t2303">2303</a></span><span class="t">                    <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2304" href="#t2304">2304</a></span><span class="t">                <span class="nam">indices</span> <span class="op">=</span> <span class="nam">tuple</span><span class="op">(</span><span class="op">[</span><span class="nam">j</span><span class="op">,</span> <span class="nam">k</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2305" href="#t2305">2305</a></span><span class="t">                <span class="nam">reading_texts_by_indices</span><span class="op">[</span><span class="nam">indices</span><span class="op">]</span> <span class="op">=</span> <span class="nam">rdg</span><span class="op">.</span><span class="nam">text</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2306" href="#t2306">2306</a></span><span class="t">                <span class="nam">k</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2307" href="#t2307">2307</a></span><span class="t">        <span class="com"># In a second pass, populate another dictionary mapping (variation unit index, reading index) tuples from the readings_by_witness dictionary</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2308" href="#t2308">2308</a></span><span class="t">        <span class="com"># to the witnesses exclusively supporting those readings:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2309" href="#t2309">2309</a></span><span class="t">        <span class="nam">reading_wits_by_indices</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2310" href="#t2310">2310</a></span><span class="t">        <span class="key">for</span> <span class="nam">indices</span> <span class="key">in</span> <span class="nam">reading_texts_by_indices</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2311" href="#t2311">2311</a></span><span class="t">            <span class="nam">reading_wits_by_indices</span><span class="op">[</span><span class="nam">indices</span><span class="op">]</span> <span class="op">=</span> <span class="op">[</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2312" href="#t2312">2312</a></span><span class="t">        <span class="key">for</span> <span class="nam">i</span><span class="op">,</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2313" href="#t2313">2313</a></span><span class="t">            <span class="key">for</span> <span class="nam">j</span><span class="op">,</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2314" href="#t2314">2314</a></span><span class="t">                <span class="key">if</span> <span class="nam">vu_id</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_ids_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2315" href="#t2315">2315</a></span><span class="t">                    <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2316" href="#t2316">2316</a></span><span class="t">                <span class="nam">rdg_support</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">readings_by_witness</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">]</span><span class="op">[</span><span class="nam">j</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2317" href="#t2317">2317</a></span><span class="t">                <span class="com"># If this witness does not exclusively support exactly one reading at this unit, then treat it as lacunose:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2318" href="#t2318">2318</a></span><span class="t">                <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="op">[</span><span class="nam">k</span> <span class="key">for</span> <span class="nam">k</span><span class="op">,</span> <span class="nam">w</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">rdg_support</span><span class="op">)</span> <span class="key">if</span> <span class="nam">w</span> <span class="op">></span> <span class="num">0</span><span class="op">]</span><span class="op">)</span> <span class="op">!=</span> <span class="num">1</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2319" href="#t2319">2319</a></span><span class="t">                    <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2320" href="#t2320">2320</a></span><span class="t">                <span class="nam">k</span> <span class="op">=</span> <span class="nam">rdg_support</span><span class="op">.</span><span class="nam">index</span><span class="op">(</span><span class="num">1</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2321" href="#t2321">2321</a></span><span class="t">                <span class="nam">indices</span> <span class="op">=</span> <span class="nam">tuple</span><span class="op">(</span><span class="op">[</span><span class="nam">j</span><span class="op">,</span> <span class="nam">k</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2322" href="#t2322">2322</a></span><span class="t">                <span class="nam">reading_wits_by_indices</span><span class="op">[</span><span class="nam">indices</span><span class="op">]</span><span class="op">.</span><span class="nam">append</span><span class="op">(</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2323" href="#t2323">2323</a></span><span class="t">        <span class="com"># In a third pass, write to the STEMMA file:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2324" href="#t2324">2324</a></span><span class="t">        <span class="nam">symbols</span> <span class="op">=</span> <span class="nam">self</span><span class="op">.</span><span class="nam">get_stemma_symbols</span><span class="op">(</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2325" href="#t2325">2325</a></span><span class="t">        <span class="nam">Path</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">)</span><span class="op">.</span><span class="nam">parent</span><span class="op">.</span><span class="nam">mkdir</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2326" href="#t2326">2326</a></span><span class="t">            <span class="nam">parents</span><span class="op">=</span><span class="key">True</span><span class="op">,</span> <span class="nam">exist_ok</span><span class="op">=</span><span class="key">True</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2327" href="#t2327">2327</a></span><span class="t">        <span class="op">)</span>  <span class="com"># generate all parent folders for this file that don't already exist</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2328" href="#t2328">2328</a></span><span class="t">        <span class="nam">chron_file_addr</span> <span class="op">=</span> <span class="nam">str</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">)</span> <span class="op">+</span> <span class="str">"_chron"</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2329" href="#t2329">2329</a></span><span class="t">        <span class="key">with</span> <span class="nam">open</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">,</span> <span class="str">"w"</span><span class="op">,</span> <span class="nam">encoding</span><span class="op">=</span><span class="str">"utf-8"</span><span class="op">)</span> <span class="key">as</span> <span class="nam">f</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2330" href="#t2330">2330</a></span><span class="t">            <span class="com"># Start with the witness list:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2331" href="#t2331">2331</a></span><span class="t">            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"* %s ;\n\n"</span> <span class="op">%</span> <span class="str">" "</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span> <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2332" href="#t2332">2332</a></span><span class="t">            <span class="com"># f.write("^ %s\n\n" % chron_file_addr) #write the relative path to the chron file</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2333" href="#t2333">2333</a></span><span class="t">            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2334" href="#t2334">2334</a></span><span class="t">                <span class="str">"^ %s\n\n"</span> <span class="op">%</span> <span class="op">(</span><span class="str">"."</span> <span class="op">+</span> <span class="nam">os</span><span class="op">.</span><span class="nam">sep</span> <span class="op">+</span> <span class="nam">Path</span><span class="op">(</span><span class="nam">chron_file_addr</span><span class="op">)</span><span class="op">.</span><span class="nam">name</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2335" href="#t2335">2335</a></span><span class="t">            <span class="op">)</span>  <span class="com"># write the relative path to the chron file</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2336" href="#t2336">2336</a></span><span class="t">            <span class="com"># Then add a line indicating that all witnesses are lacunose unless they are specified explicitly:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2337" href="#t2337">2337</a></span><span class="t">            <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"= $? $* ;\n\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2338" href="#t2338">2338</a></span><span class="t">            <span class="com"># Then proceed for each variation unit:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2339" href="#t2339">2339</a></span><span class="t">            <span class="key">for</span> <span class="nam">j</span><span class="op">,</span> <span class="nam">vu_id</span> <span class="key">in</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">self</span><span class="op">.</span><span class="nam">variation_unit_ids</span><span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2340" href="#t2340">2340</a></span><span class="t">                <span class="key">if</span> <span class="nam">vu_id</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">substantive_variation_unit_ids_set</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2341" href="#t2341">2341</a></span><span class="t">                    <span class="key">continue</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2342" href="#t2342">2342</a></span><span class="t">                <span class="com"># Print the variation unit ID first:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2343" href="#t2343">2343</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"@ %s\n"</span> <span class="op">%</span> <span class="nam">vu_id</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2344" href="#t2344">2344</a></span><span class="t">                <span class="com"># In a first pass, print the texts of all readings enclosed in brackets:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2345" href="#t2345">2345</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"[ "</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2346" href="#t2346">2346</a></span><span class="t">                <span class="nam">k</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2347" href="#t2347">2347</a></span><span class="t">                <span class="key">while</span> <span class="key">True</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2348" href="#t2348">2348</a></span><span class="t">                    <span class="nam">indices</span> <span class="op">=</span> <span class="nam">tuple</span><span class="op">(</span><span class="op">[</span><span class="nam">j</span><span class="op">,</span> <span class="nam">k</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2349" href="#t2349">2349</a></span><span class="t">                    <span class="key">if</span> <span class="nam">indices</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">reading_texts_by_indices</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2350" href="#t2350">2350</a></span><span class="t">                        <span class="key">break</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2351" href="#t2351">2351</a></span><span class="t">                    <span class="nam">text</span> <span class="op">=</span> <span class="nam">slugify</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2352" href="#t2352">2352</a></span><span class="t">                        <span class="nam">reading_texts_by_indices</span><span class="op">[</span><span class="nam">indices</span><span class="op">]</span><span class="op">,</span> <span class="nam">lowercase</span><span class="op">=</span><span class="key">False</span><span class="op">,</span> <span class="nam">allow_unicode</span><span class="op">=</span><span class="key">True</span><span class="op">,</span> <span class="nam">separator</span><span class="op">=</span><span class="str">'.'</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2353" href="#t2353">2353</a></span><span class="t">                    <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2354" href="#t2354">2354</a></span><span class="t">                    <span class="com"># Denote omissions by en-dashes:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2355" href="#t2355">2355</a></span><span class="t">                    <span class="key">if</span> <span class="nam">text</span> <span class="op">==</span> <span class="str">""</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2356" href="#t2356">2356</a></span><span class="t">                        <span class="nam">text</span> <span class="op">=</span> <span class="str">"\u2013"</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2357" href="#t2357">2357</a></span><span class="t">                    <span class="com"># The first reading should not be preceded by anything:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2358" href="#t2358">2358</a></span><span class="t">                    <span class="key">if</span> <span class="nam">k</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2359" href="#t2359">2359</a></span><span class="t">                        <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="nam">text</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2360" href="#t2360">2360</a></span><span class="t">                        <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">" |"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2361" href="#t2361">2361</a></span><span class="t">                    <span class="com"># Every subsequent reading should be preceded by a space:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2362" href="#t2362">2362</a></span><span class="t">                    <span class="key">elif</span> <span class="nam">k</span> <span class="op">></span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2363" href="#t2363">2363</a></span><span class="t">                        <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">" %s"</span> <span class="op">%</span> <span class="nam">text</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2364" href="#t2364">2364</a></span><span class="t">                    <span class="nam">k</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2365" href="#t2365">2365</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">" ]\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2366" href="#t2366">2366</a></span><span class="t">                <span class="com"># In a second pass, print the indices and witnesses for all readings enclosed in angle brackets:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2367" href="#t2367">2367</a></span><span class="t">                <span class="nam">k</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2368" href="#t2368">2368</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\t&lt; "</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2369" href="#t2369">2369</a></span><span class="t">                <span class="key">while</span> <span class="key">True</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2370" href="#t2370">2370</a></span><span class="t">                    <span class="nam">indices</span> <span class="op">=</span> <span class="nam">tuple</span><span class="op">(</span><span class="op">[</span><span class="nam">j</span><span class="op">,</span> <span class="nam">k</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2371" href="#t2371">2371</a></span><span class="t">                    <span class="key">if</span> <span class="nam">indices</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">reading_wits_by_indices</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2372" href="#t2372">2372</a></span><span class="t">                        <span class="key">break</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2373" href="#t2373">2373</a></span><span class="t">                    <span class="nam">rdg_symbol</span> <span class="op">=</span> <span class="nam">symbols</span><span class="op">[</span><span class="nam">k</span><span class="op">]</span>  <span class="com"># get the one-character alphanumeric code for this state</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2374" href="#t2374">2374</a></span><span class="t">                    <span class="nam">wits</span> <span class="op">=</span> <span class="str">" "</span><span class="op">.</span><span class="nam">join</span><span class="op">(</span><span class="nam">reading_wits_by_indices</span><span class="op">[</span><span class="nam">indices</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2375" href="#t2375">2375</a></span><span class="t">                    <span class="com"># Open the variant reading support block with an angle bracket:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2376" href="#t2376">2376</a></span><span class="t">                    <span class="key">if</span> <span class="nam">k</span> <span class="op">==</span> <span class="num">0</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2377" href="#t2377">2377</a></span><span class="t">                        <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"%s %s"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">rdg_symbol</span><span class="op">,</span> <span class="nam">wits</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2378" href="#t2378">2378</a></span><span class="t">                    <span class="com"># Open all subsequent variant reading support blocks with pipes on the next line:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2379" href="#t2379">2379</a></span><span class="t">                    <span class="key">else</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2380" href="#t2380">2380</a></span><span class="t">                        <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\n\t| %s %s"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">rdg_symbol</span><span class="op">,</span> <span class="nam">wits</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2381" href="#t2381">2381</a></span><span class="t">                    <span class="nam">k</span> <span class="op">+=</span> <span class="num">1</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2382" href="#t2382">2382</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">" >\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2383" href="#t2383">2383</a></span><span class="t">        <span class="com"># In a fourth pass, write to the chron file:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2384" href="#t2384">2384</a></span><span class="t">        <span class="nam">max_id_length</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2385" href="#t2385">2385</a></span><span class="t">            <span class="op">[</span><span class="nam">len</span><span class="op">(</span><span class="nam">slugify</span><span class="op">(</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">lowercase</span><span class="op">=</span><span class="key">False</span><span class="op">,</span> <span class="nam">allow_unicode</span><span class="op">=</span><span class="key">True</span><span class="op">,</span> <span class="nam">separator</span><span class="op">=</span><span class="str">'_'</span><span class="op">)</span><span class="op">)</span> <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">]</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2386" href="#t2386">2386</a></span><span class="t">        <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2387" href="#t2387">2387</a></span><span class="t">        <span class="nam">max_date_length</span> <span class="op">=</span> <span class="num">0</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2388" href="#t2388">2388</a></span><span class="t">        <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2389" href="#t2389">2389</a></span><span class="t">            <span class="key">if</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2390" href="#t2390">2390</a></span><span class="t">                <span class="nam">max_date_length</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span><span class="nam">max_date_length</span><span class="op">,</span> <span class="nam">len</span><span class="op">(</span><span class="nam">str</span><span class="op">(</span><span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2391" href="#t2391">2391</a></span><span class="t">            <span class="key">if</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2392" href="#t2392">2392</a></span><span class="t">                <span class="nam">max_date_length</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span><span class="nam">max_date_length</span><span class="op">,</span> <span class="nam">len</span><span class="op">(</span><span class="nam">str</span><span class="op">(</span><span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2393" href="#t2393">2393</a></span><span class="t">        <span class="com"># Attempt to get the minimum and maximum dates for witnesses; if we can't do this, then don't write a chron file:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2394" href="#t2394">2394</a></span><span class="t">        <span class="nam">min_date</span> <span class="op">=</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2395" href="#t2395">2395</a></span><span class="t">        <span class="nam">max_date</span> <span class="op">=</span> <span class="key">None</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2396" href="#t2396">2396</a></span><span class="t">        <span class="key">try</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2397" href="#t2397">2397</a></span><span class="t">            <span class="nam">min_date</span> <span class="op">=</span> <span class="nam">min</span><span class="op">(</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span> <span class="key">if</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2398" href="#t2398">2398</a></span><span class="t">            <span class="nam">max_date</span> <span class="op">=</span> <span class="nam">max</span><span class="op">(</span><span class="op">[</span><span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span> <span class="key">if</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span> <span class="key">is</span> <span class="key">not</span> <span class="key">None</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2399" href="#t2399">2399</a></span><span class="t">        <span class="key">except</span> <span class="nam">Exception</span> <span class="key">as</span> <span class="nam">e</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2400" href="#t2400">2400</a></span><span class="t">            <span class="nam">print</span><span class="op">(</span><span class="str">"WARNING: no witnesses have date ranges; no chron file will be written!"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2401" href="#t2401">2401</a></span><span class="t">            <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2402" href="#t2402">2402</a></span><span class="t">        <span class="key">with</span> <span class="nam">open</span><span class="op">(</span><span class="nam">chron_file_addr</span><span class="op">,</span> <span class="str">"w"</span><span class="op">,</span> <span class="nam">encoding</span><span class="op">=</span><span class="str">"utf-8"</span><span class="op">)</span> <span class="key">as</span> <span class="nam">f</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2403" href="#t2403">2403</a></span><span class="t">            <span class="key">for</span> <span class="nam">wit</span> <span class="key">in</span> <span class="nam">self</span><span class="op">.</span><span class="nam">witnesses</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2404" href="#t2404">2404</a></span><span class="t">                <span class="nam">wit_label</span> <span class="op">=</span> <span class="nam">slugify</span><span class="op">(</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">,</span> <span class="nam">lowercase</span><span class="op">=</span><span class="key">False</span><span class="op">,</span> <span class="nam">allow_unicode</span><span class="op">=</span><span class="key">True</span><span class="op">,</span> <span class="nam">separator</span><span class="op">=</span><span class="str">'_'</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2405" href="#t2405">2405</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="nam">wit_label</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2406" href="#t2406">2406</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">" "</span> <span class="op">*</span> <span class="op">(</span><span class="nam">max_id_length</span> <span class="op">-</span> <span class="nam">len</span><span class="op">(</span><span class="nam">wit</span><span class="op">.</span><span class="nam">id</span><span class="op">)</span> <span class="op">+</span> <span class="num">1</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2407" href="#t2407">2407</a></span><span class="t">                <span class="com"># If either the lower bound on this witness's date is empty, then use the min and max dates over all witnesses as defaults:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2408" href="#t2408">2408</a></span><span class="t">                <span class="nam">date_range</span> <span class="op">=</span> <span class="nam">wit</span><span class="op">.</span><span class="nam">date_range</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2409" href="#t2409">2409</a></span><span class="t">                <span class="key">if</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="key">is</span> <span class="key">None</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2410" href="#t2410">2410</a></span><span class="t">                    <span class="nam">date_range</span> <span class="op">=</span> <span class="nam">tuple</span><span class="op">(</span><span class="op">[</span><span class="nam">min_date</span><span class="op">,</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2411" href="#t2411">2411</a></span><span class="t">                <span class="com"># Then write the date range minimum, average, and maximum to the chron file:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2412" href="#t2412">2412</a></span><span class="t">                <span class="nam">low_date</span> <span class="op">=</span> <span class="nam">str</span><span class="op">(</span><span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2413" href="#t2413">2413</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">" "</span> <span class="op">*</span> <span class="op">(</span><span class="nam">max_date_length</span> <span class="op">-</span> <span class="nam">len</span><span class="op">(</span><span class="nam">low_date</span><span class="op">)</span> <span class="op">+</span> <span class="num">2</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2414" href="#t2414">2414</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="nam">low_date</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2415" href="#t2415">2415</a></span><span class="t">                <span class="nam">avg_date</span> <span class="op">=</span> <span class="nam">str</span><span class="op">(</span><span class="nam">int</span><span class="op">(</span><span class="op">(</span><span class="op">(</span><span class="nam">date_range</span><span class="op">[</span><span class="num">0</span><span class="op">]</span> <span class="op">+</span> <span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="num">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2416" href="#t2416">2416</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">" "</span> <span class="op">*</span> <span class="op">(</span><span class="nam">max_date_length</span> <span class="op">-</span> <span class="nam">len</span><span class="op">(</span><span class="nam">str</span><span class="op">(</span><span class="nam">avg_date</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="num">2</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2417" href="#t2417">2417</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="nam">avg_date</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2418" href="#t2418">2418</a></span><span class="t">                <span class="nam">high_date</span> <span class="op">=</span> <span class="nam">str</span><span class="op">(</span><span class="nam">date_range</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2419" href="#t2419">2419</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">" "</span> <span class="op">*</span> <span class="op">(</span><span class="nam">max_date_length</span> <span class="op">-</span> <span class="nam">len</span><span class="op">(</span><span class="nam">high_date</span><span class="op">)</span> <span class="op">+</span> <span class="num">2</span><span class="op">)</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2420" href="#t2420">2420</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="nam">high_date</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2421" href="#t2421">2421</a></span><span class="t">                <span class="nam">f</span><span class="op">.</span><span class="nam">write</span><span class="op">(</span><span class="str">"\n"</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2422" href="#t2422">2422</a></span><span class="t">        <span class="key">return</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2423" href="#t2423">2423</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2424" href="#t2424">2424</a></span><span class="t">    <span class="key">def</span> <span class="nam">to_file</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2425" href="#t2425">2425</a></span><span class="t">        <span class="nam">self</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2426" href="#t2426">2426</a></span><span class="t">        <span class="nam">file_addr</span><span class="op">:</span> <span class="nam">Union</span><span class="op">[</span><span class="nam">Path</span><span class="op">,</span> <span class="nam">str</span><span class="op">]</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2427" href="#t2427">2427</a></span><span class="t">        <span class="nam">format</span><span class="op">:</span> <span class="nam">Format</span> <span class="op">=</span> <span class="key">None</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2428" href="#t2428">2428</a></span><span class="t">        <span class="nam">drop_constant</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2429" href="#t2429">2429</a></span><span class="t">        <span class="nam">split_missing</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">True</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2430" href="#t2430">2430</a></span><span class="t">        <span class="nam">char_state_labels</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">True</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2431" href="#t2431">2431</a></span><span class="t">        <span class="nam">frequency</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2432" href="#t2432">2432</a></span><span class="t">        <span class="nam">ambiguous_as_missing</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2433" href="#t2433">2433</a></span><span class="t">        <span class="nam">proportion</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2434" href="#t2434">2434</a></span><span class="t">        <span class="nam">calibrate_dates</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2435" href="#t2435">2435</a></span><span class="t">        <span class="nam">mrbayes</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2436" href="#t2436">2436</a></span><span class="t">        <span class="nam">clock_model</span><span class="op">:</span> <span class="nam">ClockModel</span> <span class="op">=</span> <span class="nam">ClockModel</span><span class="op">.</span><span class="nam">strict</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2437" href="#t2437">2437</a></span><span class="t">        <span class="nam">ancestral_logger</span><span class="op">:</span> <span class="nam">AncestralLogger</span> <span class="op">=</span> <span class="nam">AncestralLogger</span><span class="op">.</span><span class="nam">state</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2438" href="#t2438">2438</a></span><span class="t">        <span class="nam">table_type</span><span class="op">:</span> <span class="nam">TableType</span> <span class="op">=</span> <span class="nam">TableType</span><span class="op">.</span><span class="nam">matrix</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2439" href="#t2439">2439</a></span><span class="t">        <span class="nam">show_ext</span><span class="op">:</span> <span class="nam">bool</span> <span class="op">=</span> <span class="key">False</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2440" href="#t2440">2440</a></span><span class="t">        <span class="nam">seed</span><span class="op">:</span> <span class="nam">int</span> <span class="op">=</span> <span class="key">None</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2441" href="#t2441">2441</a></span><span class="t">    <span class="op">)</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2442" href="#t2442">2442</a></span><span class="t">        <span class="str">"""Writes this Collation to the file with the given address.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2443" href="#t2443">2443</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2444" href="#t2444">2444</a></span><span class="t"><span class="str">        Args:</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2445" href="#t2445">2445</a></span><span class="t"><span class="str">            file_addr (Union[Path, str]): The path to the output file.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2446" href="#t2446">2446</a></span><span class="t"><span class="str">            format (Format, optional): The desired output format.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2447" href="#t2447">2447</a></span><span class="t"><span class="str">                If None then it is infered from the file suffix.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2448" href="#t2448">2448</a></span><span class="t"><span class="str">                Defaults to None.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2449" href="#t2449">2449</a></span><span class="t"><span class="str">            drop_constant (bool, optional): An optional flag indicating whether to ignore variation units with one substantive reading.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2450" href="#t2450">2450</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2451" href="#t2451">2451</a></span><span class="t"><span class="str">            split_missing (bool, optional): An optional flag indicating whether to treat</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2452" href="#t2452">2452</a></span><span class="t"><span class="str">                missing characters/variation units as having a contribution of 1 split over all states/readings;</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2453" href="#t2453">2453</a></span><span class="t"><span class="str">                if False, then missing data is ignored (i.e., all states are 0).</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2454" href="#t2454">2454</a></span><span class="t"><span class="str">                Not applicable for NEXUS, HENNIG86, PHYLIP, FASTA, or STEMMA format.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2455" href="#t2455">2455</a></span><span class="t"><span class="str">                Default value is True.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2456" href="#t2456">2456</a></span><span class="t"><span class="str">            char_state_labels (bool, optional): An optional flag indicating whether to print</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2457" href="#t2457">2457</a></span><span class="t"><span class="str">                the CharStateLabels block in NEXUS output.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2458" href="#t2458">2458</a></span><span class="t"><span class="str">                Default value is True.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2459" href="#t2459">2459</a></span><span class="t"><span class="str">            frequency (bool, optional): An optional flag indicating whether to use the StatesFormat=Frequency setting</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2460" href="#t2460">2460</a></span><span class="t"><span class="str">                instead of the StatesFormat=StatesPresent setting</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2461" href="#t2461">2461</a></span><span class="t"><span class="str">                (and thus represent all states with frequency vectors rather than symbols)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2462" href="#t2462">2462</a></span><span class="t"><span class="str">                in NEXUS output.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2463" href="#t2463">2463</a></span><span class="t"><span class="str">                Note that this setting is necessary to make use of certainty degrees assigned to multiple ambiguous states in the collation.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2464" href="#t2464">2464</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2465" href="#t2465">2465</a></span><span class="t"><span class="str">            ambiguous_as_missing (bool, optional): An optional flag indicating whether to treat all ambiguous states as missing data.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2466" href="#t2466">2466</a></span><span class="t"><span class="str">                If this flag is set, then only base symbols will be generated for the NEXUS file.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2467" href="#t2467">2467</a></span><span class="t"><span class="str">                It is only applied if the frequency option is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2468" href="#t2468">2468</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2469" href="#t2469">2469</a></span><span class="t"><span class="str">            proportion (bool, optional): An optional flag indicating whether to populate a distance matrix's cells</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2470" href="#t2470">2470</a></span><span class="t"><span class="str">                with a proportion of disagreements to variation units where both witnesses are extant.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2471" href="#t2471">2471</a></span><span class="t"><span class="str">                It is only applied if the table_type option is "distance".</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2472" href="#t2472">2472</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2473" href="#t2473">2473</a></span><span class="t"><span class="str">            calibrate_dates (bool, optional): An optional flag indicating whether to add an Assumptions block that specifies date distributions for witnesses</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2474" href="#t2474">2474</a></span><span class="t"><span class="str">                in NEXUS output.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2475" href="#t2475">2475</a></span><span class="t"><span class="str">                This option is intended for inputs to BEAST 2.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2476" href="#t2476">2476</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2477" href="#t2477">2477</a></span><span class="t"><span class="str">            mrbayes (bool, optional): An optional flag indicating whether to add a MrBayes block that specifies model settings and age calibrations for witnesses</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2478" href="#t2478">2478</a></span><span class="t"><span class="str">                in NEXUS output.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2479" href="#t2479">2479</a></span><span class="t"><span class="str">                This option is intended for inputs to MrBayes.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2480" href="#t2480">2480</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2481" href="#t2481">2481</a></span><span class="t"><span class="str">            clock_model (ClockModel, optional): A ClockModel option indicating which type of clock model to use.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2482" href="#t2482">2482</a></span><span class="t"><span class="str">                This option is intended for inputs to MrBayes and BEAST 2.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2483" href="#t2483">2483</a></span><span class="t"><span class="str">                MrBayes does not presently support a local clock model, so it will default to a strict clock model if a local clock model is specified.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2484" href="#t2484">2484</a></span><span class="t"><span class="str">                Default value is "strict".</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2485" href="#t2485">2485</a></span><span class="t"><span class="str">            ancestral_logger (AncestralLogger, optional): An AncestralLogger option indicating which class of logger (if any) to use for ancestral states.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2486" href="#t2486">2486</a></span><span class="t"><span class="str">                This option is intended for inputs to BEAST 2.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2487" href="#t2487">2487</a></span><span class="t"><span class="str">            table_type (TableType, optional): A TableType option indicating which type of tabular output to generate.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2488" href="#t2488">2488</a></span><span class="t"><span class="str">                Only applicable for tabular outputs and PHYLIP outputs.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2489" href="#t2489">2489</a></span><span class="t"><span class="str">                If the output is a PHYLIP file, then the type of tabular output must be "distance" or "similarity"; otherwise, it will be ignored.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2490" href="#t2490">2490</a></span><span class="t"><span class="str">                Default value is "matrix".</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2491" href="#t2491">2491</a></span><span class="t"><span class="str">            show_ext (bool, optional): An optional flag indicating whether each cell in a distance or similarity matrix</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2492" href="#t2492">2492</a></span><span class="t"><span class="str">                should include the number of variation units where both witnesses are extant after the number of their disagreements/agreements.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2493" href="#t2493">2493</a></span><span class="t"><span class="str">                Only applicable for tabular output formats of type "distance" or "similarity".</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2494" href="#t2494">2494</a></span><span class="t"><span class="str">                Default value is False.</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2495" href="#t2495">2495</a></span><span class="t"><span class="str">            seed (optional, int): A seed for random number generation (for setting initial values of unspecified transcriptional rates in BEAST 2 XML output).</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2496" href="#t2496">2496</a></span><span class="t"><span class="str">        """</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2497" href="#t2497">2497</a></span><span class="t">        <span class="nam">file_addr</span> <span class="op">=</span> <span class="nam">Path</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2498" href="#t2498">2498</a></span><span class="t">        <span class="nam">format</span> <span class="op">=</span> <span class="nam">format</span> <span class="key">or</span> <span class="nam">Format</span><span class="op">.</span><span class="nam">infer</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2499" href="#t2499">2499</a></span><span class="t">            <span class="nam">file_addr</span><span class="op">.</span><span class="nam">suffix</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2500" href="#t2500">2500</a></span><span class="t">        <span class="op">)</span>  <span class="com"># an exception will be raised here if the format or suffix is invalid</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2501" href="#t2501">2501</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2502" href="#t2502">2502</a></span><span class="t">        <span class="key">if</span> <span class="nam">format</span> <span class="op">==</span> <span class="nam">Format</span><span class="op">.</span><span class="nam">NEXUS</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2503" href="#t2503">2503</a></span><span class="t">            <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">to_nexus</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2504" href="#t2504">2504</a></span><span class="t">                <span class="nam">file_addr</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2505" href="#t2505">2505</a></span><span class="t">                <span class="nam">drop_constant</span><span class="op">=</span><span class="nam">drop_constant</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2506" href="#t2506">2506</a></span><span class="t">                <span class="nam">char_state_labels</span><span class="op">=</span><span class="nam">char_state_labels</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2507" href="#t2507">2507</a></span><span class="t">                <span class="nam">frequency</span><span class="op">=</span><span class="nam">frequency</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2508" href="#t2508">2508</a></span><span class="t">                <span class="nam">ambiguous_as_missing</span><span class="op">=</span><span class="nam">ambiguous_as_missing</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2509" href="#t2509">2509</a></span><span class="t">                <span class="nam">calibrate_dates</span><span class="op">=</span><span class="nam">calibrate_dates</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2510" href="#t2510">2510</a></span><span class="t">                <span class="nam">mrbayes</span><span class="op">=</span><span class="nam">mrbayes</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2511" href="#t2511">2511</a></span><span class="t">                <span class="nam">clock_model</span><span class="op">=</span><span class="nam">clock_model</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2512" href="#t2512">2512</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2513" href="#t2513">2513</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2514" href="#t2514">2514</a></span><span class="t">        <span class="key">if</span> <span class="nam">format</span> <span class="op">==</span> <span class="nam">format</span><span class="op">.</span><span class="nam">HENNIG86</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2515" href="#t2515">2515</a></span><span class="t">            <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">to_hennig86</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">,</span> <span class="nam">drop_constant</span><span class="op">=</span><span class="nam">drop_constant</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2516" href="#t2516">2516</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2517" href="#t2517">2517</a></span><span class="t">        <span class="key">if</span> <span class="nam">format</span> <span class="op">==</span> <span class="nam">format</span><span class="op">.</span><span class="nam">PHYLIP</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2518" href="#t2518">2518</a></span><span class="t">            <span class="key">if</span> <span class="nam">table_type</span> <span class="key">in</span> <span class="op">[</span><span class="nam">TableType</span><span class="op">.</span><span class="nam">distance</span><span class="op">,</span> <span class="nam">TableType</span><span class="op">.</span><span class="nam">similarity</span><span class="op">]</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2519" href="#t2519">2519</a></span><span class="t">                <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">to_phylip_matrix</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2520" href="#t2520">2520</a></span><span class="t">                    <span class="nam">file_addr</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2521" href="#t2521">2521</a></span><span class="t">                    <span class="nam">drop_constant</span><span class="op">=</span><span class="nam">drop_constant</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2522" href="#t2522">2522</a></span><span class="t">                    <span class="nam">proportion</span><span class="op">=</span><span class="nam">proportion</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2523" href="#t2523">2523</a></span><span class="t">                    <span class="nam">table_type</span><span class="op">=</span><span class="nam">table_type</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2524" href="#t2524">2524</a></span><span class="t">                    <span class="nam">show_ext</span><span class="op">=</span><span class="nam">show_ext</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2525" href="#t2525">2525</a></span><span class="t">                <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2526" href="#t2526">2526</a></span><span class="t">            <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">to_phylip</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">,</span> <span class="nam">drop_constant</span><span class="op">=</span><span class="nam">drop_constant</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2527" href="#t2527">2527</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2528" href="#t2528">2528</a></span><span class="t">        <span class="key">if</span> <span class="nam">format</span> <span class="op">==</span> <span class="nam">format</span><span class="op">.</span><span class="nam">FASTA</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2529" href="#t2529">2529</a></span><span class="t">            <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">to_fasta</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">,</span> <span class="nam">drop_constant</span><span class="op">=</span><span class="nam">drop_constant</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2530" href="#t2530">2530</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2531" href="#t2531">2531</a></span><span class="t">        <span class="key">if</span> <span class="nam">format</span> <span class="op">==</span> <span class="nam">format</span><span class="op">.</span><span class="nam">BEAST</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2532" href="#t2532">2532</a></span><span class="t">            <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">to_beast</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2533" href="#t2533">2533</a></span><span class="t">                <span class="nam">file_addr</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2534" href="#t2534">2534</a></span><span class="t">                <span class="nam">drop_constant</span><span class="op">=</span><span class="nam">drop_constant</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2535" href="#t2535">2535</a></span><span class="t">                <span class="nam">clock_model</span><span class="op">=</span><span class="nam">clock_model</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2536" href="#t2536">2536</a></span><span class="t">                <span class="nam">ancestral_logger</span><span class="op">=</span><span class="nam">ancestral_logger</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2537" href="#t2537">2537</a></span><span class="t">                <span class="nam">seed</span><span class="op">=</span><span class="nam">seed</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2538" href="#t2538">2538</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2539" href="#t2539">2539</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2540" href="#t2540">2540</a></span><span class="t">        <span class="key">if</span> <span class="nam">format</span> <span class="op">==</span> <span class="nam">Format</span><span class="op">.</span><span class="nam">CSV</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2541" href="#t2541">2541</a></span><span class="t">            <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">to_csv</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2542" href="#t2542">2542</a></span><span class="t">                <span class="nam">file_addr</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2543" href="#t2543">2543</a></span><span class="t">                <span class="nam">drop_constant</span><span class="op">=</span><span class="nam">drop_constant</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2544" href="#t2544">2544</a></span><span class="t">                <span class="nam">ambiguous_as_missing</span><span class="op">=</span><span class="nam">ambiguous_as_missing</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2545" href="#t2545">2545</a></span><span class="t">                <span class="nam">proportion</span><span class="op">=</span><span class="nam">proportion</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2546" href="#t2546">2546</a></span><span class="t">                <span class="nam">table_type</span><span class="op">=</span><span class="nam">table_type</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2547" href="#t2547">2547</a></span><span class="t">                <span class="nam">split_missing</span><span class="op">=</span><span class="nam">split_missing</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2548" href="#t2548">2548</a></span><span class="t">                <span class="nam">show_ext</span><span class="op">=</span><span class="nam">show_ext</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2549" href="#t2549">2549</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2550" href="#t2550">2550</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2551" href="#t2551">2551</a></span><span class="t">        <span class="key">if</span> <span class="nam">format</span> <span class="op">==</span> <span class="nam">Format</span><span class="op">.</span><span class="nam">TSV</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2552" href="#t2552">2552</a></span><span class="t">            <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">to_csv</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2553" href="#t2553">2553</a></span><span class="t">                <span class="nam">file_addr</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2554" href="#t2554">2554</a></span><span class="t">                <span class="nam">drop_constant</span><span class="op">=</span><span class="nam">drop_constant</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2555" href="#t2555">2555</a></span><span class="t">                <span class="nam">ambiguous_as_missing</span><span class="op">=</span><span class="nam">ambiguous_as_missing</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2556" href="#t2556">2556</a></span><span class="t">                <span class="nam">proportion</span><span class="op">=</span><span class="nam">proportion</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2557" href="#t2557">2557</a></span><span class="t">                <span class="nam">table_type</span><span class="op">=</span><span class="nam">table_type</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2558" href="#t2558">2558</a></span><span class="t">                <span class="nam">split_missing</span><span class="op">=</span><span class="nam">split_missing</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2559" href="#t2559">2559</a></span><span class="t">                <span class="nam">show_ext</span><span class="op">=</span><span class="nam">show_ext</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2560" href="#t2560">2560</a></span><span class="t">                <span class="nam">sep</span><span class="op">=</span><span class="str">"\t"</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2561" href="#t2561">2561</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2562" href="#t2562">2562</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2563" href="#t2563">2563</a></span><span class="t">        <span class="key">if</span> <span class="nam">format</span> <span class="op">==</span> <span class="nam">Format</span><span class="op">.</span><span class="nam">EXCEL</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2564" href="#t2564">2564</a></span><span class="t">            <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">to_excel</span><span class="op">(</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2565" href="#t2565">2565</a></span><span class="t">                <span class="nam">file_addr</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2566" href="#t2566">2566</a></span><span class="t">                <span class="nam">drop_constant</span><span class="op">=</span><span class="nam">drop_constant</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2567" href="#t2567">2567</a></span><span class="t">                <span class="nam">ambiguous_as_missing</span><span class="op">=</span><span class="nam">ambiguous_as_missing</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2568" href="#t2568">2568</a></span><span class="t">                <span class="nam">proportion</span><span class="op">=</span><span class="nam">proportion</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2569" href="#t2569">2569</a></span><span class="t">                <span class="nam">table_type</span><span class="op">=</span><span class="nam">table_type</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2570" href="#t2570">2570</a></span><span class="t">                <span class="nam">split_missing</span><span class="op">=</span><span class="nam">split_missing</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2571" href="#t2571">2571</a></span><span class="t">                <span class="nam">show_ext</span><span class="op">=</span><span class="nam">show_ext</span><span class="op">,</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2572" href="#t2572">2572</a></span><span class="t">            <span class="op">)</span>&nbsp;</span><span class="r"></span></p>
    <p class="pln"><span class="n"><a id="t2573" href="#t2573">2573</a></span><span class="t">&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2574" href="#t2574">2574</a></span><span class="t">        <span class="key">if</span> <span class="nam">format</span> <span class="op">==</span> <span class="nam">Format</span><span class="op">.</span><span class="nam">STEMMA</span><span class="op">:</span>&nbsp;</span><span class="r"></span></p>
    <p class="run"><span class="n"><a id="t2575" href="#t2575">2575</a></span><span class="t">            <span class="key">return</span> <span class="nam">self</span><span class="op">.</span><span class="nam">to_stemma</span><span class="op">(</span><span class="nam">file_addr</span><span class="op">)</span>&nbsp;</span><span class="r"></span></p>
</main>
<footer>
    <div class="content">
        <p>
            <a id="prevFileLink" class="nav" href="d_0203103e395d7d41___init___py.html">&#xab; prev</a> &nbsp; &nbsp;
            <a id="indexLink" class="nav" href="index.html">&Hat; index</a> &nbsp; &nbsp;
            <a id="nextFileLink" class="nav" href="d_0203103e395d7d41_common_py.html">&#xbb; next</a>
            &nbsp; &nbsp; &nbsp;
            <a class="nav" href="https://coverage.readthedocs.io">coverage.py v6.5.0</a>,
            created at 2025-02-04 15:23 +0000
        </p>
    </div>
</footer>
</body>
</html>
